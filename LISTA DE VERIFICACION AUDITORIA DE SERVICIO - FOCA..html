<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Lista de Verificación de Auditoría - FOCA v3.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  * { box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    color: #2c3e50;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }
  .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
  .card { background: #fff; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); overflow: hidden; margin-bottom: 20px; }
  .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 24px; position: relative; overflow: hidden; }
  .header::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: pulse 8s ease-in-out infinite; }
  @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
  .header-content { position: relative; z-index: 1; }
  .logo-section { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
  .logo { width: 70px; height: 70px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); overflow: hidden; padding: 8px; }
  .logo img { width: 100%; height: 100%; object-fit: contain; }
  .org-name { flex: 1; font-size: 18px; font-weight: 600; line-height: 1.3; }
  .title-section { text-align: center; margin-bottom: 20px; }
  .main-title { font-size: 22px; font-weight: 700; margin: 0 0 8px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .subtitle { font-size: 13px; opacity: 0.9; margin: 0; }
  .header-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 20px; }
  .header-item { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 10px; padding: 12px; border: 1px solid rgba(255,255,255,0.2); }
  .header-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; opacity: 0.9; }
  .header-value { font-size: 15px; font-weight: 700; color: #fff; }
  .meta-section { padding: 24px; background: #f8f9fa; }
  .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .meta-field { position: relative; }
  .meta-field label { display: block; font-size: 12px; font-weight: 600; color: #1e3c72; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  .meta-field input, .meta-field select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; background: white; }
  .meta-field input:focus, .meta-field select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
  .table-container { padding: 24px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
  thead { position: sticky; top: 0; z-index: 10; }
  th { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 14px 10px; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap; }
  th:first-child { border-top-left-radius: 10px; text-align: left; }
  th:last-child { border-top-right-radius: 10px; }
  td { padding: 12px 10px; border-bottom: 1px solid #e0e0e0; background: white; }
  tr:hover td { background: #f8f9fa; }
  .section-title { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%) !important; color: white !important; font-weight: 700; font-size: 14px; padding: 14px !important; text-transform: uppercase; letter-spacing: 0.5px; }
  .result-row td { background: #e8f5e9 !important; font-weight: 700; color: #2e7d32; font-size: 15px; }
  .radio-cell { text-align: center; }
  .radio-cell input[type="radio"] { width: 20px; height: 20px; cursor: pointer; accent-color: #667eea; }
  .obs-input { width: 100%; border: 1px solid #e0e0e0; border-radius: 6px; padding: 8px; font-size: 13px; transition: border-color 0.3s ease; }
  .obs-input:focus { outline: none; border-color: #667eea; }

  /* ===== EVIDENCE BUTTON ===== */
  .evidence-cell { text-align: center; vertical-align: middle; padding: 8px 4px; }
  .evidence-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 6px 0; width: 72px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102,126,234,0.2); position: relative; }
  .evidence-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
  .evidence-btn i { font-size: 14px; }
  .evidence-btn.has-evidence { background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); box-shadow: 0 2px 8px rgba(76,175,80,0.2); }
  .om-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 6px 0; width: 58px; background: linear-gradient(135deg, #7c8ff0 0%, #9c6fd6 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(124,143,240,0.2); position: relative; }
  .om-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(124,143,240,0.3); }
  .om-btn.has-om { background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); box-shadow: 0 2px 8px rgba(76,175,80,0.2); }
  .om-btn i { font-size: 14px; }
  /* OM inline modal */
  .om-inline-modal { display:none; position:fixed; z-index:1500; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); animation:fadeIn 0.2s ease; }
  .om-inline-content { position:relative; background:#fff; margin:8% auto; border-radius:12px; width:90%; max-width:480px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3); animation:slideIn 0.3s ease; }
  .om-inline-header { background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%); color:white; padding:16px 20px; }
  .om-inline-header h3 { margin:0 0 2px; font-size:15px; font-weight:700; }
  .om-inline-header p { margin:0; font-size:11px; opacity:0.9; }
  .om-inline-body { padding:18px 20px; }
  .evidence-count { position: absolute; top: -8px; right: -8px; background: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  /* ===== EVIDENCE MODAL ===== */
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.75); animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .modal-content { position: relative; background-color: #fff; margin: 3% auto; padding: 0; border-radius: 14px; width: 90%; max-width: 820px; max-height: 90vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
  @keyframes slideIn { from { transform: translateY(-40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 18px 24px; display: flex; align-items: center; justify-content: space-between; }
  .modal-header h2 { margin: 0; font-size: 17px; font-weight: 700; }
  .close { color: white; font-size: 30px; font-weight: 300; cursor: pointer; transition: color 0.3s; line-height: 1; }
  .close:hover { color: #f44336; }
  .modal-body { padding: 24px; max-height: calc(90vh - 75px); overflow-y: auto; }

  /* Upload options: camera + gallery */
  .upload-options { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .upload-option-btn { flex: 1; min-width: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 20px 14px; border: 2px dashed #667eea; border-radius: 12px; background: #f8f9fa; cursor: pointer; transition: all 0.3s ease; font-size: 13px; font-weight: 600; color: #1e3c72; text-align: center; }
  .upload-option-btn:hover { background: #eff3ff; border-color: #2a5298; transform: translateY(-2px); }
  .upload-option-btn i { font-size: 30px; color: #667eea; }
  .upload-option-btn input[type="file"] { display: none; }

  /* Evidence items with title field */
  .evidence-preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 16px; margin-top: 4px; }
  .evidence-item { position: relative; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 12px rgba(0,0,0,0.12); background: white; border: 1px solid #e8e8e8; }
  .evidence-item img { width: 100%; height: 170px; object-fit: cover; display: block; }
  .evidence-title-bar { padding: 8px 10px 10px; background: white; }
  .evidence-title-input { width: 100%; border: 1.5px solid #ddd; border-radius: 7px; padding: 7px 9px; font-size: 12px; color: #2c3e50; outline: none; transition: border-color 0.2s; font-family: inherit; }
  .evidence-title-input:focus { border-color: #667eea; }
  .evidence-title-input::placeholder { color: #aaa; }
  .evidence-remove { position: absolute; top: 7px; right: 7px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 13px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.2s; }
  .evidence-remove:hover { background: #c62828; transform: scale(1.1); }

  /* ===== RESULTS ===== */
  .results-section { padding: 24px; background: #f8f9fa; }
  .results-title { font-size: 18px; font-weight: 700; color: #1e3c72; margin: 0 0 20px 0; display: flex; align-items: center; gap: 12px; }
  .badge { display: inline-flex; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
  .weights-table { margin-bottom: 24px; }
  .final-score { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); border-radius: 16px; padding: 32px; text-align: center; color: white; box-shadow: 0 8px 24px rgba(0,0,0,0.2); margin-bottom: 20px; transition: background 0.5s ease; }
  .final-score-label { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; opacity: 0.9; }
  .final-score-value { font-size: 64px; font-weight: 800; margin: 0; text-shadow: 0 4px 12px rgba(0,0,0,0.3); background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .final-score-status { font-size: 18px; font-weight: 600; margin-top: 12px; padding: 10px 24px; background: rgba(255,255,255,0.2); border-radius: 20px; display: inline-block; }
  .legend-box { background: white; border-radius: 12px; padding: 20px; margin-top: 24px; }
  .legend-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
  .legend-item:last-child { border-bottom: none; }
  .legend-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
  .legend-text { font-size: 13px; color: #2c3e50; flex: 1; }
  .legend-text strong { font-weight: 700; color: #1e3c72; }

  /* ===== EXPORT BUTTONS ===== */
  .export-buttons-container { background: white; padding: 20px; border-top: 2px solid #e0e0e0; display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
  .export-btn { display: flex; align-items: center; gap: 10px; padding: 14px 22px; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s ease; min-width: 190px; justify-content: center; }
  .export-btn i { font-size: 18px; }
  .btn-pdf { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; box-shadow: 0 4px 12px rgba(244,67,54,0.2); }
  .btn-pdf:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(244,67,54,0.3); }
  .btn-report { background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; box-shadow: 0 4px 12px rgba(156,39,176,0.2); }
  .btn-report:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(156,39,176,0.3); }
  .btn-reset { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; box-shadow: 0 4px 12px rgba(255,152,0,0.2); }
  .btn-reset:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(255,152,0,0.3); }
  .btn-save { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; box-shadow: 0 4px 12px rgba(33,150,243,0.2); }
  .btn-save:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(33,150,243,0.3); }

  /* ===== CHARTS ===== */
  .charts-section { margin-top: 30px; }
  .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; }
  .chart-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .chart-title { font-size: 16px; font-weight: 700; color: #1e3c72; margin: 0 0 15px 0; text-align: center; }
  .chart-wrapper { position: relative; height: 250px; }

  /* ===== NOTIFICATIONS ===== */
  .notification { position: fixed; bottom: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 3000; display: flex; align-items: center; gap: 10px; transform: translateY(100px); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; max-width: 380px; }
  .notification.show { transform: translateY(0); opacity: 1; }
  .notification-success { background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); }
  .notification-error { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
  .notification-info { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); }

  /* ===== LOADING ===== */
  .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 9999; justify-content: center; align-items: center; }
  .loading-overlay.show { display: flex; }
  .loading-content { text-align: center; color: white; }
  .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading-text { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
  .loading-subtext { font-size: 14px; opacity: 0.8; }

  /* ===== REPORT INFO MODAL ===== */
  .report-modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.75); animation: fadeIn 0.3s ease; }
  .report-modal-content { position: relative; background: #fff; margin: 7% auto; padding: 0; border-radius: 14px; width: 90%; max-width: 520px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.35); animation: slideIn 0.3s ease; }
  .report-modal-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px 24px; }
  .report-modal-header h2 { margin: 0 0 4px; font-size: 18px; font-weight: 700; }
  .report-modal-header p { margin: 0; opacity: 0.85; font-size: 13px; }
  .report-modal-body { padding: 24px; }
  .report-modal-field { margin-bottom: 18px; }
  .report-modal-field label { display: block; font-size: 12px; font-weight: 600; color: #1e3c72; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  .report-modal-field input, .report-modal-field select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; background: white; font-family: inherit; }
  .report-modal-field input:focus, .report-modal-field select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
  .report-modal-actions { display: flex; gap: 12px; margin-top: 20px; }
  .rmbtn { flex: 1; padding: 13px; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.3s; font-family: inherit; }
  .rmbtn-cancel { background: #e0e0e0; color: #555; }
  .rmbtn-cancel:hover { background: #bdbdbd; }
  .rmbtn-generate { background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; box-shadow: 0 4px 12px rgba(156,39,176,0.2); }
  .rmbtn-generate:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(156,39,176,0.3); }

  @media (max-width: 768px) {
    .container { padding: 12px; }
    .header { padding: 20px 16px; }
    .logo { width: 60px; height: 60px; }
    .org-name { font-size: 15px; }
    .main-title { font-size: 18px; }
    .header-grid { grid-template-columns: repeat(2, 1fr); }
    .table-container { padding: 16px; }
    table { font-size: 12px; }
    th, td { padding: 10px 6px; }
    th { font-size: 11px; }
    .final-score { padding: 24px 16px; }
    .final-score-value { font-size: 48px; }
    .export-buttons-container { flex-direction: column; align-items: center; }
    .export-btn { width: 100%; max-width: 300px; }
    .charts-grid { grid-template-columns: 1fr; }
    .upload-options { flex-direction: column; }
    th:last-child, td:last-child { min-width: 150px; }
    .modal-content { width: 96%; margin: 4% auto; }
  }
  @media (max-width: 480px) {
    .header-grid { grid-template-columns: 1fr; }
    .meta-grid { grid-template-columns: 1fr; }
    th, td { padding: 8px 4px; font-size: 11px; }
    .radio-cell input[type="radio"] { width: 18px; height: 18px; }
    .export-btn { min-width: auto; width: 100%; padding: 12px 14px; font-size: 13px; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="card">

    <!-- HEADER -->
    <div class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo"><img src="https://i.imgur.com/3WZzeT6.png" alt="Logo FOCA"></div>
          <div class="org-name">FUNDACIÓN OFTALMOLÓGICA DEL CARIBE</div>
        </div>
        <div class="title-section">
          <h1 class="main-title">LISTA DE VERIFICACIÓN DE AUDITORÍA DE SERVICIO</h1>
          <p class="subtitle">Sistema de Evaluación y Control de Calidad</p>
        </div>
        <div class="header-grid">
          <div class="header-item"><div class="header-label">Código</div><div class="header-value">F-FSYM-823</div></div>
          <div class="header-item"><div class="header-label">Versión</div><div class="header-value">006</div></div>
          <div class="header-item"><div class="header-label">Vigencia</div><div class="header-value">2026-19-01</div></div>
        </div>
      </div>
    </div>

    <!-- META -->
    <div class="meta-section">
      <div class="meta-grid">
        <div class="meta-field">
          <label>Fecha de Auditoría</label>
          <input type="date" id="fecha">
        </div>
        <div class="meta-field">
          <label>Sede</label>
          <select id="sede">
            <option value="">Seleccione la sede</option>
            <option>FOCA VIVA</option><option>FOCA ALKARAWI</option><option>FOCA SEDE 2</option>
            <option>FOCA SEDE 51B</option><option>FOCA ALEGRA</option><option>FOCA VALLEDUPAR</option>
            <option>FOCA RIOHACHA</option><option>FOCA SANTA MARTA</option>
            <option>FOCA SANTA MARTA BURANO</option><option>FOCA CARTAGENA</option>
            <option>FOCA BARANOA</option><option>FOCA GALAPA</option>
            <option>FOCA SABANALARGA 1</option><option>FOCA SABANALARGA 2</option>
            <option>FOCA MALAMBO</option>
          </select>
        </div>
        <div class="meta-field">
          <label>Auditor</label>
          <select id="auditor">
            <option value="">Seleccione el auditor</option>
            <option>Luis Angel Bolaño Castro</option>
            <option>Maria Clara Pizarro</option>
            <option>Daniel Rodriguez Galofre</option>
            <option>Valentina Jimeno</option>
            <option>Jennifer Melendez</option>
          </select>
        </div>
      </div>
    </div>

    <!-- CHECKLIST TABLE -->
    <div class="table-container">
      <table id="checklist">
        <thead>
          <tr>
            <th style="width:33%;">ASPECTOS A EVALUAR</th>
            <th style="width:7%;">C</th>
            <th style="width:7%;">CP</th>
            <th style="width:7%;">NC</th>
            <th style="width:7%;">N/A</th>
            <th style="width:9%;">EVIDENCIA</th>
            <th style="width:9%;">OPT. MEJORA</th>
            <th style="width:21%;">OBSERVACIONES</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- RESULTS -->
    <div class="results-section">
      <h2 class="results-title">META DE SEGURIDAD <span class="badge">Resultados por Criterio</span></h2>
      <table class="weights-table" id="weights">
        <thead>
          <tr>
            <th style="width:30%;">Criterio</th>
            <th style="width:15%;">Ponderación</th>
            <th style="width:15%;">Resultado %</th>
            <th>Estado de Cumplimiento</th>
          </tr>
        </thead>
        <tbody id="weights-body"></tbody>
      </table>
      <div class="final-score">
        <div class="final-score-label">Resultado Final de Auditoría</div>
        <div class="final-score-value" id="total-pct">0%</div>
        <div class="final-score-status" id="final-status">Sin evaluar</div>
        <div class="legend-box">
          <div class="legend-item">
            <div class="legend-dot" style="background:#4caf50;"></div>
            <div class="legend-text"><strong>Mayor o igual a 92%</strong> – Riesgo Bajo. Cumple. Genera seguimiento. No genera plan de acción</div>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background:#ff9800;"></div>
            <div class="legend-text"><strong>Mayor o igual a 85%</strong> – Riesgo Medio. Cumple parcialmente con los criterios evaluados y se requiere plan de acción y seguimiento</div>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background:#f44336;"></div>
            <div class="legend-text"><strong>Menor de 85%</strong> – Riesgo Alto. Se requiere acciones de intervención inmediata y plan de mejoramiento a corto plazo</div>
          </div>
        </div>
      </div>
      <div class="charts-section">
        <h2 class="results-title"><i class="fas fa-chart-bar"></i> Visualización de Resultados</h2>
        <div class="charts-grid">
          <div class="chart-container">
            <h3 class="chart-title">Resultados por Categoría</h3>
            <div class="chart-wrapper"><canvas id="categoryChart"></canvas></div>
          </div>
          <div class="chart-container">
            <h3 class="chart-title">Distribución de Evaluaciones</h3>
            <div class="chart-wrapper"><canvas id="distributionChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- BUTTONS -->
    <div class="export-buttons-container">
      <button class="export-btn btn-report" id="generate-report"><i class="fas fa-file-alt"></i> Generar Informe Completo</button>
      <button class="export-btn btn-pdf" id="export-pdf"><i class="fas fa-file-export"></i> Exportar Lista Verificación</button>
      <button class="export-btn btn-save" id="save-audit"><i class="fas fa-save"></i> Guardar Auditoría</button>
      <button class="export-btn btn-reset" id="reset-form"><i class="fas fa-redo-alt"></i> Restablecer Formulario</button>
    </div>
  </div>
</div>

<!-- ===== EVIDENCE MODAL ===== -->
<div id="evidenceModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title"><i class="fas fa-camera" style="margin-right:8px;"></i>Evidencia Fotográfica</h2>
      <span class="close" onclick="closeEvidenceModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="upload-options">
        <!-- Camera (mobile: opens camera directly) -->
        <label class="upload-option-btn">
          <i class="fas fa-camera"></i>
          <span>Tomar Foto</span>
          <input type="file" accept="image/*" capture="environment" onchange="handleEvidenceUpload(event)">
        </label>
        <!-- Gallery / file picker -->
        <label class="upload-option-btn">
          <i class="fas fa-images"></i>
          <span>Galería / Archivo</span>
          <input type="file" accept="image/*" multiple onchange="handleEvidenceUpload(event)">
        </label>
      </div>
      <div id="evidence-preview" class="evidence-preview"></div>
    </div>
  </div>
</div>

<!-- ===== REPORT INFO MODAL ===== -->
<div id="reportModal" class="report-modal-overlay">
  <div class="report-modal-content">
    <div class="report-modal-header">
      <h2><i class="fas fa-file-alt" style="margin-right:8px;"></i>Datos del Informe</h2>
      <p>Complete la información para generar el informe de auditoría</p>
    </div>
    <div class="report-modal-body">
      <div class="report-modal-field">
        <label>Fecha del Informe</label>
        <input type="date" id="report-fecha">
      </div>
      <div class="report-modal-field">
        <label>Mes de Auditoría</label>
        <select id="report-mes">
          <option value="">Seleccione el mes</option>
          <option>ENERO</option><option>FEBRERO</option><option>MARZO</option>
          <option>ABRIL</option><option>MAYO</option><option>JUNIO</option>
          <option>JULIO</option><option>AGOSTO</option><option>SEPTIEMBRE</option>
          <option>OCTUBRE</option><option>NOVIEMBRE</option><option>DICIEMBRE</option>
        </select>
      </div>
      <div class="report-modal-field">
        <label>Auditor Líder</label>
        <select id="report-auditor-lider">
          <option value="">Seleccione el auditor líder</option>
          <option>Luis Angel Bolaño Castro</option>
          <option>Maria Clara Pizarro</option>
          <option>Daniel Rodriguez Galofre</option>
          <option>Valentina Jimeno</option>
          <option>Jennifer Melendez</option>
        </select>
      </div>
      <div class="report-modal-actions">
        <button class="rmbtn rmbtn-cancel" onclick="closeReportModal()">Cancelar</button>
        <button class="rmbtn rmbtn-generate" onclick="executeGenerateReport()"><i class="fas fa-file-pdf"></i> &nbsp;Generar Informe</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== OPORTUNIDADES DE MEJORA INLINE MODAL ===== -->
<div id="omInlineModal" class="om-inline-modal">
  <div class="om-inline-content">
    <div class="om-inline-header">
      <h3><i class="fas fa-lightbulb" style="margin-right:6px;"></i>Oportunidad de Mejora</h3>
      <p id="om-inline-subtitle">Ítem seleccionado</p>
    </div>
    <div class="om-inline-body">
      <div id="om-inline-lista" style="margin-bottom:10px;max-height:160px;overflow-y:auto;"></div>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <textarea id="om-inline-input" placeholder="Escriba la oportunidad de mejora o recomendación..." rows="2" maxlength="400"
          style="flex:1;padding:10px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:inherit;resize:vertical;"></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <button onclick="omInlineAgregar()" style="flex:1;padding:10px;background:#e65100;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">
          <i class="fas fa-plus"></i> Agregar
        </button>
        <button onclick="omInlineCerrar()" style="flex:1;padding:10px;background:#4caf50;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">
          <i class="fas fa-check"></i> Listo
        </button>
      </div>
      <button onclick="omInlineCerrar()" style="width:100%;padding:8px;background:#e0e0e0;color:#555;border:none;border-radius:8px;cursor:pointer;font-size:12px;">Cerrar sin guardar más</button>
    </div>
  </div>
</div>

<!-- LOADING -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">Generando informe...</div>
    <div class="loading-subtext" id="loading-subtext">Por favor espere</div>
  </div>
</div>

<div id="notification" class="notification">
  <i class="fas fa-check-circle"></i>
  <span id="notification-text">Operación completada con éxito</span>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const DATA = [
  { name:"ADMISIÓN", weight:0.25, items:[
    "Verificar el saludo de bienvenida al usuario",
    "Verificar si el tiempo de atención está en el estándar establecido (3 a 5 min)",
    "Verificar identidad del usuario a través de solicitud de documento de identidad",
    "Verificar actualización de datos del paciente",
    "Verificación del servicio a prestar",
    "Verificar diligenciamiento correcto del nivel y valor de cuota moderadora / copago",
    "Verificar comprensión de la información, incluyendo dudas por parte del paciente/familiar",
    "Verificar invitación al buzón de sugerencias al paciente",
    "Verificar cumplimiento de la caja preferencial (que se encuentre demarcada con movilidad reducida, mujeres embarazadas y niños de brazos)"
  ]},
  { name:"PRESTACIÓN DEL SERVICIO", weight:0.2, items:[
    "El personal de orientación en el Smart Queue brinda información clara y completa, realiza educación sobre el uso de la herramienta y asigna el turno correspondiente al servicio requerido y mantiene trato respetuoso al usuario",
    "Verificar saludo y presentación por parte del equipo médico",
    "Verificar educación al paciente y/o cuidador sobre riesgos y beneficios de la dilatación ocular",
    "Verificar si el tiempo de atención está en el estándar establecido. Oftalmología (Max 20min - Min 10) Optometría (Max 10Min- 5Min)",
    "Verificar que el profesional de salud entregue y explique de manera clara al paciente el diagnóstico, el plan de tratamiento, la prescripción médica, las remisiones, las órdenes de estudios diagnósticos y, cuando aplique, la indicación de cirugía, asegurando su comprensión",
    "Verificar entrega efectiva de copias impresas del ordenamiento médico, incluye recomendaciones universales que incluya: verificación de la correcta identificación del paciente y el tiempo de entrega de orden (10min - 15max)"
  ]},
  { name:"SEGURIDAD DEL PACIENTE", weight:0.15, items:[
    "Verificar que los medicamentos en uso se encuentren rotulados y no superen los 30 días de apertura",
    "Verificar que los insumos se encuentran debidamente rotulados incluyendo: nombre del producto, fecha de apertura, fecha de vencimiento y número de lote",
    "Verificar instalación de señalética de seguridad del paciente en consultorio y baños: QR, correcto lavado de manos y los 5 momentos de lavado de manos",
    "Verificar la correcta aplicación del protocolo de lavado de manos durante la consulta",
    "Validar si existe alguna condición o situación que pueda representar un riesgo para la seguridad de los pacientes",
    "Verificar que los formatos de registro de temperatura y humedad estén correctamente diligenciados y al día"
  ]},
  { name:"AMBIENTE HUMANIZADO", weight:0.2, items:[
    "Verificar el confort térmico en áreas como SIAU, sala de espera y consulta externa al momento de la presente auditoría",
    "Verificar la existencia de ruido y/o información visual exagerada en las áreas inspeccionadas",
    "Verificar disponibilidad de sillas de acuerdo al número de pacientes al momento de realizar la auditoría",
    "Verificar señalización de áreas y personas claves para las actividades de: Ingreso, admisión y consulta",
    "Verificación de segregación de residuos",
    "Verificación de limpieza, organización y cumplimiento del cuarto de residuos según los estándares de habilitación",
    "Verificación de limpieza del puesto de trabajo (asesores auxiliares, coordinador, sede)",
    "Verificación de limpieza en el área de sala de espera",
    "Verificación de limpieza en los consultorios elegidos por el auditor",
    "Verificación de limpieza en los baños de la institución",
    "Verificación de limpieza y orden en la zona del exterior de la sede",
    "Verificar instalación y funcionamiento del sistema de alarma en los baños para discapacitados"
  ]},
  { name:"PQRS", weight:0.1, items:[
    "Verificar buzón encendido",
    "Verificar papelería en el buzón",
    "Verificar funcionamiento del aplicativo",
    "Solicitar y verificar últimas aperturas de Buzón en el mes"
  ]},
  { name:"PROTOCOLO DE IMAGEN", weight:0.1, items:[
    "Verificar porte individual de carnet",
    "Verificar uso de accesorios discretos",
    "Verificar restricciones en usos de abrigos, bufandas y buzos de colores diferentes al negro",
    "Revisar uñas, peinado y maquillaje acorde al protocolo de imagen"
  ]}
];

const SCORE = { C:1, CP:0.5, NC:0 };

const AUDITORES_CARGOS = {
  "Luis Angel Bolaño Castro": "Gestor de Calidad",
  "Maria Clara Pizarro": "Directora de Calidad",
  "Daniel Rodriguez Galofre": "Gestor de Calidad",
  "Valentina Jimeno": "Asistente de Calidad",
  "Jennifer Melendez": "Gestora de Calidad"
};

let categoryChart, distributionChart;
let currentEvidenceItem = null;
// evidenceStore[itemId] = [{dataUrl, title}, ...]
let evidenceStore = {};

// ============================================================
// HELPERS
// ============================================================
function makeId(str, idx) {
  return str.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '-' + idx;
}
function legendFor(pct) {
  if (pct >= 92) return 'Riesgo Bajo';
  if (pct >= 85) return 'Riesgo Medio';
  return 'Riesgo Alto';
}
function showNotification(message, type='success') {
  const n = document.getElementById('notification');
  document.getElementById('notification-text').textContent = message;
  n.className = `notification notification-${type} show`;
  const icon = n.querySelector('i');
  icon.className = type==='error' ? 'fas fa-exclamation-circle' : type==='info' ? 'fas fa-info-circle' : 'fas fa-check-circle';
  setTimeout(() => n.classList.remove('show'), 4000);
}
function showLoading(text='Procesando...', sub='Por favor espere') {
  document.getElementById('loading-text').textContent = text;
  document.getElementById('loading-subtext').textContent = sub;
  document.getElementById('loading-overlay').classList.add('show');
}
function hideLoading() { document.getElementById('loading-overlay').classList.remove('show'); }

// ============================================================
// RENDER CHECKLIST
// ============================================================
function renderChecklist() {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  DATA.forEach(section => {
    const trTitle = document.createElement('tr');
    const tdTitle = document.createElement('td');
    tdTitle.colSpan = 8; tdTitle.className = 'section-title';
    tdTitle.textContent = section.name;
    trTitle.appendChild(tdTitle); tbody.appendChild(trTitle);

    section.items.forEach((text, idx) => {
      const itemId = makeId(section.name, idx);
      const row = document.createElement('tr');
      const tdA = document.createElement('td'); tdA.textContent = text; row.appendChild(tdA);
      ['C','CP','NC','NA'].forEach(mark => {
        const td = document.createElement('td'); td.className = 'radio-cell';
        td.innerHTML = `<input type="radio" name="${itemId}" value="${mark}">`;
        row.appendChild(td);
      });
      const tdEv = document.createElement('td'); tdEv.className = 'evidence-cell';
      const btn = document.createElement('button'); btn.className = 'evidence-btn';
      btn.innerHTML = '<i class="fas fa-camera"></i><span>Foto</span>';
      btn.onclick = () => openEvidenceModal(section.name, idx, text);
      btn.id = 'evidence-btn-' + itemId;
      tdEv.appendChild(btn); row.appendChild(tdEv);

      const tdOm = document.createElement('td'); tdOm.className = 'evidence-cell';
      const omBtn = document.createElement('button'); omBtn.className = 'om-btn';
      omBtn.innerHTML = '<i class="fas fa-lightbulb"></i><span>OM</span>';
      omBtn.onclick = () => openOmInlineModal(section.name, idx, text);
      omBtn.id = 'om-btn-' + itemId;
      tdOm.appendChild(omBtn); row.appendChild(tdOm);

      const tdObs = document.createElement('td');
      tdObs.innerHTML = '<input type="text" class="obs-input" placeholder="Observaciones...">';
      row.appendChild(tdObs); tbody.appendChild(row);
    });

    const trRes = document.createElement('tr'); trRes.className = 'result-row';
    const tdLbl = document.createElement('td'); tdLbl.textContent = 'Resultado %';
    const tdVal = document.createElement('td'); tdVal.colSpan = 7; tdVal.className = 'radio-cell';
    tdVal.id = 'result-' + makeId(section.name, 0); tdVal.textContent = '0%';
    trRes.appendChild(tdLbl); trRes.appendChild(tdVal); tbody.appendChild(trRes);
  });
}

// ============================================================
// EVIDENCE MODAL
// ============================================================
function openEvidenceModal(sectionName, itemIdx, itemText) {
  currentEvidenceItem = makeId(sectionName, itemIdx);
  document.getElementById('modal-title').innerHTML = `<i class="fas fa-camera" style="margin-right:8px;"></i>Evidencia: ${itemText.substring(0,60)}${itemText.length>60?'...':''}`;
  updateEvidencePreview();
  document.getElementById('evidenceModal').style.display = 'block';
}
function closeEvidenceModal() {
  document.getElementById('evidenceModal').style.display = 'none';
  currentEvidenceItem = null;
}
function handleEvidenceUpload(event) {
  const files = event.target.files;
  if (!files.length || !currentEvidenceItem) return;
  if (!evidenceStore[currentEvidenceItem]) evidenceStore[currentEvidenceItem] = [];
  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      evidenceStore[currentEvidenceItem].push({ dataUrl: e.target.result, title: '' });
      updateEvidencePreview();
      refreshEvidenceButton(currentEvidenceItem);
      saveEvidenceToIDB(currentEvidenceItem);
    };
    reader.readAsDataURL(file);
  });
  event.target.value = '';
}
function removeEvidence(idx) {
  if (!currentEvidenceItem) return;
  evidenceStore[currentEvidenceItem].splice(idx, 1);
  if (evidenceStore[currentEvidenceItem].length === 0) delete evidenceStore[currentEvidenceItem];
  updateEvidencePreview();
  refreshEvidenceButton(currentEvidenceItem);
  saveEvidenceToIDB(currentEvidenceItem);
}
function saveTitleInStore(idx, val) {
  if (currentEvidenceItem && evidenceStore[currentEvidenceItem]) {
    evidenceStore[currentEvidenceItem][idx].title = val;
    saveEvidenceToIDB(currentEvidenceItem);
  }
}
function updateEvidencePreview() {
  const preview = document.getElementById('evidence-preview');
  preview.innerHTML = '';
  const evidence = evidenceStore[currentEvidenceItem] || [];
  evidence.forEach((ev, idx) => {
    const div = document.createElement('div'); div.className = 'evidence-item';
    div.innerHTML = `
      <img src="${ev.dataUrl}" alt="Evidencia ${idx+1}">
      <button class="evidence-remove" onclick="removeEvidence(${idx})"><i class="fas fa-times"></i></button>
      <div class="evidence-title-bar">
        <input class="evidence-title-input" type="text" placeholder="Título de la foto (ej: Baño mujeres)..." value="${ev.title||''}" oninput="saveTitleInStore(${idx},this.value)">
      </div>`;
    preview.appendChild(div);
  });
}
function refreshEvidenceButton(itemId) {
  const btn = document.getElementById('evidence-btn-' + itemId);
  if (!btn) return;
  const count = (evidenceStore[itemId]||[]).length;
  if (count > 0) {
    btn.classList.add('has-evidence');
    if (!btn.querySelector('.evidence-count')) {
      const badge = document.createElement('span'); badge.className = 'evidence-count'; btn.appendChild(badge);
    }
    btn.querySelector('.evidence-count').textContent = count;
  } else {
    btn.classList.remove('has-evidence');
    const badge = btn.querySelector('.evidence-count'); if (badge) badge.remove();
  }
}

// ============================================================
// COMPUTE RESULTS
// ============================================================
function computeResults() {
  const results = [];
  DATA.forEach(section => {
    let sum=0, n=0;
    section.items.forEach((_,idx) => {
      const radios = document.getElementsByName(makeId(section.name, idx));
      let chosen=null; for(const r of radios) if(r.checked) chosen=r.value;
      if(chosen){ if(chosen==='NA'){sum+=1;n+=1;}else{sum+=SCORE[chosen];n+=1;} }
    });
    const pct = n>0 ? Math.round((sum/n)*100) : 0;
    const el = document.getElementById('result-'+makeId(section.name,0));
    if(el) el.textContent = pct+'%';
    results.push({ name:section.name, weight:section.weight, percentage:pct });
  });
  const wtbody = document.getElementById('weights-body'); wtbody.innerHTML='';
  let totalsum=0;
  results.forEach(r => {
    const w=Number(r.weight||0), p=r.percentage;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td class="radio-cell">${Math.round(w*100)}%</td><td class="radio-cell">${p}%</td><td>${legendFor(p)}</td>`;
    wtbody.appendChild(tr); totalsum+=(p/100)*w;
  });
  const finalPct=Math.round(totalsum*100);
  document.getElementById('total-pct').textContent=finalPct+'%';
  document.getElementById('final-status').textContent=legendFor(finalPct);
  const fs=document.querySelector('.final-score');
  if(finalPct>=92) fs.style.background='linear-gradient(135deg,#4caf50 0%,#66bb6a 100%)';
  else if(finalPct>=85) fs.style.background='linear-gradient(135deg,#ff9800 0%,#ffa726 100%)';
  else fs.style.background='linear-gradient(135deg,#f44336 0%,#ef5350 100%)';
  updateCharts(results, finalPct);
  return { results, finalPct };
}

// ============================================================
// COLLECT FINDINGS
// ============================================================
function collectFindings() {
  const out = { C:[], CP:[], NC:[], NA:[] };
  DATA.forEach(section => {
    section.items.forEach((item, idx) => {
      const itemId = makeId(section.name, idx);
      const radios = document.getElementsByName(itemId);
      let val=''; for(const r of radios) if(r.checked) val=r.value;
      const allRows = document.querySelectorAll('#tbody tr');
      let obs='';
      for(const row of allRows){ const fc=row.cells[0]; if(fc&&fc.textContent===item){ const oi=row.querySelector('.obs-input'); if(oi) obs=oi.value; break; } }
      if(val) out[val].push({ section:section.name, item, obs, itemId });
    });
  });
  return out;
}

// ============================================================
// REPORT MODAL
// ============================================================
function openReportModal() {
  const f=document.getElementById('fecha').value, s=document.getElementById('sede').value, a=document.getElementById('auditor').value;
  if(!f||!s||!a){ showNotification('Por favor complete Fecha, Sede y Auditor antes de generar el informe','error'); return; }
  document.getElementById('report-fecha').value=f;
  document.getElementById('reportModal').style.display='block';
}
function closeReportModal(){ document.getElementById('reportModal').style.display='none'; }

// ── Oportunidades de Mejora por ítem ────────────────────────
// omStore[itemId] = ["texto OM 1", "texto OM 2", ...]
let omStore = {};
let _currentOmItem = null;
let _currentOmLabel = '';

function openOmInlineModal(sectionName, itemIdx, itemText) {
  _currentOmItem = makeId(sectionName, itemIdx);
  _currentOmLabel = itemText.substring(0, 70) + (itemText.length > 70 ? '…' : '');
  document.getElementById('om-inline-subtitle').textContent = _currentOmLabel;
  document.getElementById('om-inline-input').value = '';
  omInlineRenderLista();
  document.getElementById('omInlineModal').style.display = 'block';
  setTimeout(()=>document.getElementById('om-inline-input').focus(), 100);
}

function omInlineRenderLista() {
  const cont = document.getElementById('om-inline-lista');
  const items = omStore[_currentOmItem] || [];
  if (items.length === 0) {
    cont.innerHTML = '<p style="color:#aaa;font-size:12px;text-align:center;margin:4px 0;">Sin oportunidades de mejora aún.</p>';
    return;
  }
  cont.innerHTML = items.map((txt, i) => `
    <div style="display:flex;align-items:flex-start;gap:8px;background:#fff8f0;border-left:3px solid #e65100;border-radius:6px;padding:7px 10px;margin-bottom:5px;">
      <span style="background:#e65100;color:#fff;border-radius:50%;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;">${i+1}</span>
      <span style="flex:1;font-size:12px;color:#2c3e50;">${txt}</span>
      <button onclick="omInlineEliminar(${i})" style="background:none;border:none;cursor:pointer;color:#e53935;font-size:13px;padding:0;" title="Eliminar">✕</button>
    </div>`).join('');
}

function omInlineAgregar() {
  const inp = document.getElementById('om-inline-input');
  const txt = inp.value.trim();
  if (!txt) return;
  if (!omStore[_currentOmItem]) omStore[_currentOmItem] = [];
  omStore[_currentOmItem].push(txt);
  inp.value = '';
  omInlineRenderLista();
  refreshOmButton(_currentOmItem);
  saveToLocalStorage();
  inp.focus();
}

function omInlineEliminar(idx) {
  if (!_currentOmItem || !omStore[_currentOmItem]) return;
  omStore[_currentOmItem].splice(idx, 1);
  if (omStore[_currentOmItem].length === 0) delete omStore[_currentOmItem];
  omInlineRenderLista();
  refreshOmButton(_currentOmItem);
  saveToLocalStorage();
}

function omInlineCerrar() {
  document.getElementById('omInlineModal').style.display = 'none';
  _currentOmItem = null;
}

function refreshOmButton(itemId) {
  const btn = document.getElementById('om-btn-' + itemId);
  if (!btn) return;
  const count = (omStore[itemId] || []).length;
  if (count > 0) {
    btn.classList.add('has-om');
    btn.innerHTML = `<i class="fas fa-lightbulb"></i><span>OM (${count})</span>`;
  } else {
    btn.classList.remove('has-om');
    btn.innerHTML = '<i class="fas fa-lightbulb"></i><span>OM</span>';
  }
}

// Recoger todas las OMs del store en orden para el informe
function collectAllOMs() {
  const result = [];
  DATA.forEach(section => {
    section.items.forEach((item, idx) => {
      const itemId = makeId(section.name, idx);
      if (omStore[itemId] && omStore[itemId].length > 0) {
        omStore[itemId].forEach(om => result.push(om));
      }
    });
  });
  return result;
}

function executeGenerateReport(){
  const rf = document.getElementById('report-fecha').value;
  const rm = document.getElementById('report-mes').value;
  const al = document.getElementById('report-auditor-lider').value;
  if (!rf || !rm || !al) { showNotification('Complete todos los campos del informe', 'error'); return; }
  closeReportModal();
  // Recoger OMs directamente del store — sin modal intermedio
  const omsParaInforme = collectAllOMs();
  generateFullReport(rf, rm, al, omsParaInforme);
}

// ============================================================
// CHARTS CAPTURE HELPER
// ============================================================
async function captureChart(canvas, chart) {
  chart.update('none');
  await new Promise(r=>setTimeout(r,150));
  const tmp=document.createElement('canvas'); const sc=4;
  tmp.width=canvas.width*sc; tmp.height=canvas.height*sc;
  const ctx=tmp.getContext('2d',{alpha:false});
  ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,tmp.width,tmp.height);
  ctx.scale(sc,sc); ctx.drawImage(canvas,0,0);
  return tmp.toDataURL('image/png',1.0);
}

// ============================================================
// EXPORT LIST VERIFICATION PDF (with legend fix)
// ============================================================
async function exportToPDF() {
  try {
    showNotification('Generando PDF de lista de verificación','info');
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF('p','mm','a4');
    const PW=doc.internal.pageSize.getWidth(), PH=doc.internal.pageSize.getHeight();
    const M=15, CW=PW-M*2;
    let yPos=M;
    const fecha=document.getElementById('fecha').value||'No especificada';
    const sede=document.getElementById('sede').value||'No especificada';
    const auditor=document.getElementById('auditor').value||'No especificado';
    const {results,finalPct}=computeResults();

    function chk(sp){ if(yPos+sp>PH-M){ doc.addPage(); yPos=M; return true; } return false; }

    // Header
    doc.setFillColor(30,60,114); doc.rect(0,0,PW,65,'F');
    doc.setFillColor(255,255,255); doc.roundedRect(M,12,20,20,3,3,'F');
    try{ const li=document.querySelector('.logo img'); if(li&&li.complete) doc.addImage(li.src,'PNG',M+2,14,16,16); }catch(e){}
    doc.setTextColor(255,255,255); doc.setFontSize(11); doc.setFont('helvetica','bold');
    doc.text('FUNDACIÓN OFTALMOLÓGICA DEL CARIBE',PW/2,22,{align:'center'});
    doc.setFontSize(14); doc.text('LISTA DE VERIFICACIÓN DE AUDITORÍA DE SERVICIO',PW/2,38,{align:'center'});
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.text('Sistema de Evaluación y Control de Calidad',PW/2,45,{align:'center'});
    doc.setFontSize(8); doc.setFont('helvetica','bold');
    doc.text('Código: ',M,56); doc.setFont('helvetica','normal'); doc.text('F-FSYM-823',M+15,56);
    doc.setFont('helvetica','bold'); doc.text('Versión: ',PW/2-10,56); doc.setFont('helvetica','normal'); doc.text('006',PW/2+5,56);
    doc.setFont('helvetica','bold'); doc.text('Vigencia: ',PW-45,56); doc.setFont('helvetica','normal'); doc.text('2026-19-01',PW-25,56);
    yPos=75;
    doc.setFillColor(248,249,250); doc.rect(M,yPos,CW,30,'F');
    doc.setTextColor(30,60,114); doc.setFontSize(9); doc.setFont('helvetica','bold');
    doc.text('FECHA DE AUDITORÍA:',M+3,yPos+7); doc.setFont('helvetica','normal'); doc.text(fecha,M+3,yPos+12);
    doc.setFont('helvetica','bold'); doc.text('SEDE:',M+3,yPos+19); doc.setFont('helvetica','normal'); doc.text(sede,M+3,yPos+24);
    doc.setFont('helvetica','bold'); doc.text('AUDITOR:',PW/2+5,yPos+19); doc.setFont('helvetica','normal'); doc.text(auditor,PW/2+5,yPos+24);
    yPos+=37;
    doc.setTextColor(30,60,114); doc.setFontSize(11); doc.setFont('helvetica','bold');
    doc.text('LISTA DE VERIFICACIÓN',M,yPos); yPos+=7;

    const tableData=[];
    DATA.forEach(section=>{
      tableData.push([{content:section.name,colSpan:6,styles:{fillColor:[102,126,234],textColor:[255,255,255],fontStyle:'bold',fontSize:9,halign:'left'}}]);
      section.items.forEach((item,idx)=>{
        const itemId=makeId(section.name,idx);
        const radios=document.getElementsByName(itemId);
        let sv=''; for(const r of radios) if(r.checked) sv=r.value;
        const allRows=document.querySelectorAll('#tbody tr');
        let obs='';
        for(const row of allRows){ const fc=row.cells[0]; if(fc&&fc.textContent===item){ const oi=row.querySelector('.obs-input'); if(oi) obs=oi.value; break; } }
        tableData.push([item,
          {content: sv==='C'?'C':'', styles:{halign:'center',fontStyle:'bold',textColor:sv==='C'?[46,125,50]:[180,180,180]}},
          {content: sv==='CP'?'CP':'', styles:{halign:'center',fontStyle:'bold',textColor:sv==='CP'?[230,120,0]:[180,180,180]}},
          {content: sv==='NC'?'NC':'', styles:{halign:'center',fontStyle:'bold',textColor:sv==='NC'?[211,47,47]:[180,180,180]}},
          {content: sv==='NA'?'N/A':'', styles:{halign:'center',fontStyle:'bold',textColor:sv==='NA'?[66,133,244]:[180,180,180]}},
          obs]);
      });
      const re=document.getElementById('result-'+makeId(section.name,0));
      const rp=re?re.textContent:'0%';
      tableData.push([{content:'Resultado %',styles:{fillColor:[232,245,233],textColor:[46,125,50],fontStyle:'bold'}},'','','','',{content:rp,styles:{fillColor:[232,245,233],textColor:[46,125,50],fontStyle:'bold',halign:'right'}}]);
    });
    doc.autoTable({startY:yPos,head:[[{content:'ASPECTOS A EVALUAR',styles:{halign:'left'}},'C','CP','NC','N/A','OBSERVACIONES']],body:tableData,theme:'grid',headStyles:{fillColor:[30,60,114],textColor:[255,255,255],fontSize:8,fontStyle:'bold',halign:'center'},bodyStyles:{fontSize:7,textColor:[44,62,80]},columnStyles:{0:{cellWidth:85,halign:'left'},1:{cellWidth:8,halign:'center'},2:{cellWidth:8,halign:'center'},3:{cellWidth:8,halign:'center'},4:{cellWidth:8,halign:'center'},5:{cellWidth:'auto',halign:'left'}},margin:{left:M,right:M}});

    // Results page
    doc.addPage(); yPos=M;
    doc.setTextColor(30,60,114); doc.setFontSize(12); doc.setFont('helvetica','bold');
    doc.text('META DE SEGURIDAD',PW/2,yPos,{align:'center'}); yPos+=8;
    doc.setFontSize(10); doc.text('Resultados por Criterio',PW/2,yPos,{align:'center'}); yPos+=10;
    doc.autoTable({startY:yPos,head:[['Criterio','Ponderación','Resultado %','Estado de Cumplimiento']],body:results.map(r=>[r.name,`${Math.round(r.weight*100)}%`,`${r.percentage}%`,legendFor(r.percentage)]),theme:'grid',headStyles:{fillColor:[30,60,114],textColor:[255,255,255],fontSize:9,fontStyle:'bold',halign:'center'},bodyStyles:{fontSize:8,textColor:[44,62,80]},columnStyles:{0:{cellWidth:65,halign:'left'},1:{cellWidth:30,halign:'center'},2:{cellWidth:30,halign:'center'},3:{cellWidth:'auto',halign:'center'}},margin:{left:M,right:M}});
    yPos=doc.lastAutoTable.finalY+15;

    // Final result box
    let sBG; if(finalPct>=92)sBG=[76,175,80]; else if(finalPct>=85)sBG=[255,152,0]; else sBG=[244,67,54];
    chk(55);
    doc.setFillColor(sBG[0],sBG[1],sBG[2]);
    doc.roundedRect(M+10,yPos,CW-20,45,3,3,'F');
    doc.setTextColor(255,255,255); doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('RESULTADO FINAL DE AUDITORÍA',PW/2,yPos+10,{align:'center'});
    doc.setFontSize(32); doc.text(`${finalPct}%`,PW/2,yPos+26,{align:'center'});
    doc.setFontSize(12); doc.text(legendFor(finalPct).toUpperCase(),PW/2,yPos+38,{align:'center'});
    yPos+=55;

    // ===== LEGEND =====
    chk(60);
    doc.setTextColor(30,60,114); doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('ESCALA DE CLASIFICACIÓN DE RIESGO',PW/2,yPos,{align:'center'}); yPos+=8;
    const legendItems=[
      {c:[76,175,80], t:'Mayor o igual a 92% – Riesgo Bajo. Cumple. Genera seguimiento. No genera plan de acción.'},
      {c:[255,152,0], t:'Mayor o igual a 85% – Riesgo Medio. Cumple parcialmente con los criterios evaluados y se requiere plan de acción y seguimiento.'},
      {c:[244,67,54], t:'Menor de 85% – Riesgo Alto. Se requiere acciones de intervención inmediata y plan de mejoramiento a corto plazo.'}
    ];
    legendItems.forEach(leg=>{
      chk(14);
      doc.setFillColor(248,248,248); doc.roundedRect(M,yPos,CW,12,2,2,'F');
      doc.setFillColor(leg.c[0],leg.c[1],leg.c[2]); doc.circle(M+6,yPos+6,3,'F');
      doc.setTextColor(44,62,80); doc.setFontSize(8); doc.setFont('helvetica','normal');
      const lines=doc.splitTextToSize(leg.t,CW-16);
      doc.text(lines,M+12,yPos+4+(12-lines.length*3.5)/2+1.5);
      yPos+=16;
    });
    yPos+=5;

    // Charts
    chk(120);
    doc.setTextColor(30,60,114); doc.setFontSize(11); doc.setFont('helvetica','bold');
    doc.text('VISUALIZACIÓN DE RESULTADOS',PW/2,yPos,{align:'center'}); yPos+=10;
    try{
      await new Promise(r=>setTimeout(r,400));
      const cc=document.getElementById('categoryChart');
      if(cc&&categoryChart){
        const img=await captureChart(cc,categoryChart);
        doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(30,60,114);
        doc.text('Resultados por Categoría',M,yPos); yPos+=5;
        const cw=CW*0.85, ch=60, xo=(CW-cw)/2;
        doc.addImage(img,'PNG',M+xo,yPos,cw,ch,'cc','SLOW'); yPos+=ch+12;
      }
      chk(75);
      const dc=document.getElementById('distributionChart');
      if(dc&&distributionChart){
        const img2=await captureChart(dc,distributionChart);
        doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(30,60,114);
        doc.text('Distribución de Evaluaciones',M,yPos); yPos+=5;
        const cw2=CW*0.85, ch2=60, xo2=(CW-cw2)/2;
        doc.addImage(img2,'PNG',M+xo2,yPos,cw2,ch2,'dc','SLOW');
      }
    }catch(e){ console.warn('Charts',e); }

    // Page numbers
    const pc=doc.internal.getNumberOfPages();
    for(let i=1;i<=pc;i++){
      doc.setPage(i); doc.setFontSize(8); doc.setTextColor(128,128,128); doc.setFont('helvetica','normal');
      doc.text(`Página ${i} de ${pc}`,PW/2,PH-10,{align:'center'});
      doc.text(`Generado: ${new Date().toLocaleDateString('es-CO')}`,PW-M,PH-10,{align:'right'});
    }
    doc.save(`Lista_Verificacion_${fecha.replace(/-/g,'')}_${sede.replace(/\s+/g,'_')}.pdf`);
    showNotification('PDF exportado exitosamente','success');
  } catch(e){ console.error(e); showNotification('Error al exportar: '+e.message,'error'); }
}

// ============================================================
// FULL REPORT PDF
// ============================================================
// Helper: load remote image as base64 for PDF embedding
async function loadImageAsBase64(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
      try {
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth || img.width;
        canvas.height = img.naturalHeight || img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL('image/jpeg', 0.9));
      } catch(e) { resolve(null); }
    };
    img.onerror = () => resolve(null);
    img.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
  });
}

async function generateFullReport(reportFecha, reportMes, auditorLider, oportunidades=[]) {
  try {
    showLoading('Generando informe completo...','Construyendo páginas del informe');
    await new Promise(r=>setTimeout(r,80));

    const fecha=document.getElementById('fecha').value;
    const sede=document.getElementById('sede').value;
    const auditorAsignado=document.getElementById('auditor').value;
    const {results, finalPct}=computeResults();
    const findings=collectFindings();

    const {jsPDF}=window.jspdf;
    const doc=new jsPDF('p','mm','a4');
    const PW=doc.internal.pageSize.getWidth(), PH=doc.internal.pageSize.getHeight();
    const M=15, CW=PW-M*2;
    let yPos=M, pageNum=1;

    const CN=[30,60,114], CB=[42,82,152];
    const CG=[76,175,80], CO=[255,152,0], CR=[244,67,54];
    const CT=[44,62,80];
    let SC; if(finalPct>=92)SC=CG; else if(finalPct>=85)SC=CO; else SC=CR;

    // ─── Header on every page ───
    function drawPageHeader(){
      // Barra azul más alta para acomodar dos líneas + metadatos
      doc.setFillColor(CN[0],CN[1],CN[2]);
      doc.rect(0,0,PW,28,'F');
      // Logo más grande
      try{
        const li=document.querySelector('.logo img');
        if(li&&li.complete){
          doc.setFillColor(255,255,255);
          doc.roundedRect(M,3,17,17,2,2,'F');
          doc.addImage(li.src,'PNG',M+1,4,15,15);
        }
      }catch(e){}

      // Línea 1: FUNDACIÓN OFTALMOLÓGICA DEL CARIBE
      doc.setTextColor(255,255,255);
      doc.setFontSize(11); doc.setFont('helvetica','bold');
      doc.text('FUNDACIÓN OFTALMOLÓGICA DEL CARIBE',PW/2,9,{align:'center'});

      // Línea 2: INFORME DE AUDITORÍA DE SERVICIO — blanco también
      doc.setFontSize(8.5); doc.setFont('helvetica','normal');
      doc.setTextColor(255,255,255);
      doc.text('INFORME DE AUDITORÍA DE SERVICIO',PW/2,16,{align:'center'});

      // Metadatos en la franja inferior
      doc.setFontSize(7); doc.setFont('helvetica','normal');
      doc.setTextColor(180,200,240);
      doc.text('Código: F-FSYM-823',M+22,25);
      doc.text('Versión: 006',PW/2,25,{align:'center'});
      doc.text('Vigencia: 2026-19-01',PW-M,25,{align:'right'});
    }
    function addFooter(){
      doc.setFontSize(7.5); doc.setTextColor(160,160,160); doc.setFont('helvetica','normal');
      doc.setDrawColor(220,220,220); doc.setLineWidth(0.3);
      doc.line(M,PH-14,PW-M,PH-14);
      doc.text('Fundación Oftalmológica del Caribe – Informe de Auditoría de Servicio',M,PH-8);
      doc.text(`Pág. ${pageNum}`,PW/2,PH-8,{align:'center'});
      doc.text(new Date().toLocaleDateString('es-CO'),PW-M,PH-8,{align:'right'});
    }
    function newPage(){
      addFooter(); doc.addPage(); pageNum++;
      drawPageHeader(); yPos=33;
    }
    function chk(sp){ if(yPos+sp>PH-20){ newPage(); return true; } return false; }
    function sectionBar(title, color){
      chk(12);
      doc.setFillColor(color[0],color[1],color[2]);
      doc.roundedRect(M,yPos,CW,9,2,2,'F');
      doc.setTextColor(255,255,255); doc.setFontSize(9); doc.setFont('helvetica','bold');
      doc.text(title,M+4,yPos+6.5);
      yPos+=13;
    }

    // ========================================
    // 1) PÁGINA 1 — Información general
    // ========================================
    drawPageHeader();
    yPos=33;
    sectionBar('INFORMACIÓN GENERAL DEL INFORME', CN);
    doc.autoTable({startY:yPos, body:[
      ['Fecha Informe:',reportFecha,'Fecha Auditoría:',fecha],
      ['Mes Auditoría:',reportMes,'',''],
      ['Auditor Líder:',auditorLider+'\n'+(AUDITORES_CARGOS[auditorLider]||''),'Auditor Asignado:',auditorAsignado+'\n'+(AUDITORES_CARGOS[auditorAsignado]||'')],
      ['Objetivo:','Verificar el cumplimiento de los diferentes procesos que tienen relación directa con la atención prestada al usuario en las áreas de admisión, prestación del servicio, seguridad del paciente, ambiente humanizado, PQRS y protocolo de imagen.',
        'Proceso(s) a auditar:',{content:'Atención Asistencial – Consulta Externa, Información y Atención al usuario – Calidad\n\nSede auditada: '+sede, styles:{fontStyle:'bold'}}],
      ['Documentos\nAplicables:','Lista de Verificación de Auditoría de Servicio (F-FSYM-823)','','']
    ], theme:'grid', styles:{fontSize:8,textColor:CT,cellPadding:3.5,lineWidth:0.2,lineColor:[210,218,230]},
    columnStyles:{0:{fontStyle:'bold',fillColor:[240,244,255],textColor:CN,cellWidth:38},1:{cellWidth:'auto'},2:{fontStyle:'bold',fillColor:[240,244,255],textColor:CN,cellWidth:38},3:{cellWidth:'auto'}},
    margin:{left:M,right:M}});
    yPos=doc.lastAutoTable.finalY+10;

    // ========================================
    // 2) HALLAZGOS
    // ========================================
    sectionBar('HALLAZGOS DE AUDITORÍA', CN);
    // Resumen: solo Conformes y No Conformes (CP+NC juntos)
    chk(26);
    const totalNC = findings.CP.length + findings.NC.length;
    const bwBox2=(CW-6)/2;
    [{l:'Hallazgos Conformes', n:findings.C.length, c:CG},
     {l:'Hallazgos No Conformes', n:totalNC, c:CR}]
    .forEach((cat,i)=>{
      doc.setFillColor(cat.c[0],cat.c[1],cat.c[2]);
      doc.roundedRect(M+i*(bwBox2+6),yPos,bwBox2,21,3,3,'F');
      doc.setTextColor(255,255,255); doc.setFontSize(17); doc.setFont('helvetica','bold');
      doc.text(cat.n.toString(),M+i*(bwBox2+6)+bwBox2/2,yPos+13,{align:'center'});
      doc.setFontSize(7); doc.setFont('helvetica','normal');
      doc.text(cat.l,M+i*(bwBox2+6)+bwBox2/2,yPos+18.5,{align:'center'});
    });
    yPos+=29;

    // ─── Parafraseo contextual inteligente por ítem ───────────────────────
    // Mapa: fragmento clave del ítem → { ok: texto conforme, fail: texto no conforme }
    const ITEM_PHRASES = [
      // ADMISIÓN
      { k:/saludo de bienvenida/i,
        ok:  'Se evidenció que el personal realizó el saludo de bienvenida al usuario de manera cordial y oportuna al momento del ingreso.',
        fail:'No se evidenció el saludo de bienvenida al usuario por parte del personal de admisión.' },
      { k:/tiempo de atención.*3 a 5/i,
        ok:  'Se verificó que el tiempo de atención en admisión se encontraba dentro del estándar establecido de 3 a 5 minutos.',
        fail:'Se observó que el tiempo de atención en admisión no cumplió con el estándar establecido de 3 a 5 minutos.' },
      { k:/identidad del usuario/i,
        ok:  'Se constató la verificación de la identidad del usuario mediante la solicitud del documento de identidad al momento de la admisión.',
        fail:'No se constató la verificación de identidad del usuario a través de la solicitud del documento de identidad.' },
      { k:/actualización de datos/i,
        ok:  'Se verificó la actualización de datos del paciente en el sistema durante el proceso de admisión.',
        fail:'No se evidenció la actualización de datos del paciente en el sistema durante la admisión.' },
      { k:/servicio a prestar/i,
        ok:  'Se confirmó la verificación del servicio a prestar al paciente previo a su ingreso a consulta.',
        fail:'No se confirmó la verificación del tipo de servicio a prestar al paciente.' },
      { k:/cuota moderadora|copago/i,
        ok:  'Se verificó el diligenciamiento correcto del nivel y valor de cuota moderadora o copago en el sistema.',
        fail:'Se observó que el diligenciamiento del nivel y valor de cuota moderadora o copago presentó inconsistencias.' },
      { k:/comprensión de la información.*dudas/i,
        ok:  'Se evidenció que el personal verificó la comprensión de la información por parte del paciente o familiar, resolviendo las dudas presentadas.',
        fail:'No se evidenció que el personal verificara la comprensión de la información ni atendiera las dudas del paciente o familiar.' },
      { k:/buzón de sugerencias/i,
        ok:  'Se constató que el personal invitó al paciente a utilizar el buzón de sugerencias al finalizar la atención.',
        fail:'No se constató la invitación al paciente para hacer uso del buzón de sugerencias.' },
      { k:/caja preferencial/i,
        ok:  'Se verificó que la caja preferencial se encontraba debidamente demarcada para personas con movilidad reducida, mujeres embarazadas y niños de brazos.',
        fail:'Se observó que la caja preferencial no contaba con la demarcación adecuada para población prioritaria.' },
      // PRESTACIÓN DEL SERVICIO
      { k:/Smart Queue|orientación/i,
        ok:  'Se evidenció que el personal de orientación en el Smart Queue brindó información clara y completa, realizó educación sobre el uso de la herramienta y asignó el turno correspondiente con trato respetuoso.',
        fail:'No se evidenció que el personal de orientación en el Smart Queue brindara información clara ni realizara educación adecuada sobre el uso de la herramienta.' },
      { k:/saludo y presentación.*equipo médico/i,
        ok:  'Se verificó que el equipo médico realizó el saludo y presentación al paciente al inicio de la consulta.',
        fail:'No se verificó el saludo y presentación por parte del equipo médico al inicio de la consulta.' },
      { k:/dilatación ocular/i,
        ok:  'Se constató que el profesional brindó educación al paciente o cuidador sobre los riesgos y beneficios del procedimiento de dilatación ocular.',
        fail:'No se constató la educación al paciente sobre los riesgos y beneficios de la dilatación ocular.' },
      { k:/tiempo de atención.*Oftalmología|estándar.*Optometría/i,
        ok:  'Se verificó que el tiempo de atención en consulta se encontraba dentro del estándar establecido para el servicio.',
        fail:'Se observó que el tiempo de atención en consulta no cumplió con el estándar establecido para el servicio.' },
      { k:/diagnóstico.*plan de tratamiento|prescripción médica/i,
        ok:  'Se evidenció que el profesional de salud entregó y explicó de manera clara al paciente el diagnóstico, plan de tratamiento, prescripción médica y órdenes pertinentes, asegurando su comprensión.',
        fail:'No se evidenció que el profesional explicara de manera clara el diagnóstico, plan de tratamiento y prescripción médica al paciente.' },
      { k:/copias impresas.*ordenamiento médico|10min.*15max/i,
        ok:  'Se confirmó la entrega efectiva de copias impresas del ordenamiento médico con verificación de identidad del paciente y dentro del tiempo estándar establecido.',
        fail:'No se confirmó la entrega efectiva de copias impresas del ordenamiento médico dentro del tiempo estándar o con verificación de identidad.' },
      // SEGURIDAD DEL PACIENTE
      { k:/medicamentos.*rotulados.*30 días/i,
        ok:  'Se verificó que los medicamentos en uso estaban debidamente rotulados y no superaban los 30 días de apertura.',
        fail:'Se observó que los medicamentos en uso no contaban con la rotulación adecuada o superaban los 30 días de apertura.' },
      { k:/insumos.*rotulados.*vencimiento/i,
        ok:  'Se evidenció que los insumos contaban con la rotulación correcta: nombre del producto, fecha de apertura, fecha de vencimiento y número de lote.',
        fail:'Se observó que los insumos no contaban con la rotulación completa requerida (nombre, apertura, vencimiento, lote).' },
      { k:/señalética.*seguridad.*QR|5 momentos/i,
        ok:  'Se constató la instalación de señalética de seguridad del paciente en consultorios y baños: código QR, lavado de manos y los 5 momentos.',
        fail:'No se constató la instalación completa de señalética de seguridad del paciente en consultorios o baños.' },
      { k:/lavado de manos durante la consulta/i,
        ok:  'Se verificó la correcta aplicación del protocolo de lavado de manos por parte del personal durante la consulta.',
        fail:'Se observó que el protocolo de lavado de manos no fue aplicado correctamente durante la consulta.' },
      { k:/riesgo para la seguridad/i,
        ok:  'Se confirmó que no se identificaron condiciones o situaciones que representaran riesgo para la seguridad de los pacientes durante la visita.',
        fail:'Se identificaron condiciones o situaciones que pueden representar un riesgo para la seguridad de los pacientes.' },
      { k:/temperatura y humedad/i,
        ok:  'Se verificó que los formatos de registro de temperatura y humedad estaban correctamente diligenciados y actualizados.',
        fail:'Se observó que los formatos de registro de temperatura y humedad no estaban al día o presentaban inconsistencias.' },
      // AMBIENTE HUMANIZADO
      { k:/confort térmico/i,
        ok:  'Se evidenció confort térmico adecuado en las áreas de SIAU, sala de espera y consulta externa al momento de la auditoría.',
        fail:'Se observó que el confort térmico en las áreas evaluadas no era adecuado al momento de la auditoría.' },
      { k:/ruido.*información visual/i,
        ok:  'Se constató que no se presentaron niveles excesivos de ruido ni información visual exagerada en las áreas inspeccionadas.',
        fail:'Se evidenció la presencia de ruido excesivo o información visual exagerada en las áreas inspeccionadas.' },
      { k:/sillas.*número de pacientes/i,
        ok:  'Se verificó la disponibilidad suficiente de sillas conforme al número de pacientes presentes en sala de espera.',
        fail:'Se observó insuficiente disponibilidad de sillas en relación con el número de pacientes presentes.' },
      { k:/señalización.*ingreso.*admisión/i,
        ok:  'Se constató la señalización adecuada de áreas y personas clave para las actividades de ingreso, admisión y consulta.',
        fail:'Se observó señalización insuficiente o ausente en áreas clave de ingreso, admisión y consulta.' },
      { k:/segregación de residuos/i,
        ok:  'Se evidenció la correcta segregación de residuos en los puntos de generación inspeccionados.',
        fail:'Se observó segregación inadecuada de residuos en los puntos evaluados.' },
      { k:/cuarto de residuos/i,
        ok:  'Se verificó que el cuarto de residuos se encontraba limpio, organizado y cumplía con los estándares de habilitación.',
        fail:'Se observó que el cuarto de residuos no cumplía con los estándares de limpieza, organización o habilitación requeridos.' },
      { k:/limpieza del puesto de trabajo.*asesores|coordinador/i,
        ok:  'Se evidenció orden y limpieza en los puestos de trabajo de asesores, auxiliares y coordinación de la sede.',
        fail:'Se observó falta de limpieza u organización en los puestos de trabajo de asesores, auxiliares o coordinación.' },
      { k:/limpieza.*sala de espera/i,
        ok:  'Se constató la adecuada limpieza y orden en el área de sala de espera.',
        fail:'Se evidenciaron condiciones de limpieza u orden deficientes en el área de sala de espera.' },
      { k:/limpieza.*consultorios/i,
        ok:  'Se verificó la limpieza y organización en los consultorios seleccionados para la auditoría.',
        fail:'Se observaron deficiencias de limpieza u organización en los consultorios inspeccionados.' },
      { k:/limpieza.*baños/i,
        ok:  'Se constató la limpieza adecuada en los baños de la institución al momento de la visita.',
        fail:'Se evidenciaron condiciones de limpieza deficientes en los baños de la institución.' },
      { k:/exterior de la sede/i,
        ok:  'Se verificó el orden y la limpieza en la zona exterior de la sede.',
        fail:'Se observaron deficiencias de limpieza u orden en la zona exterior de la sede.' },
      { k:/alarma.*baños.*discapacitados/i,
        ok:  'Se constató la instalación y funcionamiento correcto del sistema de alarma en los baños para personas con discapacidad.',
        fail:'Se evidenció que el sistema de alarma en los baños para personas con discapacidad no estaba instalado o no funcionaba correctamente.' },
      // PQRS
      { k:/buzón encendido/i,
        ok:  'Se verificó que el buzón digital se encontraba encendido y operativo al momento de la auditoría.',
        fail:'Se observó que el buzón digital se encontraba apagado o no operativo.' },
      { k:/papelería en el buzón/i,
        ok:  'Se evidenció la disponibilidad de papelería suficiente en el buzón físico de sugerencias.',
        fail:'Se observó ausencia o insuficiencia de papelería en el buzón de sugerencias.' },
      { k:/funcionamiento del aplicativo/i,
        ok:  'Se verificó el correcto funcionamiento del aplicativo de PQRS durante la visita.',
        fail:'Se observó que el aplicativo de PQRS no funcionaba correctamente al momento de la auditoría.' },
      { k:/últimas aperturas de Buzón/i,
        ok:  'Se verificaron las últimas aperturas del buzón en el mes, confirmando el seguimiento regular al proceso.',
        fail:'No se pudo verificar el registro de aperturas del buzón en el mes, o no se evidenció seguimiento regular.' },
      // PROTOCOLO DE IMAGEN
      { k:/carnet/i,
        ok:  'Se evidenció que el personal portaba el carnet institucional de forma individual y visible.',
        fail:'Se observó que parte del personal no portaba el carnet institucional de manera visible.' },
      { k:/accesorios discretos/i,
        ok:  'Se confirmó el uso de accesorios discretos por parte del personal, acorde al protocolo de imagen institucional.',
        fail:'Se evidenció uso de accesorios no discretos o no acordes al protocolo de imagen institucional.' },
      { k:/abrigos.*bufandas.*buzos/i,
        ok:  'Se verificó el cumplimiento de las restricciones sobre el uso de abrigos, bufandas y buzos de colores diferentes al negro.',
        fail:'Se observó incumplimiento en las restricciones de uso de abrigos, bufandas o buzos de colores no permitidos.' },
      { k:/uñas.*peinado.*maquillaje/i,
        ok:  'Se constató que uñas, peinado y maquillaje del personal se encontraban acordes al protocolo de imagen establecido.',
        fail:'Se observaron incumplimientos en uñas, peinado o maquillaje respecto al protocolo de imagen institucional.' },
    ];

    // Construye el párrafo final fusionando ítem + observación en una sola oración fluida
    // con conectores variados para que suene natural
    function buildFinding(itemText, isConforming, obsText) {
      const itemLower = itemText.toLowerCase();
      let base = '';

      for (const p of ITEM_PHRASES) {
        if (p.k.test(itemLower)) {
          base = isConforming ? p.ok : p.fail;
          break;
        }
      }

      if (!base) {
        let d = itemText.trim();
        d = d.replace(/^(Verificar(?: que| si| el| la| los| las| el cumplimiento de)?|Validar si|Revisar|Solicitar y verificar)\s+/i, '');
        d = d.charAt(0).toLowerCase() + d.slice(1);
        d = d.replace(/\.$/, '');
        base = isConforming
          ? 'Se evidenció el cumplimiento de ' + d + '.'
          : 'No se evidenció el cumplimiento de ' + d + '.';
      }

      if (!obsText) return base;

      const baseClean = base.replace(/\.$/, '');
      const obs = obsText.trim().replace(/^\s*[-–:]\s*/, '');
      const obsLower = obs.charAt(0).toLowerCase() + obs.slice(1);

      // Detectar si la observación ya trae conector propio
      const yaConector = /^(debido|ya que|puesto que|por cuanto|dado que|se observó|se evidenció|se identificó|esto|lo anterior|sin embargo|no obstante)/i.test(obs);
      if (yaConector) {
        return baseClean + '; ' + obsLower;
      }

      if (isConforming) {
        // Variedad de conectores positivos
        const conectoresOk = [
          ', destacando que ', ', evidenciándose además que ', '; se resalta que ',
          ', lo cual se verificó a través de ', '. Adicionalmente, ',
        ];
        const c = conectoresOk[Math.floor(Math.random()*conectoresOk.length)];
        return baseClean + c + obsLower;
      } else {
        // Variedad de conectores para no conformidades
        const conectoresNc = [
          ', dado que ', ', puesto que ', ', por cuanto ',
          '; se identificó que ', ', toda vez que ', '. Al respecto, ',
          ', situación que se evidenció en tanto que ',
        ];
        const c = conectoresNc[Math.floor(Math.random()*conectoresNc.length)];
        return baseClean + c + obsLower;
      }
    }

    function renderFindingGroupList(items, groupLabel, headerColor, isConforming){
      if(!items||items.length===0) return;
      const bySec={};
      items.forEach(f=>{ if(!bySec[f.section]) bySec[f.section]=[]; bySec[f.section].push(f); });

      chk(14);
      doc.setFillColor(headerColor[0],headerColor[1],headerColor[2]);
      doc.roundedRect(M,yPos,CW,9,2,2,'F');
      doc.setTextColor(255,255,255); doc.setFontSize(9); doc.setFont('helvetica','bold');
      doc.text(groupLabel,M+4,yPos+6.5);
      yPos+=13;

      let gIdx=1;
      for(const [secName,secItems] of Object.entries(bySec)){
        chk(12);
        doc.setFillColor(240,244,255);
        doc.roundedRect(M,yPos,CW,8,2,2,'F');
        doc.setTextColor(CN[0],CN[1],CN[2]); doc.setFontSize(8.5); doc.setFont('helvetica','bold');
        doc.text(secName,M+4,yPos+5.8);
        yPos+=11;

        secItems.forEach(f=>{
          const obsText = f.obs ? f.obs.trim() : '';
          const parrafo = buildFinding(f.item, isConforming, obsText);
          const parLines = doc.splitTextToSize(parrafo, CW-12);
          const needed = parLines.length*4.8+10;
          chk(needed);

          doc.setFillColor(headerColor[0],headerColor[1],headerColor[2]);
          doc.circle(M+3.5,yPos+3,2.8,'F');
          doc.setTextColor(255,255,255); doc.setFontSize(6); doc.setFont('helvetica','bold');
          doc.text(String(gIdx),M+3.5,yPos+3.8,{align:'center'});

          doc.setTextColor(CT[0],CT[1],CT[2]); doc.setFontSize(8); doc.setFont('helvetica','normal');
          doc.text(parLines, M+9, yPos+3);
          yPos += parLines.length*4.8+6;
          gIdx++;
        });
        yPos+=3;
      }
      yPos+=5;
    }

    // CP y NC se muestran juntos en "NO CONFORMES"
    const allNC = [...findings.CP, ...findings.NC];
    renderFindingGroupList(findings.C, 'HALLAZGOS CONFORMES', CG, true);
    renderFindingGroupList(allNC, 'HALLAZGOS NO CONFORMES', CR, false);
    // N/A no se incluye en el informe

    // ========================================
    // 3) ANEXOS — evidencia fotográfica
    // ========================================
    const evKeys=Object.keys(evidenceStore).filter(k=>evidenceStore[k].length>0);
    if(evKeys.length>0){
      chk(18);
      sectionBar('ANEXOS: EVIDENCIA FOTOGRÁFICA', CB);

      // Build ordered list: { sectionName, photos[] } preserving DATA order
      const bySectionOrdered=[];
      DATA.forEach(sec=>{
        const secPhotos=[];
        sec.items.forEach((item,idx)=>{
          const key=makeId(sec.name,idx);
          if(evidenceStore[key]&&evidenceStore[key].length>0){
            evidenceStore[key].forEach(ev=>secPhotos.push(ev));
          }
        });
        if(secPhotos.length>0) bySectionOrdered.push({name:sec.name, photos:secPhotos});
      });

      let globalAnexoNum=1; // contador global de fotos para el número de anexo

      for(const secGroup of bySectionOrdered){
        // Encabezado de categoría
        chk(14);
        doc.setFillColor(30,60,114); doc.roundedRect(M,yPos,CW,9,2,2,'F');
        doc.setTextColor(255,255,255); doc.setFontSize(9); doc.setFont('helvetica','bold');
        doc.text(secGroup.name,M+4,yPos+6.5);
        yPos+=13;

        // Fotos de 2 en 2 por fila
        for(let i=0;i<secGroup.photos.length;i+=2){
          chk(82);
          const iw=(CW-8)/2, ih=62;

          // Foto izquierda
          try{
            doc.addImage(secGroup.photos[i].dataUrl,'JPEG',M,yPos,iw,ih);
          }catch(e){}
          // Caption izquierda: "Anexo N: título"
          const cap1='Anexo '+globalAnexoNum+': '+(secGroup.photos[i].title||'Evidencia fotográfica');
          doc.setFontSize(7.5); doc.setFont('helvetica','italic'); doc.setTextColor(50,60,80);
          const cap1Lines=doc.splitTextToSize(cap1,iw-2);
          doc.text(cap1Lines,M+iw/2,yPos+ih+5,{align:'center'});
          globalAnexoNum++;

          // Foto derecha (si existe)
          if(secGroup.photos[i+1]){
            try{
              doc.addImage(secGroup.photos[i+1].dataUrl,'JPEG',M+iw+8,yPos,iw,ih);
            }catch(e){}
            const cap2='Anexo '+globalAnexoNum+': '+(secGroup.photos[i+1].title||'Evidencia fotográfica');
            doc.setFontSize(7.5); doc.setFont('helvetica','italic'); doc.setTextColor(50,60,80);
            const cap2Lines=doc.splitTextToSize(cap2,iw-2);
            doc.text(cap2Lines,M+iw+8+iw/2,yPos+ih+5,{align:'center'});
            globalAnexoNum++;
          }
          yPos+=ih+(cap1Lines&&cap1Lines.length>1?12:9);
        }
        yPos+=8;
      }
    }

    // ========================================
    // 4) RESULTADOS POR CATEGORÍA
    // ========================================
    chk(18);
    sectionBar('RESULTADOS POR CATEGORÍA', CN);
    doc.autoTable({startY:yPos,
      head:[['Categoría / Proceso','Ponderación','Resultado','Clasificación de Riesgo']],
      body:results.map(r=>[r.name,Math.round(r.weight*100)+'%',r.percentage+'%',legendFor(r.percentage)]),
      theme:'grid',
      headStyles:{fillColor:CN,textColor:[255,255,255],fontSize:9,fontStyle:'bold',halign:'center'},
      bodyStyles:{fontSize:8.5,textColor:CT,lineWidth:0.2,lineColor:[210,218,230]},
      columnStyles:{0:{cellWidth:68,halign:'left',fontStyle:'bold'},1:{cellWidth:28,halign:'center'},2:{cellWidth:25,halign:'center',fontStyle:'bold'},3:{cellWidth:'auto',halign:'center'}},
      margin:{left:M,right:M},
      didParseCell:function(d){
        if(d.section==='body'&&d.column.index===2){
          const pv=parseInt(d.cell.text[0]);
          if(pv>=92){d.cell.styles.textColor=CG;d.cell.styles.fillColor=[232,245,233];}
          else if(pv>=85){d.cell.styles.textColor=CO;d.cell.styles.fillColor=[255,243,224];}
          else{d.cell.styles.textColor=CR;d.cell.styles.fillColor=[255,235,238];}
        }
        if(d.section==='body'&&d.column.index===3){
          const v=d.cell.text[0];
          if(v==='Riesgo Bajo'){d.cell.styles.textColor=CG;d.cell.styles.fillColor=[232,245,233];}
          else if(v==='Riesgo Medio'){d.cell.styles.textColor=CO;d.cell.styles.fillColor=[255,243,224];}
          else{d.cell.styles.textColor=CR;d.cell.styles.fillColor=[255,235,238];}
        }
      }
    });
    yPos=doc.lastAutoTable.finalY+8;

    // Progress bars per category
    chk(results.length*11+6);
    results.forEach(function(r){
      chk(11);
      doc.setFontSize(7.5); doc.setFont('helvetica','bold'); doc.setTextColor(CT[0],CT[1],CT[2]);
      const lbl=r.name.length>24?r.name.substring(0,24)+'…':r.name;
      doc.text(lbl,M,yPos+5.5);
      const barX=M+54, barW=CW-82, barH=7;
      doc.setFillColor(225,225,230); doc.roundedRect(barX,yPos,barW,barH,2,2,'F');
      let bc; if(r.percentage>=92)bc=CG; else if(r.percentage>=85)bc=CO; else bc=CR;
      doc.setFillColor(bc[0],bc[1],bc[2]);
      doc.roundedRect(barX,yPos,Math.max(3,(r.percentage/100)*barW),barH,2,2,'F');
      doc.setFontSize(7.5); doc.setFont('helvetica','bold'); doc.setTextColor(bc[0],bc[1],bc[2]);
      doc.text(r.percentage+'%',barX+barW+4,yPos+5.5);
      yPos+=11;
    });
    yPos+=8;

    // ========================================
    // 5) RESULTADO FINAL — página propia
    // ========================================
    addFooter();
    doc.addPage(); pageNum++;
    drawPageHeader();
    yPos=33;

    sectionBar('RESULTADO FINAL DE AUDITORÍA', CN);

    // Cuadro resultado más compacto
    const boxH=40;
    chk(boxH+6);
    doc.setFillColor(SC[0],SC[1],SC[2]);
    doc.roundedRect(M+22,yPos,CW-44,boxH,5,5,'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(8.5); doc.setFont('helvetica','bold');
    doc.text('RESULTADO FINAL DE AUDITORÍA',PW/2,yPos+9,{align:'center'});
    doc.setFontSize(30); doc.text(finalPct+'%',PW/2,yPos+27,{align:'center'});
    doc.setFontSize(10); doc.text(legendFor(finalPct).toUpperCase(),PW/2,yPos+37,{align:'center'});
    yPos+=boxH+10;

    // Legend
    const legItems=[
      {c:CG,t:'Mayor o igual a 92% – Riesgo Bajo. Cumple. Genera seguimiento. No genera plan de acción.'},
      {c:CO,t:'Mayor o igual a 85% – Riesgo Medio. Cumple parcialmente con los criterios evaluados y se requiere plan de acción y seguimiento.'},
      {c:CR,t:'Menor de 85% – Riesgo Alto. Se requiere acciones de intervención inmediata y plan de mejoramiento a corto plazo.'}
    ];
    legItems.forEach(function(leg){
      chk(14);
      doc.setFillColor(248,248,250); doc.roundedRect(M,yPos,CW,12,2,2,'F');
      doc.setFillColor(leg.c[0],leg.c[1],leg.c[2]); doc.circle(M+5.5,yPos+6,3,'F');
      doc.setTextColor(44,62,80); doc.setFontSize(8); doc.setFont('helvetica','normal');
      const lns=doc.splitTextToSize(leg.t,CW-16);
      doc.text(lns,M+11,yPos+4+(12-lns.length*3.8)/2+1.5);
      yPos+=16;
    });
    yPos+=8;

    // Conclusion
    sectionBar('CONCLUSIÓN', CB);
    let concText='';
    if(finalPct>=92) concText='Como resultado de la auditoría realizada en '+sede+' durante el mes de '+reportMes+', se obtiene una calificación del '+finalPct+'% clasificándose en RIESGO BAJO. La sede cumple satisfactoriamente con los criterios de calidad evaluados. Se genera seguimiento pero no se requiere plan de acción inmediato. Se recomienda mantener los estándares alcanzados y documentar las buenas prácticas identificadas.';
    else if(finalPct>=85) concText='Como resultado de la auditoría realizada en '+sede+' durante el mes de '+reportMes+', se obtiene una calificación del '+finalPct+'% clasificándose en RIESGO MEDIO. La sede cumple parcialmente con los criterios evaluados. Se requiere plan de acción y seguimiento para mejorar las áreas con oportunidad de mejora identificadas en el presente informe.';
    else concText='Como resultado de la auditoría realizada en '+sede+' durante el mes de '+reportMes+', se obtiene una calificación del '+finalPct+'% clasificándose en RIESGO ALTO. Se evidencian deficiencias que comprometen la calidad del servicio y la seguridad del paciente. Se requieren acciones de intervención inmediata y plan de mejoramiento a corto plazo para corregir los hallazgos no conformes identificados.';
    doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(CT[0],CT[1],CT[2]);
    const cLines=doc.splitTextToSize(concText,CW-6);
    chk(cLines.length*5.2+8);
    doc.text(cLines,M+3,yPos); yPos+=cLines.length*5.2+6;

    // ── OPORTUNIDADES DE MEJORA (solo si las hay) ──────────────
    if(oportunidades && oportunidades.length > 0){
      sectionBar('OPORTUNIDADES DE MEJORA', CB);
      oportunidades.forEach((om, idx)=>{
        const omLineas = doc.splitTextToSize(om.trim(), CW-12);
        chk(omLineas.length*5+6);
        doc.setFillColor(CB[0],CB[1],CB[2]);
        doc.circle(M+3.5, yPos+3, 2.8, 'F');
        doc.setTextColor(255,255,255); doc.setFontSize(6); doc.setFont('helvetica','bold');
        doc.text(String(idx+1), M+3.5, yPos+3.8, {align:'center'});
        doc.setTextColor(CT[0],CT[1],CT[2]); doc.setFontSize(8.5); doc.setFont('helvetica','normal');
        doc.text(omLineas, M+9, yPos+3);
        yPos += omLineas.length*5+5;
      });
      yPos += 4;
    }

    // Firma — solo el auditor asignado, centrada y más pequeña para mejor resolución
    chk(36);

    // Mapa de firmas por auditor
    const FIRMAS_MAP = {
      'Luis Angel Bolaño Castro': 'https://i.imgur.com/tnzkeRM.jpeg',
      'Maria Clara Pizarro':      'https://i.imgur.com/yHTJ5yd.png',
      'Jennifer Melendez':        'https://i.imgur.com/M1M56No.png',
      'Valentina Jimeno':         'https://i.imgur.com/zPcSbbo.png',
      'Daniel Rodriguez Galofre': 'https://i.imgur.com/mvOQWiB.png',
    };

    async function drawSignature(nombre, xStart, lineY, lineW){
      const firmaUrl = FIRMAS_MAP[nombre];
      if(firmaUrl){
        try{
          const ext = firmaUrl.toLowerCase().endsWith('.jpeg') || firmaUrl.toLowerCase().endsWith('.jpg') ? 'JPEG' : 'PNG';
          const sigImg = await loadImageAsBase64(firmaUrl);
          if(sigImg) doc.addImage(sigImg, ext, xStart+4, lineY-14, lineW-8, 12);
        }catch(e){}
      }
      doc.setDrawColor(180,190,210); doc.setLineWidth(0.4);
      doc.line(xStart, lineY, xStart+lineW, lineY);
      doc.setFontSize(8.5); doc.setFont('helvetica','bold'); doc.setTextColor(CN[0],CN[1],CN[2]);
      doc.text(nombre, xStart+lineW/2, lineY+6, {align:'center'});
      doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(CT[0],CT[1],CT[2]);
      doc.text(AUDITORES_CARGOS[nombre]||'', xStart+lineW/2, lineY+11, {align:'center'});
    }

    const sigW=45, sigY=yPos+18;
    const sigCentroX = (PW - sigW) / 2;

    await drawSignature(auditorAsignado, sigCentroX, sigY, sigW);
    yPos=sigY+18;
    addFooter();

    // ========================================
    // 6) LISTA DE VERIFICACIÓN completa (portada divisora eliminada)
    // ========================================
    doc.addPage(); pageNum++;
    yPos=M;
    doc.setFillColor(CN[0],CN[1],CN[2]); doc.rect(0,0,PW,65,'F');
    doc.setFillColor(255,255,255); doc.roundedRect(M,12,20,20,3,3,'F');
    try{ const li3=document.querySelector('.logo img'); if(li3&&li3.complete) doc.addImage(li3.src,'PNG',M+2,14,16,16); }catch(e){}
    doc.setTextColor(255,255,255); doc.setFontSize(11); doc.setFont('helvetica','bold');
    doc.text('FUNDACIÓN OFTALMOLÓGICA DEL CARIBE',PW/2,22,{align:'center'});
    doc.setFontSize(14); doc.text('LISTA DE VERIFICACIÓN DE AUDITORÍA DE SERVICIO',PW/2,38,{align:'center'});
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.text('Sistema de Evaluación y Control de Calidad',PW/2,45,{align:'center'});
    doc.setFontSize(8); doc.setFont('helvetica','bold');
    doc.text('Código: ',M,56); doc.setFont('helvetica','normal'); doc.text('F-FSYM-823',M+15,56);
    doc.setFont('helvetica','bold'); doc.text('Versión: ',PW/2-10,56); doc.setFont('helvetica','normal'); doc.text('006',PW/2+5,56);
    doc.setFont('helvetica','bold'); doc.text('Vigencia: ',PW-45,56); doc.setFont('helvetica','normal'); doc.text('2026-19-01',PW-25,56);
    yPos=75;
    doc.setFillColor(248,249,250); doc.rect(M,yPos,CW,30,'F');
    doc.setTextColor(CN[0],CN[1],CN[2]); doc.setFontSize(9); doc.setFont('helvetica','bold');
    doc.text('FECHA DE AUDITORÍA:',M+3,yPos+7); doc.setFont('helvetica','normal'); doc.text(fecha,M+3,yPos+12);
    doc.setFont('helvetica','bold'); doc.text('SEDE:',M+3,yPos+19); doc.setFont('helvetica','normal'); doc.text(sede,M+3,yPos+24);
    doc.setFont('helvetica','bold'); doc.text('AUDITOR:',PW/2+5,yPos+19); doc.setFont('helvetica','normal'); doc.text(auditorAsignado,PW/2+5,yPos+24);
    yPos+=37;
    doc.setTextColor(CN[0],CN[1],CN[2]); doc.setFontSize(11); doc.setFont('helvetica','bold');
    doc.text('LISTA DE VERIFICACIÓN',M,yPos); yPos+=7;

    const tData2=[];
    DATA.forEach(section=>{
      tData2.push([{content:section.name,colSpan:6,styles:{fillColor:[102,126,234],textColor:[255,255,255],fontStyle:'bold',fontSize:9,halign:'left'}}]);
      section.items.forEach((item,idx)=>{
        const itemId=makeId(section.name,idx);
        const radios=document.getElementsByName(itemId);
        let sv=''; for(const r of radios) if(r.checked) sv=r.value;
        const allRows=document.querySelectorAll('#tbody tr');
        let obs='';
        for(const row of allRows){ const fc=row.cells[0]; if(fc&&fc.textContent===item){ const oi=row.querySelector('.obs-input'); if(oi) obs=oi.value; break; } }
        tData2.push([item,
          {content: sv==='C'?'C':'', styles:{halign:'center',fontStyle:'bold',textColor:sv==='C'?[46,125,50]:[180,180,180]}},
          {content: sv==='CP'?'CP':'', styles:{halign:'center',fontStyle:'bold',textColor:sv==='CP'?[230,120,0]:[180,180,180]}},
          {content: sv==='NC'?'NC':'', styles:{halign:'center',fontStyle:'bold',textColor:sv==='NC'?[211,47,47]:[180,180,180]}},
          {content: sv==='NA'?'N/A':'', styles:{halign:'center',fontStyle:'bold',textColor:sv==='NA'?[66,133,244]:[180,180,180]}},
          obs]);
      });
      const re=document.getElementById('result-'+makeId(section.name,0));
      const rp=re?re.textContent:'0%';
      tData2.push([{content:'Resultado %',styles:{fillColor:[232,245,233],textColor:[46,125,50],fontStyle:'bold'}},'','','','',{content:rp,styles:{fillColor:[232,245,233],textColor:[46,125,50],fontStyle:'bold',halign:'right'}}]);
    });
    doc.autoTable({startY:yPos,head:[[{content:'ASPECTOS A EVALUAR',styles:{halign:'left'}},'C','CP','NC','N/A','OBSERVACIONES']],body:tData2,theme:'grid',headStyles:{fillColor:[30,60,114],textColor:[255,255,255],fontSize:8,fontStyle:'bold',halign:'center'},bodyStyles:{fontSize:7,textColor:[44,62,80]},columnStyles:{0:{cellWidth:85,halign:'left'},1:{cellWidth:8,halign:'center'},2:{cellWidth:8,halign:'center'},3:{cellWidth:8,halign:'center'},4:{cellWidth:8,halign:'center'},5:{cellWidth:'auto',halign:'left'}},margin:{left:M,right:M},didDrawPage:()=>{pageNum++;}});

    // Results page (list section)
    doc.addPage(); pageNum++; yPos=M;
    doc.setTextColor(CN[0],CN[1],CN[2]); doc.setFontSize(12); doc.setFont('helvetica','bold');
    doc.text('META DE SEGURIDAD',PW/2,yPos,{align:'center'}); yPos+=8;
    doc.setFontSize(10); doc.text('Resultados por Criterio',PW/2,yPos,{align:'center'}); yPos+=10;
    doc.autoTable({startY:yPos,head:[['Criterio','Ponderación','Resultado %','Estado de Cumplimiento']],
      body:results.map(r=>[r.name,`${Math.round(r.weight*100)}%`,`${r.percentage}%`,legendFor(r.percentage)]),
      theme:'grid',headStyles:{fillColor:[30,60,114],textColor:[255,255,255],fontSize:9,fontStyle:'bold',halign:'center'},
      bodyStyles:{fontSize:8,textColor:[44,62,80]},
      columnStyles:{0:{cellWidth:65,halign:'left'},1:{cellWidth:30,halign:'center'},2:{cellWidth:30,halign:'center'},3:{cellWidth:'auto',halign:'center'}},
      margin:{left:M,right:M}});
    yPos=doc.lastAutoTable.finalY+15;
    let sBG2; if(finalPct>=92)sBG2=[76,175,80]; else if(finalPct>=85)sBG2=[255,152,0]; else sBG2=[244,67,54];
    if(yPos+55>PH-M){ doc.addPage(); pageNum++; yPos=M; }
    doc.setFillColor(sBG2[0],sBG2[1],sBG2[2]);
    doc.roundedRect(M+10,yPos,CW-20,45,3,3,'F');
    doc.setTextColor(255,255,255); doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('RESULTADO FINAL DE AUDITORÍA',PW/2,yPos+10,{align:'center'});
    doc.setFontSize(32); doc.text(`${finalPct}%`,PW/2,yPos+26,{align:'center'});
    doc.setFontSize(12); doc.text(legendFor(finalPct).toUpperCase(),PW/2,yPos+38,{align:'center'});
    yPos+=55;
    if(yPos+60>PH-M){ doc.addPage(); pageNum++; yPos=M; }
    doc.setTextColor(CN[0],CN[1],CN[2]); doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('ESCALA DE CLASIFICACIÓN DE RIESGO',PW/2,yPos,{align:'center'}); yPos+=8;
    const li4=[
      {c:[76,175,80],t:'Mayor o igual a 92% – Riesgo Bajo. Cumple. Genera seguimiento. No genera plan de acción.'},
      {c:[255,152,0],t:'Mayor o igual a 85% – Riesgo Medio. Cumple parcialmente con los criterios evaluados y se requiere plan de acción y seguimiento.'},
      {c:[244,67,54],t:'Menor de 85% – Riesgo Alto. Se requiere acciones de intervención inmediata y plan de mejoramiento a corto plazo.'}
    ];
    li4.forEach(leg=>{
      if(yPos+14>PH-M){ doc.addPage(); pageNum++; yPos=M; }
      doc.setFillColor(248,248,248); doc.roundedRect(M,yPos,CW,12,2,2,'F');
      doc.setFillColor(leg.c[0],leg.c[1],leg.c[2]); doc.circle(M+6,yPos+6,3,'F');
      doc.setTextColor(44,62,80); doc.setFontSize(8); doc.setFont('helvetica','normal');
      const lines=doc.splitTextToSize(leg.t,CW-16);
      doc.text(lines,M+12,yPos+4+(12-lines.length*3.5)/2+1.5);
      yPos+=16;
    });
    yPos+=5;

    // Charts
    try{
      await new Promise(r=>setTimeout(r,200));
      const cc2=document.getElementById('categoryChart');
      if(cc2&&categoryChart){
        if(yPos+75>PH-M){ doc.addPage(); pageNum++; yPos=M; }
        const img=await captureChart(cc2,categoryChart);
        doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(CN[0],CN[1],CN[2]);
        doc.text('Resultados por Categoría',M,yPos); yPos+=5;
        const cw=CW*0.85, ch=60, xo=(CW-cw)/2;
        doc.addImage(img,'PNG',M+xo,yPos,cw,ch,'ccat2','SLOW'); yPos+=ch+12;
      }
      const dc2=document.getElementById('distributionChart');
      if(dc2&&distributionChart){
        if(yPos+75>PH-M){ doc.addPage(); pageNum++; yPos=M; }
        const img2=await captureChart(dc2,distributionChart);
        doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(CN[0],CN[1],CN[2]);
        doc.text('Distribución de Evaluaciones',M,yPos); yPos+=5;
        const cw2=CW*0.85, ch2=60, xo2=(CW-cw2)/2;
        doc.addImage(img2,'PNG',M+xo2,yPos,cw2,ch2,'cdist2','SLOW');
      }
    }catch(e){ console.warn('Charts L',e); }

    // Page footers for all pages
    const totalPages=doc.internal.getNumberOfPages();
    doc.setFontSize(8); doc.setTextColor(128,128,128); doc.setFont('helvetica','normal');
    for(let i=1;i<=totalPages;i++){
      doc.setPage(i);
      doc.text(`Página ${i} de ${totalPages}`,PW/2,PH-5,{align:'center'});
    }

    hideLoading();
    doc.save(`Informe_Auditoria_${sede.replace(/\s+/g,'_')}_${fecha.replace(/-/g,'')}.pdf`);
    showNotification('✅ Informe completo generado exitosamente','success');

  } catch(e){
    hideLoading(); console.error(e);
    showNotification('Error al generar informe: '+e.message,'error');
  }
}

// ============================================================
// RESET
// ============================================================
function resetForm(){
  if(!confirm('¿Restablecer el formulario? Se perderán todos los datos ingresados.')) return;
  document.getElementById('fecha').value=new Date().toISOString().split('T')[0];
  document.getElementById('sede').value='';
  document.getElementById('auditor').value='';
  document.querySelectorAll('input[type="radio"]').forEach(r=>r.checked=false);
  document.querySelectorAll('.obs-input').forEach(i=>i.value='');
  evidenceStore={};
  omStore={};
  clearLocalStorage();
  idbClear();
  document.querySelectorAll('.evidence-btn').forEach(btn=>{ btn.classList.remove('has-evidence'); const b=btn.querySelector('.evidence-count'); if(b)b.remove(); });
  document.querySelectorAll('.om-btn').forEach(btn=>{ btn.classList.remove('has-om'); btn.innerHTML='<i class="fas fa-lightbulb"></i><span>OM</span>'; });
  computeResults();
  window.scrollTo({top:0,behavior:'smooth'});
  showNotification('Formulario restablecido','success');
}

// ============================================================
// SAVE AUDIT
// ============================================================
async function guardarAuditoria(){
  try{
    showNotification('Guardando auditoría...','info');
    const resultado=computeResults();
    const fecha=document.getElementById('fecha').value;
    const sede=document.getElementById('sede').value;
    const auditor=document.getElementById('auditor').value;
    if(!fecha||!sede||!auditor){ showNotification('Complete todos los campos: Fecha, Sede y Auditor','error'); return; }
    const items=[];
    DATA.forEach(section=>{
      section.items.forEach((item,idx)=>{
        const itemId=makeId(section.name,idx);
        const radios=document.getElementsByName(itemId);
        let valor=''; radios.forEach(r=>{ if(r.checked) valor=r.value; });
        let obs='';
        if(radios.length>0){ const fila=radios[0].closest('tr'); const oi=fila?fila.querySelector('.obs-input'):null; if(oi) obs=oi.value; }
        const evCount=evidenceStore[itemId]?evidenceStore[itemId].length:0;
        const oportunidades=omStore[itemId]||[];
        items.push({categoria:section.name,item,resultado:valor||'Sin evaluar',observacion:obs,evidencias:evCount,oportunidades});
      });
    });
    const fStr=fecha.replace(/-/g,'');
    const cons=Math.floor(Math.random()*10000).toString().padStart(4,'0');
    const auditID=`AuditoriaServicio-${fStr}-${cons}`;
    const payload={id:auditID,fecha,sede,auditor,porcentaje_final:resultado.finalPct,estado:legendFor(resultado.finalPct),timestamp:new Date().toISOString(),items,oportunidades_mejora:collectAllOMs()};
    await fetch('https://script.google.com/macros/s/AKfycby9YVrSoK38cY8z8zOB-dnzrFdgbsQwWbAIQnMtyQS1TH-7PQ7CLEbV63GKK633Gl-_OQ/exec',{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    showNotification(`✔ Auditoría guardada – ID: ${auditID}`,'success');
  }catch(e){ showNotification('Error al guardar: '+e.message,'error'); }
}

// ============================================================
// CHARTS
// ============================================================
function initializeCharts(){
  const ctx1=document.getElementById('categoryChart').getContext('2d');
  const ctx2=document.getElementById('distributionChart').getContext('2d');
  const categoryColors=['rgba(30,60,114,0.9)','rgba(42,82,152,0.9)','rgba(33,150,243,0.9)','rgba(66,165,245,0.9)','rgba(100,181,246,0.9)','rgba(144,202,249,0.9)'];
  categoryChart=new Chart(ctx1,{type:'bar',data:{labels:DATA.map(s=>s.name),datasets:[{label:'Porcentaje de Cumplimiento',data:DATA.map(()=>0),backgroundColor:categoryColors,borderColor:categoryColors.map(c=>c.replace('0.9','1')),borderWidth:2,borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw}%`}}},scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%',font:{size:11}},grid:{color:'rgba(0,0,0,0.05)'}},x:{grid:{display:false},ticks:{font:{size:10}}}}},plugins:[{afterDatasetsDraw(chart){const ctx=chart.ctx;chart.data.datasets.forEach((ds,i)=>{const meta=chart.getDatasetMeta(i);if(!meta.hidden){meta.data.forEach((el,idx)=>{const v=ds.data[idx];if(v>0){ctx.fillStyle='#1e3c72';ctx.font=Chart.helpers.fontString(12,'bold','Arial');ctx.textAlign='center';ctx.textBaseline='bottom';const pos=el.tooltipPosition();ctx.fillText(v+'%',pos.x,pos.y-(v>=100?8:5));}});}});}}]});
  distributionChart=new Chart(ctx2,{type:'doughnut',data:{labels:['Cumplimiento (C)','Cumplimiento Parcial (CP)','No Cumple (NC)','No Aplica (N/A)'],datasets:[{data:[0,0,0,0],backgroundColor:['rgba(46,125,50,0.85)','rgba(251,192,45,0.85)','rgba(211,47,47,0.85)','rgba(66,133,244,0.85)'],borderColor:['rgba(46,125,50,1)','rgba(251,192,45,1)','rgba(211,47,47,1)','rgba(66,133,244,1)'],borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'bottom',labels:{padding:15,font:{size:11}}},tooltip:{callbacks:{label:ctx=>{const v=ctx.raw||0;const tot=ctx.dataset.data.reduce((a,b)=>a+b,0);const p=tot>0?Math.round((v/tot)*100):0;return `${ctx.label}: ${v} (${p}%)`;}}}}},plugins:[{afterDatasetsDraw(chart){const ctx=chart.ctx;chart.data.datasets.forEach((ds,i)=>{const meta=chart.getDatasetMeta(i);if(!meta.hidden){meta.data.forEach((el,idx)=>{const d=ds.data[idx];const tot=ds.data.reduce((a,b)=>a+b,0);const p=tot>0?Math.round((d/tot)*100):0;if(p>0){ctx.shadowColor='rgba(0,0,0,0.5)';ctx.shadowBlur=4;ctx.fillStyle='#ffffff';ctx.font=Chart.helpers.fontString(14,'bold','Arial');ctx.textAlign='center';ctx.textBaseline='middle';const pos=el.tooltipPosition();ctx.fillText(p+'%',pos.x,pos.y);ctx.shadowColor='transparent';ctx.shadowBlur=0;}});}});}}]});
}
function updateCharts(results,finalPct){
  if(categoryChart){ categoryChart.data.datasets[0].data=results.map(r=>r.percentage); categoryChart.update(); }
  let c=0,cp=0,nc=0,na=0;
  DATA.forEach(section=>section.items.forEach((_,idx)=>{
    const radios=document.getElementsByName(makeId(section.name,idx));
    let sv=''; for(const r of radios) if(r.checked) sv=r.value;
    if(sv==='C')c++; else if(sv==='CP')cp++; else if(sv==='NC')nc++; else if(sv==='NA')na++;
  }));
  if(distributionChart){ distributionChart.data.datasets[0].data=[c,cp,nc,na]; distributionChart.update(); }
}

// ============================================================
// PERSISTENCIA LOCAL — auto-guarda en localStorage en cada cambio
// Funciona en Safari/iPhone al recargar o cerrar la pestaña
// ============================================================
const LS_KEY = 'foca_auditoria_draft';
const IDB_NAME = 'foca_evidencias';
const IDB_STORE = 'fotos';
let _idb = null;

// ── IndexedDB: abrir / inicializar ──────────────────────────
function idbOpen() {
  return new Promise((resolve, reject) => {
    if (_idb) { resolve(_idb); return; }
    const req = indexedDB.open(IDB_NAME, 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore(IDB_STORE);
    };
    req.onsuccess = e => { _idb = e.target.result; resolve(_idb); };
    req.onerror   = e => reject(e.target.error);
  });
}

async function idbSet(key, value) {
  try {
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, 'readwrite');
      tx.objectStore(IDB_STORE).put(value, key);
      tx.oncomplete = resolve;
      tx.onerror = e => reject(e.target.error);
    });
  } catch(e) { console.warn('idbSet error:', e); }
}

async function idbGet(key) {
  try {
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, 'readonly');
      const req = tx.objectStore(IDB_STORE).get(key);
      req.onsuccess = e => resolve(e.target.result);
      req.onerror   = e => reject(e.target.error);
    });
  } catch(e) { console.warn('idbGet error:', e); return null; }
}

async function idbDelete(key) {
  try {
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, 'readwrite');
      tx.objectStore(IDB_STORE).delete(key);
      tx.oncomplete = resolve;
      tx.onerror = e => reject(e.target.error);
    });
  } catch(e) { console.warn('idbDelete error:', e); }
}

async function idbClear() {
  try {
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, 'readwrite');
      tx.objectStore(IDB_STORE).clear();
      tx.oncomplete = resolve;
      tx.onerror = e => reject(e.target.error);
    });
  } catch(e) { console.warn('idbClear error:', e); }
}

// ── Guardar fotos de un ítem en IndexedDB ───────────────────
async function saveEvidenceToIDB(itemId) {
  const photos = evidenceStore[itemId];
  if (photos && photos.length > 0) {
    await idbSet('ev_' + itemId, photos);
  } else {
    await idbDelete('ev_' + itemId);
  }
}

// ── Restaurar todas las fotos desde IndexedDB ───────────────
async function restoreEvidenceFromIDB() {
  try {
    const db = await idbOpen();
    const keys = await new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, 'readonly');
      const req = tx.objectStore(IDB_STORE).getAllKeys();
      req.onsuccess = e => resolve(e.target.result);
      req.onerror   = e => reject(e.target.error);
    });
    for (const key of keys) {
      if (!key.startsWith('ev_')) continue;
      const itemId = key.replace('ev_', '');
      const photos = await idbGet(key);
      if (photos && photos.length > 0) {
        evidenceStore[itemId] = photos;
        refreshEvidenceButton(itemId);
      }
    }
  } catch(e) { console.warn('restoreEvidence error:', e); }
}

function saveToLocalStorage() {
  try {
    const radios = {};
    document.querySelectorAll('input[type="radio"]:checked').forEach(r => {
      radios[r.name] = r.value;
    });
    const obs = {};
    document.querySelectorAll('#tbody tr').forEach(row => {
      const fc = row.cells && row.cells[0];
      const oi = row.querySelector('.obs-input');
      if (fc && oi && oi.value) obs[fc.textContent.trim()] = oi.value;
    });
    const draft = {
      fecha:   document.getElementById('fecha').value,
      sede:    document.getElementById('sede').value,
      auditor: document.getElementById('auditor').value,
      radios,
      obs,
      omStore: JSON.parse(JSON.stringify(omStore)),
    };
    localStorage.setItem(LS_KEY, JSON.stringify(draft));
  } catch(e) { console.warn('Auto-save error:', e); }
}

function restoreFromLocalStorage() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return false;
    const draft = JSON.parse(raw);

    if (draft.fecha)   document.getElementById('fecha').value   = draft.fecha;
    if (draft.sede)    document.getElementById('sede').value    = draft.sede;
    if (draft.auditor) document.getElementById('auditor').value = draft.auditor;

    if (draft.radios) {
      Object.entries(draft.radios).forEach(([name, val]) => {
        const r = document.querySelector(`input[name="${name}"][value="${val}"]`);
        if (r) r.checked = true;
      });
    }

    if (draft.obs) {
      document.querySelectorAll('#tbody tr').forEach(row => {
        const fc = row.cells && row.cells[0];
        const oi = row.querySelector('.obs-input');
        if (fc && oi && draft.obs[fc.textContent.trim()]) {
          oi.value = draft.obs[fc.textContent.trim()];
        }
      });
    }

    if (draft.omStore) {
      omStore = draft.omStore;
      Object.keys(omStore).forEach(itemId => {
        if (omStore[itemId] && omStore[itemId].length > 0) refreshOmButton(itemId);
      });
    }

    return true;
  } catch(e) { console.warn('Restore error:', e); return false; }
}

function clearLocalStorage() {
  try { localStorage.removeItem(LS_KEY); } catch(e) {}
}

document.addEventListener('DOMContentLoaded',()=>{
  renderChecklist();

  // Restaurar borrador si existe
  const restored = restoreFromLocalStorage();
  if (!restored) {
    document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
  } else {
    showNotification('Borrador restaurado automáticamente ✓', 'info');
  }

  // Restaurar fotos desde IndexedDB (async, no bloquea)
  restoreEvidenceFromIDB();

  computeResults();
  initializeCharts();

  document.getElementById('generate-report').addEventListener('click', openReportModal);
  document.getElementById('export-pdf').addEventListener('click', exportToPDF);
  document.getElementById('save-audit').addEventListener('click', guardarAuditoria);
  document.getElementById('reset-form').addEventListener('click', resetForm);

  // Auto-guardar en cada cambio de radio u observación
  document.body.addEventListener('change', e => {
    if (e.target.type === 'radio' || e.target.classList.contains('obs-input')) {
      computeResults();
      saveToLocalStorage();
    }
  });
  // Auto-guardar al escribir en observaciones (input, no solo change)
  document.body.addEventListener('input', e => {
    if (e.target.classList.contains('obs-input')) saveToLocalStorage();
  });
  // Auto-guardar al cambiar campos meta
  document.querySelectorAll('.meta-field input, .meta-field select').forEach(el => {
    el.addEventListener('change', () => { computeResults(); saveToLocalStorage(); });
  });

  window.onclick = e => {
    if (e.target === document.getElementById('evidenceModal')) closeEvidenceModal();
    if (e.target === document.getElementById('reportModal')) closeReportModal();
    if (e.target === document.getElementById('omInlineModal')) omInlineCerrar();
  };
});
</script>
</body>
</html>
