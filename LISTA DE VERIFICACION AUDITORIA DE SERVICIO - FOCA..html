<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Lista de Verificación de Auditoría - FOCA v2.0</title>
<!-- Biblioteca para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
<!-- html2canvas para captura exacta de HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Íconos para botones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    color: #2c3e50;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
  }
  
  .card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    overflow: hidden;
    margin-bottom: 20px;
  }
  
  /* Header Styles */
  .header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 24px;
    position: relative;
    overflow: hidden;
  }
  
  .header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: pulse 8s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }
  
  .header-content {
    position: relative;
    z-index: 1;
  }
  
  .logo-section {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
  }
  
  .logo {
    width: 70px;
    height: 70px;
    background: white;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    overflow: hidden;
    padding: 8px;
  }
  
  .logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .org-name {
    flex: 1;
    font-size: 18px;
    font-weight: 600;
    line-height: 1.3;
  }
  
  .title-section {
    text-align: center;
    margin-bottom: 20px;
  }
  
  .main-title {
    font-size: 22px;
    font-weight: 700;
    margin: 0 0 8px 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .subtitle {
    font-size: 13px;
    opacity: 0.9;
    margin: 0;
  }
  
  .header-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-top: 20px;
  }
  
  .header-item {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    border-radius: 10px;
    padding: 12px;
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  .header-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    opacity: 0.9;
  }
  
  .header-value {
    font-size: 15px;
    font-weight: 700;
    color: #fff;
  }
  
  /* Meta Section */
  .meta-section {
    padding: 24px;
    background: #f8f9fa;
  }
  
  .meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }
  
  .meta-field {
    position: relative;
  }
  
  .meta-field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #1e3c72;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .meta-field input,
  .meta-field select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: white;
  }
  
  .meta-field input:focus,
  .meta-field select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .meta-field select {
    cursor: pointer;
  }
  
  /* Checklist Table */
  .table-container {
    padding: 24px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 14px;
  }
  
  thead {
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  th {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 14px 10px;
    text-align: center;
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
  }
  
  th:first-child {
    border-top-left-radius: 10px;
    text-align: left;
  }
  
  th:last-child {
    border-top-right-radius: 10px;
  }
  
  td {
    padding: 12px 10px;
    border-bottom: 1px solid #e0e0e0;
    background: white;
  }
  
  tr:hover td {
    background: #f8f9fa;
  }
  
  .section-title {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    font-weight: 700;
    font-size: 14px;
    padding: 14px !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .result-row td {
    background: #e8f5e9 !important;
    font-weight: 700;
    color: #2e7d32;
    font-size: 15px;
  }
  
  .radio-cell {
    text-align: center;
  }
  
  .radio-cell input[type="radio"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #667eea;
  }
  
  .obs-input {
    width: 100%;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 8px;
    font-size: 13px;
    transition: border-color 0.3s ease;
  }
  
  .obs-input:focus {
    outline: none;
    border-color: #667eea;
  }

  /* Evidence Upload Button */
  .evidence-cell {
    text-align: center;
    position: relative;
  }

  .evidence-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
  }

  .evidence-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .evidence-btn i {
    font-size: 14px;
  }

  .evidence-btn.has-evidence {
    background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
  }

  .evidence-btn.has-evidence:hover {
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
  }

  .evidence-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #f44336;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .evidence-input {
    display: none;
  }

  /* Evidence Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    position: relative;
    background-color: #fff;
    margin: 3% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
  }

  .close {
    color: white;
    font-size: 32px;
    font-weight: 300;
    cursor: pointer;
    transition: color 0.3s ease;
    line-height: 1;
  }

  .close:hover {
    color: #f44336;
  }

  .modal-body {
    padding: 24px;
    max-height: calc(85vh - 140px);
    overflow-y: auto;
  }

  .evidence-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }

  .evidence-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }

  .evidence-item:hover {
    transform: scale(1.05);
  }

  .evidence-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
  }

  .evidence-remove {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  .evidence-remove:hover {
    background: #d32f2f;
    transform: scale(1.1);
  }

  .upload-area {
    border: 2px dashed #667eea;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .upload-area:hover {
    background: #e3f2fd;
    border-color: #2a5298;
  }

  .upload-area i {
    font-size: 48px;
    color: #667eea;
    margin-bottom: 16px;
  }

  .upload-area p {
    margin: 0;
    color: #2c3e50;
    font-weight: 600;
  }
  
  /* Results Section */
  .results-section {
    padding: 24px;
    background: #f8f9fa;
  }
  
  .results-title {
    font-size: 18px;
    font-weight: 700;
    color: #1e3c72;
    margin: 0 0 20px 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .badge {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .weights-table {
    margin-bottom: 24px;
  }
  
  .weights-table tfoot td {
    background: #1e3c72;
    color: white;
    font-weight: 700;
    padding: 16px;
  }
  
  /* Final Score */
  .final-score {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    border-radius: 16px;
    padding: 32px;
    text-align: center;
    color: white;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    margin-bottom: 20px;
    transition: background 0.5s ease;
  }
  
  .final-score-label {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    opacity: 0.9;
  }
  
  .final-score-value {
    font-size: 64px;
    font-weight: 800;
    margin: 0;
    text-shadow: 0 4px 12px rgba(0,0,0,0.3);
    background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .final-score-status {
    font-size: 18px;
    font-weight: 600;
    margin-top: 12px;
    padding: 10px 24px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    display: inline-block;
  }
  
  .legend-box {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-top: 24px;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .legend-item:last-child {
    border-bottom: none;
  }
  
  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 12px;
    flex-shrink: 0;
  }
  
  .legend-text {
    font-size: 13px;
    color: #2c3e50;
    flex: 1;
  }
  
  .legend-text strong {
    font-weight: 700;
    color: #1e3c72;
  }
  
  /* Panel de Botones de Exportación */
  .export-buttons-container {
    background: white;
    padding: 20px;
    border-top: 2px solid #e0e0e0;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .export-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 24px;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 200px;
    justify-content: center;
  }
  
  .export-btn i {
    font-size: 18px;
  }
  
  .btn-pdf {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
  }
  
  .btn-pdf:hover {
    background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(244, 67, 54, 0.3);
  }

  .btn-report {
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(156, 39, 176, 0.2);
  }
  
  .btn-report:hover {
    background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(156, 39, 176, 0.3);
  }
  
  .btn-reset {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
  }
  
  .btn-reset:hover {
    background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(255, 152, 0, 0.3);
  }

  .btn-save {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
  }
  
  .btn-save:hover {
    background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(33, 150, 243, 0.3);
  }

  .btn-disabled {
    opacity: 0.5;
    cursor: not-allowed !important;
    pointer-events: none;
  }
  
  /* Gráficos de Visualización */
  .charts-section {
    margin-top: 30px;
  }
  
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .chart-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  
  .chart-title {
    font-size: 16px;
    font-weight: 700;
    color: #1e3c72;
    margin: 0 0 15px 0;
    text-align: center;
  }
  
  .chart-wrapper {
    position: relative;
    height: 250px;
  }
  
  /* Notificaciones */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    transform: translateY(100px);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  
  .notification.show {
    transform: translateY(0);
    opacity: 1;
  }
  
  .notification-success {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
  }
  
  .notification-error {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
  }
  
  .notification-info {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
  }

  /* Loading Spinner */
  .loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }

  .loading-overlay.show {
    display: flex;
  }

  .loading-content {
    text-align: center;
    color: white;
  }

  .spinner {
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-text {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .loading-subtext {
    font-size: 14px;
    opacity: 0.8;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .container { padding: 12px; }
    .header { padding: 20px 16px; }
    .logo { width: 60px; height: 60px; font-size: 20px; }
    .org-name { font-size: 15px; }
    .main-title { font-size: 18px; }
    .subtitle { font-size: 12px; }
    .header-grid { grid-template-columns: repeat(2, 1fr); }
    .table-container { padding: 16px; }
    
    table { font-size: 12px; }
    th, td { padding: 10px 6px; }
    th { font-size: 11px; }
    
    .section-title { font-size: 12px; }
    .final-score { padding: 24px 16px; }
    .final-score-value { font-size: 48px; }
    .final-score-status { font-size: 15px; }
    
    th:last-child, td:last-child { 
      min-width: 150px;
    }
    
    .export-buttons-container {
      flex-direction: column;
      align-items: center;
    }
    
    .export-btn {
      width: 100%;
      max-width: 300px;
    }
    
    .charts-grid {
      grid-template-columns: 1fr;
    }

    .modal-content {
      width: 95%;
      margin: 5% auto;
    }
  }
  
  @media (max-width: 480px) {
    .header-grid { grid-template-columns: 1fr; }
    .meta-grid { grid-template-columns: 1fr; }
    th, td { padding: 8px 4px; font-size: 11px; }
    .radio-cell input[type="radio"] { width: 18px; height: 18px; }
    
    .export-btn {
      min-width: auto;
      width: 100%;
      padding: 12px 16px;
      font-size: 14px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="header-content">
          <div class="logo-section">
            <div class="logo">
              <img src="https://i.imgur.com/3WZzeT6.png" alt="Logo FOCA">
            </div>
            <div class="org-name">FUNDACIÓN OFTALMOLÓGICA DEL CARIBE</div>
          </div>
          <div class="title-section">
            <h1 class="main-title">LISTA DE VERIFICACIÓN DE AUDITORÍA DE SERVICIO</h1>
            <p class="subtitle">Sistema de Evaluación y Control de Calidad</p>
          </div>
          <div class="header-grid">
            <div class="header-item">
              <div class="header-label">Código</div>
              <div class="header-value">F-FSYM-823</div>
            </div>
            <div class="header-item">
              <div class="header-label">Versión</div>
              <div class="header-value">006</div>
            </div>
            <div class="header-item">
              <div class="header-label">Vigencia</div>
              <div class="header-value">2026-19-01</div>
            </div>
          </div>
        </div>
      </div>

      <div class="meta-section">
        <div class="meta-grid">
          <div class="meta-field">
            <label>Fecha de Auditoría</label>
            <input type="date" id="fecha">
          </div>
          <div class="meta-field">
            <label>Sede</label>
            <select id="sede">
              <option value="">Seleccione la sede</option>
              <option value="FOCA VIVA">FOCA VIVA</option>
              <option value="FOCA ALKARAWI">FOCA ALKARAWI</option>
              <option value="FOCA SEDE 2">FOCA SEDE 2</option>
              <option value="FOCA SEDE 51B">FOCA SEDE 51B</option>
              <option value="FOCA ALEGRA">FOCA ALEGRA</option>
              <option value="FOCA VALLEDUPAR">FOCA VALLEDUPAR</option>
              <option value="FOCA RIOHACHA">FOCA RIOHACHA</option>
              <option value="FOCA SANTA MARTA">FOCA SANTA MARTA</option>
              <option value="FOCA SANTA MARTA BURANO">FOCA SANTA MARTA BURANO</option>
              <option value="FOCA CARTAGENA">FOCA CARTAGENA</option>
              <option value="FOCA BARANOA">FOCA BARANOA</option>
              <option value="FOCA GALAPA">FOCA GALAPA</option>
              <option value="FOCA SABANALARGA 1">FOCA SABANALARGA 1</option>
              <option value="FOCA SABANALARGA 2">FOCA SABANALARGA 2</option>
              <option value="FOCA MALAMBO">FOCA MALAMBO</option>
            </select>
          </div>
          <div class="meta-field">
            <label>Auditor</label>
            <select id="auditor">
              <option value="">Seleccione el auditor</option>
              <option value="Luis Angel Bolaño Castro">Luis Angel Bolaño Castro</option>
              <option value="Maria Clara Pizarro">Maria Clara Pizarro</option>
              <option value="Daniel Rodriguez Galofre">Daniel Rodriguez Galofre</option>
              <option value="Valentina Jimeno">Valentina Jimeno</option>
            </select>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table id="checklist">
          <thead>
            <tr>
              <th style="width:35%;">ASPECTOS A EVALUAR</th>
              <th style="width:7%;">C</th>
              <th style="width:7%;">CP</th>
              <th style="width:7%;">NC</th>
              <th style="width:7%;">N/A</th>
              <th style="width:10%;">EVIDENCIA</th>
              <th style="width:27%;">OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="results-section">
        <h2 class="results-title">
          META DE SEGURIDAD
          <span class="badge">Resultados por Criterio</span>
        </h2>
        
        <table class="weights-table" id="weights">
          <thead>
            <tr>
              <th style="width:30%;">Criterio</th>
              <th style="width:15%;">Ponderación</th>
              <th style="width:15%;">Resultado %</th>
              <th>Estado de Cumplimiento</th>
            </tr>
          </thead>
          <tbody id="weights-body"></tbody>
        </table>

        <div class="final-score">
          <div class="final-score-label">Resultado Final de Auditoría</div>
          <div class="final-score-value" id="total-pct">0%</div>
          <div class="final-score-status" id="final-status">Sin evaluar</div>
          
          <div class="legend-box">
            <div class="legend-item">
              <div class="legend-dot" style="background: #4caf50;"></div>
              <div class="legend-text"><strong>Mayor o igual a 92%</strong> – Riesgo Bajo. Cumple. Genera seguimiento. No genera plan de acción</div>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: #ff9800;"></div>
              <div class="legend-text"><strong>Mayor o igual a 85%</strong> – Riesgo Medio. Cumple parcialmente con los criterios evaluados y se requiere plan de acción y seguimiento</div>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: #f44336;"></div>
              <div class="legend-text"><strong>Menor de 85%</strong> – Riesgo Alto. Se requiere acciones de intervención inmediata y plan de mejoramiento a corto plazo</div>
            </div>
          </div>
        </div>

        <div class="charts-section">
          <h2 class="results-title">
            <i class="fas fa-chart-bar"></i>
            Visualización de Resultados
          </h2>
          
          <div class="charts-grid">
            <div class="chart-container">
              <h3 class="chart-title">Resultados por Categoría</h3>
              <div class="chart-wrapper">
                <canvas id="categoryChart"></canvas>
              </div>
            </div>
            
            <div class="chart-container">
              <h3 class="chart-title">Distribución de Evaluaciones</h3>
              <div class="chart-wrapper">
                <canvas id="distributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="export-buttons-container">
        <button class="export-btn btn-report" id="generate-report">
          <i class="fas fa-file-pdf"></i>
          Generar Informe Completo
        </button>

        <button class="export-btn btn-pdf" id="export-pdf">
          <i class="fas fa-file-export"></i>
          Exportar Lista Verificación
        </button>
        
        <button class="export-btn btn-save" id="save-audit">
          <i class="fas fa-save"></i>
          Guardar Auditoría
        </button>
        
        <button class="export-btn btn-reset" id="reset-form">
          <i class="fas fa-redo-alt"></i>
          Restablecer Formulario
        </button>
      </div>
    </div>
  </div>

  <!-- Evidence Modal -->
  <div id="evidenceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Evidencia Fotográfica</h2>
        <span class="close" onclick="closeEvidenceModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="upload-area" onclick="document.getElementById('modal-file-input').click()">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Click para agregar fotos</p>
          <input type="file" id="modal-file-input" class="evidence-input" accept="image/*" multiple onchange="handleEvidenceUpload(event)">
        </div>
        <div id="evidence-preview" class="evidence-preview"></div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text" id="loading-text">Generando informe...</div>
      <div class="loading-subtext" id="loading-subtext">Por favor espere</div>
    </div>
  </div>

  <div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-text">Operación completada con éxito</span>
  </div>

<script>
const DATA = [
  {
    "name": "ADMISIÓN",
    "weight": 0.25,
    "items": [
      "Verificar el saludo de bienvenida al usuario",
      "Verificar si el tiempo de atención está en el estándar establecido (3 a 5 min)",
      "Verificar identidad del usuario a través de solicitud de documento de identidad",
      "Verificar actualización de datos del paciente",
      "Verificación del servicio a prestar",
      "Verificar diligenciamiento correcto del nivel y valor de cuota moderadora / copago",
      "Verificar comprensión de la información, incluyendo dudas por parte del paciente/familiar",
      "Verificar invitación al buzón de sugerencias al paciente",
      "Verificar cumplimiento de la caja preferencial (que se encuentre demarcada con movilidad reducida, mujeres embarazadas y niños de brazos)"
    ]
  },
  {
    "name": "PRESTACIÓN DEL SERVICIO",
    "weight": 0.2,
    "items": [  
      "El personal de orientación en el Smart Queue brinda información clara y completa, realiza educación sobre el uso de la herramienta y asigna el turno correspondiente al servicio requerido y mantiene trato respetuoso al usuario",
      "Verificar saludo y presentación por parte del equipo médico",
      "Verificar educación al paciente y/o cuidador sobre riesgos y beneficios de la dilatación ocular",
      "Verificar si el tiempo de atención está en el estándar establecido. Oftalmología (Max 20min - Min 10) Optometría (Max 10Min- 5Min)",
      "Verificar que el profesional de salud entregue y explique de manera clara al paciente el diagnóstico, el plan de tratamiento, la prescripción médica, las remisiones, las órdenes de estudios diagnósticos y, cuando aplique, la indicación de cirugía, asegurando su comprensión",
      "Verificar entrega efectiva de copias impresas del ordenamiento médico, incluye recomendaciones universales que incluya: verificación de la correcta identificación del paciente y el tiempo de entrega de orden (10min - 15max)"
    ]
  },
  {
    "name": "SEGURIDAD DEL PACIENTE",
    "weight": 0.15,
    "items": [
      "Verificar que los medicamentos en uso se encuentren rotulados y no superen los 30 días de apertura",
      "Verificar que los insumos se encuentran debidamente rotulados incluyendo: nombre del producto, fecha de apertura, fecha de vencimiento y número de lote",
      "Verificar instalación de señalética de seguridad del paciente en consultorio y baños: QR, correcto lavado de manos y los 5 momentos de lavado de manos",
      "Verificar la correcta aplicación del protocolo de lavado de manos durante la consulta",
      "Validar si existe alguna condición o situación que pueda representar un riesgo para la seguridad de los pacientes",
      "Verificar que los formatos de registro de temperatura y humedad estén correctamente diligenciados y al día"
    ]
  },
  {
    "name": "AMBIENTE HUMANIZADO",
    "weight": 0.2,
    "items": [
      "Verificar el confort térmico en áreas como SIAU, sala de espera y consulta externa al momento de la presente auditoría",
      "Verificar la existencia de ruido y/o información visual exagerada en las áreas inspeccionadas",
      "Verificar disponibilidad de sillas de acuerdo al número de pacientes al momento de realizar la auditoría",
      "Verificar señalización de áreas y personas claves para las actividades de: Ingreso, admisión y consulta",
      "Verificación de segregación de residuos",
      "Verificación de limpieza, organización y cumplimiento del cuarto de residuos según los estándares de habilitación",
      "Verificación de limpieza del puesto de trabajo (asesores auxiliares, coordinador, sede)",
      "Verificación de limpieza en el área de sala de espera",
      "Verificación de limpieza en los consultorios elegidos por el auditor",
      "Verificación de limpieza en los baños de la institución",
      "Verificación de limpieza y orden en la zona del exterior de la sede",
      "Verificar instalación y funcionamiento del sistema de alarma en los baños para discapacitados"
    ]
  },
  {
    "name": "PQRS",
    "weight": 0.1,
    "items": [
      "Verificar buzón encendido",
      "Verificar papelería en el buzón",
      "Verificar funcionamiento del aplicativo",
      "Solicitar y verificar últimas aperturas de Buzón en el mes"
    ]
  },
  {
    "name": "PROTOCOLO DE IMAGEN",
    "weight": 0.1,
    "items": [
      "Verificar porte individual de carnet",
      "Verificar uso de accesorios discretos",
      "Verificar restricciones en usos de abrigos, bufandas y buzos de colores diferentes al negro",
      "Revisar uñas, peinado y maquillaje acorde al protocolo de imagen"
    ]
  }
];

const SCORE = { C: 1, CP: 0.5, NC: 0 };
let categoryChart, distributionChart;
let currentEvidenceItem = null;
let evidenceStore = {};

function makeId(str, idx) {
  return str.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '-' + idx;
}

function renderChecklist() {
  console.log('renderChecklist called');
  console.log('DATA sections:', DATA.length);
  
  const tbody = document.getElementById('tbody');
  if (!tbody) {
    console.error('tbody element not found!');
    return;
  }
  tbody.innerHTML = '';
  
  DATA.forEach(section => {
    console.log('Rendering section:', section.name, 'with', section.items.length, 'items');
    const trTitle = document.createElement('tr');
    const tdTitle = document.createElement('td');
    tdTitle.colSpan = 7;
    tdTitle.className = 'section-title';
    tdTitle.textContent = section.name;
    trTitle.appendChild(tdTitle);
    tbody.appendChild(trTitle);

    section.items.forEach((text, idx) => {
      const itemId = makeId(section.name, idx);
      const row = document.createElement('tr');
      
      const tdAspect = document.createElement('td');
      tdAspect.textContent = text;
      row.appendChild(tdAspect);

      ['C','CP','NC','NA'].forEach(mark => {
        const td = document.createElement('td');
        td.className = 'radio-cell';
        td.innerHTML = '<input type="radio" name="' + itemId + '" value="' + mark + '">';
        row.appendChild(td);
      });

      // Evidence button cell
      const tdEvidence = document.createElement('td');
      tdEvidence.className = 'evidence-cell';
      const evidenceBtn = document.createElement('button');
      evidenceBtn.className = 'evidence-btn';
      evidenceBtn.innerHTML = '<i class="fas fa-camera"></i><span>Foto</span>';
      evidenceBtn.onclick = () => openEvidenceModal(section.name, idx, text);
      evidenceBtn.id = 'evidence-btn-' + itemId;
      tdEvidence.appendChild(evidenceBtn);
      row.appendChild(tdEvidence);

      const tdObs = document.createElement('td');
      tdObs.innerHTML = '<input type="text" class="obs-input" placeholder="Observaciones...">';
      row.appendChild(tdObs);
      tbody.appendChild(row);
    });

    const trRes = document.createElement('tr');
    trRes.className = 'result-row';
    const tdResLbl = document.createElement('td');
    tdResLbl.textContent = 'Resultado %';
    const tdResVal = document.createElement('td');
    tdResVal.colSpan = 6;
    tdResVal.className = 'radio-cell';
    tdResVal.id = 'result-' + makeId(section.name, 0);
    tdResVal.textContent = '0%';
    trRes.appendChild(tdResLbl);
    trRes.appendChild(tdResVal);
    tbody.appendChild(trRes);
  });
  
  console.log('renderChecklist completed - total rows added:', tbody.children.length);
}

function openEvidenceModal(sectionName, itemIdx, itemText) {
  currentEvidenceItem = makeId(sectionName, itemIdx);
  document.getElementById('modal-title').textContent = `Evidencia: ${itemText}`;
  
  // Load existing evidence
  const preview = document.getElementById('evidence-preview');
  preview.innerHTML = '';
  
  const evidence = evidenceStore[currentEvidenceItem] || [];
  evidence.forEach((imgData, idx) => {
    const item = document.createElement('div');
    item.className = 'evidence-item';
    item.innerHTML = `
      <img src="${imgData}" alt="Evidencia ${idx + 1}">
      <button class="evidence-remove" onclick="removeEvidence(${idx})">
        <i class="fas fa-times"></i>
      </button>
    `;
    preview.appendChild(item);
  });
  
  document.getElementById('evidenceModal').style.display = 'block';
}

function closeEvidenceModal() {
  document.getElementById('evidenceModal').style.display = 'none';
  currentEvidenceItem = null;
  document.getElementById('modal-file-input').value = '';
}

function handleEvidenceUpload(event) {
  const files = event.target.files;
  if (!files.length || !currentEvidenceItem) return;
  
  if (!evidenceStore[currentEvidenceItem]) {
    evidenceStore[currentEvidenceItem] = [];
  }
  
  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      evidenceStore[currentEvidenceItem].push(e.target.result);
      updateEvidencePreview();
      updateEvidenceButton();
    };
    reader.readAsDataURL(file);
  });
  
  event.target.value = '';
}

function removeEvidence(idx) {
  if (!currentEvidenceItem) return;
  evidenceStore[currentEvidenceItem].splice(idx, 1);
  if (evidenceStore[currentEvidenceItem].length === 0) {
    delete evidenceStore[currentEvidenceItem];
  }
  updateEvidencePreview();
  updateEvidenceButton();
}

function updateEvidencePreview() {
  const preview = document.getElementById('evidence-preview');
  preview.innerHTML = '';
  
  const evidence = evidenceStore[currentEvidenceItem] || [];
  evidence.forEach((imgData, idx) => {
    const item = document.createElement('div');
    item.className = 'evidence-item';
    item.innerHTML = `
      <img src="${imgData}" alt="Evidencia ${idx + 1}">
      <button class="evidence-remove" onclick="removeEvidence(${idx})">
        <i class="fas fa-times"></i>
      </button>
    `;
    preview.appendChild(item);
  });
}

function updateEvidenceButton() {
  const btn = document.getElementById('evidence-btn-' + currentEvidenceItem);
  if (!btn) return;
  
  const count = (evidenceStore[currentEvidenceItem] || []).length;
  
  if (count > 0) {
    btn.classList.add('has-evidence');
    if (!btn.querySelector('.evidence-count')) {
      const badge = document.createElement('span');
      badge.className = 'evidence-count';
      btn.appendChild(badge);
    }
    btn.querySelector('.evidence-count').textContent = count;
  } else {
    btn.classList.remove('has-evidence');
    const badge = btn.querySelector('.evidence-count');
    if (badge) badge.remove();
  }
}

function computeResults() {
  const results = [];
  
  DATA.forEach(section => {
    const nameId = makeId(section.name, 0);
    let sum = 0, n = 0;
    section.items.forEach((_, idx) => {
      const radios = document.getElementsByName(makeId(section.name, idx));
      let chosen = null;
      for (const r of radios) if (r.checked) chosen = r.value;
      if (chosen) {
        if (chosen === 'NA') {
          sum += 1;
          n += 1;
        } else {
          sum += SCORE[chosen];
          n += 1;
        }
      }
    });
    const pct = n > 0 ? Math.round((sum / n) * 100) : 0;
    const el = document.getElementById('result-' + nameId);
    if (el) el.textContent = pct + '%';
    
    results.push({
      name: section.name,
      weight: section.weight,
      percentage: pct
    });
  });

  const wtbody = document.getElementById('weights-body');
  wtbody.innerHTML = '';
  let totalsum = 0;
  
  results.forEach(result => {
    const weight = Number(result.weight || 0);
    const pct = result.percentage;
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>'+result.name+'</td><td class="radio-cell">'+Math.round(weight*100)+'%</td><td class="radio-cell">'+pct+'%</td><td>'+legendFor(pct)+'</td>';
    wtbody.appendChild(tr);
    totalsum += (pct/100) * weight;
  });
  
  const finalPct = Math.round(totalsum * 100);
  document.getElementById('total-pct').textContent = finalPct + '%';
  document.getElementById('final-status').textContent = legendFor(finalPct);
  
  const finalScore = document.querySelector('.final-score');
  if (finalPct >= 92) {
    finalScore.style.background = 'linear-gradient(135deg, #4caf50 0%, #66bb6a 100%)';
  } else if (finalPct >= 85) {
    finalScore.style.background = 'linear-gradient(135deg, #ff9800 0%, #ffa726 100%)';
  } else {
    finalScore.style.background = 'linear-gradient(135deg, #f44336 0%, #ef5350 100%)';
  }
  
  updateCharts(results, finalPct);
  
  return { results, finalPct };
}

function legendFor(pct) {
  if (pct >= 92) return 'Riesgo Bajo';
  if (pct >= 85) return 'Riesgo Medio';
  return 'Riesgo Alto';
}

function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notification-text');
  
  notificationText.textContent = message;
  notification.className = `notification notification-${type} show`;
  
  const icon = notification.querySelector('i');
  if (type === 'error') {
    icon.className = 'fas fa-exclamation-circle';
  } else if (type === 'info') {
    icon.className = 'fas fa-info-circle';
  } else {
    icon.className = 'fas fa-check-circle';
  }
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

function showLoading(text = 'Procesando...', subtext = 'Por favor espere') {
  document.getElementById('loading-text').textContent = text;
  document.getElementById('loading-subtext').textContent = subtext;
  document.getElementById('loading-overlay').classList.add('show');
}

function hideLoading() {
  document.getElementById('loading-overlay').classList.remove('show');
}

async function exportToPDF() {
  try {
    showNotification('Generando PDF de lista de verificación', 'info');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);
    let yPos = margin;
    
    const fecha = document.getElementById('fecha').value || 'No especificada';
    const sede = document.getElementById('sede').value || 'No especificada';
    const auditor = document.getElementById('auditor').value || 'No especificado';
    const { results, finalPct } = computeResults();
    
    function checkPageBreak(requiredSpace) {
      if (yPos + requiredSpace > pageHeight - margin) {
        doc.addPage();
        yPos = margin;
        return true;
      }
      return false;
    }
    
    // Header
    doc.setFillColor(30, 60, 114);
    doc.rect(0, 0, pageWidth, 65, 'F');
    
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(margin, 12, 20, 20, 3, 3, 'F');
    
    try {
      const logoImg = document.querySelector('.logo img');
      if (logoImg && logoImg.complete) {
        doc.addImage(logoImg.src, 'PNG', margin + 2, 14, 16, 16);
      }
    } catch (error) {
      doc.setTextColor(30, 60, 114);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('FOCA', margin + 10, 24, { align: 'center' });
    }
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('FUNDACIÓN OFTALMOLÓGICA DEL CARIBE', pageWidth / 2, 22, { align: 'center' });
    
    doc.setFontSize(14);
    doc.text('LISTA DE VERIFICACIÓN DE AUDITORÍA DE SERVICIO', pageWidth / 2, 38, { align: 'center' });
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Sistema de Evaluación y Control de Calidad', pageWidth / 2, 45, { align: 'center' });
    
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.text('Código: ', margin, 56);
    doc.setFont('helvetica', 'normal');
    doc.text('F-FSYM-823', margin + 15, 56);
    
    doc.setFont('helvetica', 'bold');
    doc.text('Versión: ', pageWidth / 2 - 10, 56);
    doc.setFont('helvetica', 'normal');
    doc.text('006', pageWidth / 2 + 5, 56);
    
    doc.setFont('helvetica', 'bold');
    doc.text('Vigencia: ', pageWidth - 45, 56);
    doc.setFont('helvetica', 'normal');
    doc.text('2026-19-01', pageWidth - 25, 56);
    
    yPos = 75;
    
    // Meta section
    doc.setFillColor(248, 249, 250);
    doc.rect(margin, yPos, contentWidth, 30, 'F');
    
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    
    doc.text('FECHA DE AUDITORÍA:', margin + 3, yPos + 7);
    doc.setFont('helvetica', 'normal');
    doc.text(fecha, margin + 3, yPos + 12);
    
    doc.setFont('helvetica', 'bold');
    doc.text('SEDE:', margin + 3, yPos + 19);
    doc.setFont('helvetica', 'normal');
    doc.text(sede, margin + 3, yPos + 24);
    
    doc.setFont('helvetica', 'bold');
    doc.text('AUDITOR:', pageWidth / 2 + 5, yPos + 19);
    doc.setFont('helvetica', 'normal');
    doc.text(auditor, pageWidth / 2 + 5, yPos + 24);
    
    yPos += 37;
    
    // Checklist table
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('LISTA DE VERIFICACIÓN', margin, yPos);
    yPos += 7;
    
    const tableData = [];
    
    DATA.forEach(section => {
      tableData.push([{
        content: section.name,
        colSpan: 6,
        styles: { 
          fillColor: [102, 126, 234], 
          textColor: [255, 255, 255], 
          fontStyle: 'bold',
          fontSize: 9,
          halign: 'left'
        }
      }]);
      
      section.items.forEach((item, idx) => {
        const itemId = makeId(section.name, idx);
        const radios = document.getElementsByName(itemId);
        let selectedValue = '';
        for (const r of radios) {
          if (r.checked) selectedValue = r.value;
        }
        
        const allRows = document.querySelectorAll('#tbody tr');
        let observation = '';
        for (const row of allRows) {
          const firstCell = row.cells[0];
          if (firstCell && firstCell.textContent === item) {
            const obsInput = row.querySelector('.obs-input');
            if (obsInput) observation = obsInput.value;
            break;
          }
        }
        
        tableData.push([
          item,
          selectedValue === 'C' ? 'C' : '',
          selectedValue === 'CP' ? 'CP' : '',
          selectedValue === 'NC' ? 'NC' : '',
          selectedValue === 'NA' ? 'N/A' : '',
          observation
        ]);
      });
      
      const resultEl = document.getElementById('result-' + makeId(section.name, 0));
      const resultPct = resultEl ? resultEl.textContent : '0%';
      
      tableData.push([{
        content: 'Resultado %',
        styles: { fillColor: [232, 245, 233], textColor: [46, 125, 50], fontStyle: 'bold' }
      }, '', '', '', '', {
        content: resultPct,
        styles: { fillColor: [232, 245, 233], textColor: [46, 125, 50], fontStyle: 'bold', halign: 'right' }
      }]);
    });
    
    doc.autoTable({
      startY: yPos,
      head: [[
        { content: 'ASPECTOS A EVALUAR', styles: { halign: 'left' } },
        'C',
        'CP',
        'NC',
        'N/A',
        'OBSERVACIONES'
      ]],
      body: tableData,
      theme: 'grid',
      headStyles: {
        fillColor: [30, 60, 114],
        textColor: [255, 255, 255],
        fontSize: 8,
        fontStyle: 'bold',
        halign: 'center'
      },
      bodyStyles: {
        fontSize: 7,
        textColor: [44, 62, 80]
      },
      columnStyles: {
        0: { cellWidth: 85, halign: 'left' },
        1: { cellWidth: 8, halign: 'center' },
        2: { cellWidth: 8, halign: 'center' },
        3: { cellWidth: 8, halign: 'center' },
        4: { cellWidth: 8, halign: 'center' },
        5: { cellWidth: 'auto', halign: 'left' }
      },
      margin: { left: margin, right: margin },
      didDrawPage: function(data) {
        yPos = data.cursor.y;
      }
    });
    
    // Results page
    doc.addPage();
    yPos = margin;
    
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('META DE SEGURIDAD', pageWidth / 2, yPos, { align: 'center' });
    
    yPos += 8;
    doc.setFontSize(10);
    doc.text('Resultados por Criterio', pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;
    
    const resultsTableData = results.map(result => [
      result.name,
      `${Math.round(result.weight * 100)}%`,
      `${result.percentage}%`,
      legendFor(result.percentage)
    ]);
    
    doc.autoTable({
      startY: yPos,
      head: [['Criterio', 'Ponderación', 'Resultado %', 'Estado de Cumplimiento']],
      body: resultsTableData,
      theme: 'grid',
      headStyles: {
        fillColor: [30, 60, 114],
        textColor: [255, 255, 255],
        fontSize: 9,
        fontStyle: 'bold',
        halign: 'center'
      },
      bodyStyles: {
        fontSize: 8,
        textColor: [44, 62, 80]
      },
      columnStyles: {
        0: { cellWidth: 65, halign: 'left' },
        1: { cellWidth: 30, halign: 'center' },
        2: { cellWidth: 30, halign: 'center' },
        3: { cellWidth: 'auto', halign: 'center' }
      },
      margin: { left: margin, right: margin }
    });
    
    yPos = doc.lastAutoTable.finalY + 15;
    
    const finalStatus = legendFor(finalPct);
    let statusBgColor;
    if (finalPct >= 92) statusBgColor = [76, 175, 80];
    else if (finalPct >= 85) statusBgColor = [255, 152, 0];
    else statusBgColor = [244, 67, 54];
    
    checkPageBreak(55);
    
    doc.setFillColor(statusBgColor[0], statusBgColor[1], statusBgColor[2]);
    doc.roundedRect(margin + 10, yPos, contentWidth - 20, 45, 3, 3, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('RESULTADO FINAL DE AUDITORÍA', pageWidth / 2, yPos + 10, { align: 'center' });
    
    doc.setFontSize(32);
    doc.text(`${finalPct}%`, pageWidth / 2, yPos + 26, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(finalStatus.toUpperCase(), pageWidth / 2, yPos + 38, { align: 'center' });
    
    // Charts
    yPos += 55;
    checkPageBreak(120);
    
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('VISUALIZACIÓN DE RESULTADOS', pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;
    
    try {
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const categoryCanvas = document.getElementById('categoryChart');
      if (categoryCanvas && categoryChart) {
        categoryChart.update('none');
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const tempCanvas = document.createElement('canvas');
        const scale = 5;
        tempCanvas.width = categoryCanvas.width * scale;
        tempCanvas.height = categoryCanvas.height * scale;
        const tempCtx = tempCanvas.getContext('2d', { alpha: false });
        
        tempCtx.imageSmoothingEnabled = true;
        tempCtx.imageSmoothingQuality = 'high';
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        tempCtx.scale(scale, scale);
        tempCtx.drawImage(categoryCanvas, 0, 0);
        
        const categoryImgData = tempCanvas.toDataURL('image/png', 1.0);
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(30, 60, 114);
        doc.text('Resultados por Categoría', margin, yPos);
        yPos += 5;
        
        const chartWidth = contentWidth * 0.85;
        const chartHeight = 60;
        const xOffset = (contentWidth - chartWidth) / 2;
        doc.addImage(categoryImgData, 'PNG', margin + xOffset, yPos, chartWidth, chartHeight, 'categoryChart', 'SLOW');
        yPos += chartHeight + 12;
      }
      
      checkPageBreak(75);
      
      const distributionCanvas = document.getElementById('distributionChart');
      if (distributionCanvas && distributionChart) {
        distributionChart.update('none');
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const tempCanvas = document.createElement('canvas');
        const scale = 5;
        tempCanvas.width = distributionCanvas.width * scale;
        tempCanvas.height = distributionCanvas.height * scale;
        const tempCtx = tempCanvas.getContext('2d', { alpha: false });
        
        tempCtx.imageSmoothingEnabled = true;
        tempCtx.imageSmoothingQuality = 'high';
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        tempCtx.scale(scale, scale);
        tempCtx.drawImage(distributionCanvas, 0, 0);
        
        const distributionImgData = tempCanvas.toDataURL('image/png', 1.0);
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(30, 60, 114);
        doc.text('Distribución de Evaluaciones', margin, yPos);
        yPos += 5;
        
        const chartWidth = contentWidth * 0.85;
        const chartHeight = 60;
        const xOffset = (contentWidth - chartWidth) / 2;
        doc.addImage(distributionImgData, 'PNG', margin + xOffset, yPos, chartWidth, chartHeight, 'distributionChart', 'SLOW');
      }
    } catch (error) {
      console.warn('No se pudieron capturar las gráficas:', error);
    }
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.setFont('helvetica', 'normal');
    
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.text(`Página ${i} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
      doc.text(`Generado: ${new Date().toLocaleDateString('es-CO')}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
    }
    
    const fileName = `Lista_Verificacion_${fecha.replace(/-/g, '')}_${sede.replace(/\s+/g, '_')}.pdf`;
    doc.save(fileName);
    
    showNotification('PDF exportado exitosamente', 'success');
  } catch (error) {
    console.error('Error al exportar PDF:', error);
    showNotification('Error al exportar PDF: ' + error.message, 'error');
  }
}

function generateFallbackAnalysis(results, finalPct, noConformeFindings, sede) {
  let analysis = '';
  
  // RESUMEN EJECUTIVO
  analysis += '**RESUMEN EJECUTIVO**\n\n';
  
  if (finalPct >= 92) {
    analysis += `La auditoría realizada en ${sede} evidencia un desempeño SOBRESALIENTE con una calificación del ${finalPct}%, clasificándose en RIESGO BAJO. Este resultado refleja un alto nivel de cumplimiento en los estándares de calidad evaluados, demostrando un compromiso institucional con la excelencia en la prestación de servicios de salud oftalmológica.\n\n`;
    analysis += 'Los procesos auditados muestran solidez operativa y adherencia consistente a los protocolos establecidos. Se recomienda mantener los estándares alcanzados mediante monitoreo continuo y fortalecer las buenas prácticas identificadas.\n\n';
  } else if (finalPct >= 85) {
    analysis += `La auditoría realizada en ${sede} muestra un desempeño ACEPTABLE con una calificación del ${finalPct}%, clasificándose en RIESGO MEDIO. Si bien se evidencia cumplimiento en aspectos fundamentales, existen oportunidades de mejora que requieren atención para alcanzar la excelencia operativa.\n\n`;
    analysis += 'Se han identificado áreas específicas que necesitan refuerzo y corrección. Es imperativo implementar un plan de acción enfocado en las deficiencias detectadas para elevar los estándares de calidad y reducir el nivel de riesgo.\n\n';
  } else {
    analysis += `La auditoría realizada en ${sede} revela un desempeño DEFICIENTE con una calificación del ${finalPct}%, clasificándose en RIESGO ALTO. Los resultados evidencian deficiencias críticas que comprometen la calidad del servicio y requieren intervención inmediata.\n\n`;
    analysis += 'Es urgente implementar acciones correctivas de alto impacto. Se requiere un plan de mejoramiento integral a corto plazo con seguimiento estricto para garantizar la seguridad del paciente y el cumplimiento normativo.\n\n';
  }
  
  // ANÁLISIS POR CATEGORÍA
  analysis += '**ANÁLISIS DETALLADO POR CATEGORÍA**\n\n';
  
  results.forEach(result => {
    analysis += `**${result.name}** - Resultado: ${result.percentage}%\n`;
    
    if (result.percentage >= 92) {
      analysis += `FORTALEZA: Esta categoría muestra cumplimiento sobresaliente. Los procesos están bien establecidos y se ejecutan consistentemente. Se recomienda documentar las mejores prácticas para replicarlas en otras áreas.\n\n`;
    } else if (result.percentage >= 85) {
      analysis += `ÁREA DE OPORTUNIDAD: Aunque cumple los estándares mínimos, existen aspectos específicos que requieren atención. Se recomienda revisar los hallazgos no conformes y establecer acciones preventivas.\n\n`;
    } else if (result.percentage >= 70) {
      analysis += `REQUIERE ATENCIÓN: Esta categoría presenta deficiencias importantes que deben corregirse. Se recomienda implementar capacitación específica al personal y reforzar la supervisión de estos procesos.\n\n`;
    } else {
      analysis += `CRÍTICO: Esta categoría muestra deficiencias graves que requieren intervención urgente. Se debe implementar un plan de acción inmediato con seguimiento diario hasta alcanzar niveles aceptables de cumplimiento.\n\n`;
    }
  });
  
  // RECOMENDACIONES ESPECÍFICAS
  analysis += '**RECOMENDACIONES ESPECÍFICAS**\n\n';
  
  if (noConformeFindings.length > 0) {
    noConformeFindings.forEach((finding, idx) => {
      analysis += `${idx + 1}. **${finding.section}**:\n`;
      finding.findings.forEach(f => {
        analysis += `   • ${f.item}\n`;
        if (f.observation) {
          analysis += `     Observación: ${f.observation}\n`;
        }
        
        // Generate specific recommendation based on the finding
        if (f.item.includes('lavado de manos')) {
          analysis += `     Recomendación: Reforzar capacitación en técnica de lavado de manos según protocolo OMS. Implementar auditorías semanales de cumplimiento.\n`;
        } else if (f.item.includes('rotula')) {
          analysis += `     Recomendación: Establecer procedimiento operativo estándar para rotulación de medicamentos e insumos. Designar responsable de verificación diaria.\n`;
        } else if (f.item.includes('señalética') || f.item.includes('señalización')) {
          analysis += `     Recomendación: Completar señalización faltante en un plazo máximo de 48 horas. Verificar visibilidad y ubicación estratégica.\n`;
        } else if (f.item.includes('limpieza')) {
          analysis += `     Recomendación: Revisar y actualizar cronograma de limpieza. Reforzar supervisión del personal de servicios generales.\n`;
        } else if (f.item.includes('actualización de datos')) {
          analysis += `     Recomendación: Capacitar al personal de admisión en la importancia de actualización de datos. Implementar checklist de verificación obligatoria.\n`;
        } else if (f.item.includes('tiempo')) {
          analysis += `     Recomendación: Optimizar flujo de pacientes y redistribuir carga laboral. Monitorear tiempos de atención semanalmente.\n`;
        } else {
          analysis += `     Recomendación: Implementar acción correctiva inmediata y verificar cumplimiento en próxima auditoría.\n`;
        }
      });
      analysis += '\n';
    });
  }
  
  // PLAN DE ACCIÓN SUGERIDO
  analysis += '**PLAN DE ACCIÓN SUGERIDO**\n\n';
  
  if (finalPct >= 92) {
    analysis += '**CORTO PLAZO (1-2 semanas)**:\n';
    analysis += '• Documentar buenas prácticas identificadas\n';
    analysis += '• Socializar resultados con el equipo\n';
    analysis += '• Mantener sistema de monitoreo continuo\n\n';
    
    analysis += '**MEDIANO PLAZO (1-3 meses)**:\n';
    analysis += '• Implementar programa de reconocimiento al personal\n';
    analysis += '• Desarrollar material educativo para nuevos ingresos\n';
    analysis += '• Evaluar posibilidad de certificación de calidad\n\n';
  } else if (finalPct >= 85) {
    analysis += '**CORTO PLAZO (1-2 semanas)**:\n';
    analysis += '• Corregir hallazgos no conformes identificados\n';
    analysis += '• Capacitar personal en áreas deficientes\n';
    analysis += '• Implementar supervisión reforzada\n\n';
    
    analysis += '**MEDIANO PLAZO (1-3 meses)**:\n';
    analysis += '• Evaluar efectividad de acciones correctivas\n';
    analysis += '• Realizar auditoría de seguimiento\n';
    analysis += '• Actualizar procedimientos según necesidad\n\n';
    
    analysis += '**LARGO PLAZO (3-6 meses)**:\n';
    analysis += '• Establecer cultura de mejora continua\n';
    analysis += '• Implementar indicadores de calidad\n';
    analysis += '• Alcanzar nivel de riesgo bajo\n\n';
  } else {
    analysis += '**INMEDIATO (1-3 días)**:\n';
    analysis += '• Intervenir hallazgos críticos de seguridad del paciente\n';
    analysis += '• Reunión urgente con equipo directivo\n';
    analysis += '• Asignar responsables específicos por área\n\n';
    
    analysis += '**CORTO PLAZO (1-2 semanas)**:\n';
    analysis += '• Capacitación intensiva al personal\n';
    analysis += '• Implementar supervisión diaria\n';
    analysis += '• Corregir el 80% de hallazgos no conformes\n\n';
    
    analysis += '**MEDIANO PLAZO (1-3 meses)**:\n';
    analysis += '• Alcanzar nivel mínimo de 85% de cumplimiento\n';
    analysis += '• Auditorías semanales de seguimiento\n';
    analysis += '• Reestructurar procesos deficientes\n\n';
  }
  
  // OPORTUNIDADES DE MEJORA
  analysis += '**OPORTUNIDADES DE MEJORA IDENTIFICADAS**\n\n';
  
  const lowPerformers = results.filter(r => r.percentage < 85);
  if (lowPerformers.length > 0) {
    lowPerformers.forEach(lp => {
      analysis += `• **${lp.name}**: Con ${lp.percentage}% de cumplimiento, esta categoría requiere atención prioritaria. Se sugiere implementar programa de mejora específico con metas medibles y cronograma definido.\n`;
    });
  } else {
    analysis += '• Todas las categorías cumplen estándares mínimos. Se recomienda enfoque en mantener y mejorar continuamente los procesos establecidos.\n';
  }
  
  analysis += '\n**CONCLUSIÓN**\n\n';
  analysis += `Los resultados de esta auditoría proporcionan una fotografía clara del estado actual de ${sede}. `;
  
  if (finalPct >= 92) {
    analysis += 'El alto nivel de cumplimiento alcanzado es testimonio del compromiso del equipo con la calidad. Se recomienda continuar con este nivel de excelencia y compartir las mejores prácticas con otras sedes de la organización.';
  } else if (finalPct >= 85) {
    analysis += 'Aunque se cumplen los estándares básicos, existe un margen importante para la mejora. Con implementación oportuna de las recomendaciones, la sede puede alcanzar niveles de excelencia en el corto plazo.';
  } else {
    analysis += 'Los hallazgos requieren atención inmediata y decidida. Es fundamental el compromiso de la dirección y del equipo completo para implementar las acciones correctivas necesarias y garantizar la seguridad y satisfacción de nuestros pacientes.';
  }
  
  return analysis;
}

async function generateComprehensiveReport() {
  try {
    const fecha = document.getElementById('fecha').value;
    const sede = document.getElementById('sede').value;
    const auditor = document.getElementById('auditor').value;
    
    if (!fecha || !sede || !auditor) {
      showNotification('Por favor complete todos los campos antes de generar el informe', 'error');
      return;
    }

    showLoading('Generando informe completo con IA...', 'Esto puede tomar unos momentos');
    
    const { results, finalPct } = computeResults();
    
    // Collect detailed findings
    const conformeFindings = [];
    const noConformeFindings = [];
    
    DATA.forEach(section => {
      const sectionConformes = [];
      const sectionNoConformes = [];
      
      section.items.forEach((item, idx) => {
        const itemId = makeId(section.name, idx);
        const radios = document.getElementsByName(itemId);
        let selectedValue = '';
        for (const r of radios) {
          if (r.checked) selectedValue = r.value;
        }
        
        const allRows = document.querySelectorAll('#tbody tr');
        let observation = '';
        for (const row of allRows) {
          const firstCell = row.cells[0];
          if (firstCell && firstCell.textContent === item) {
            const obsInput = row.querySelector('.obs-input');
            if (obsInput) observation = obsInput.value;
            break;
          }
        }
        
        if (selectedValue === 'C' || selectedValue === 'NA') {
          sectionConformes.push({ item, observation });
        } else if (selectedValue === 'CP' || selectedValue === 'NC') {
          sectionNoConformes.push({ 
            item, 
            observation, 
            severity: selectedValue === 'NC' ? 'No Cumple' : 'Cumple Parcialmente' 
          });
        }
      });
      
      if (sectionConformes.length > 0) {
        conformeFindings.push({
          section: section.name,
          findings: sectionConformes
        });
      }
      
      if (sectionNoConformes.length > 0) {
        noConformeFindings.push({
          section: section.name,
          findings: sectionNoConformes
        });
      }
    });
    
    // Generate AI analysis
    const analysisPrompt = `Como experto en auditorías de calidad en salud, analiza los siguientes resultados de auditoría y genera un informe profesional:

DATOS DE LA AUDITORÍA:
- Sede: ${sede}
- Fecha: ${fecha}
- Auditor: ${auditor}
- Resultado Final: ${finalPct}%
- Clasificación de Riesgo: ${legendFor(finalPct)}

RESULTADOS POR CATEGORÍA:
${results.map(r => `- ${r.name}: ${r.percentage}% (Ponderación: ${Math.round(r.weight * 100)}%)`).join('\n')}

HALLAZGOS NO CONFORMES:
${noConformeFindings.map(nf => `
${nf.section}:
${nf.findings.map(f => `  - [${f.severity}] ${f.item}${f.observation ? '\n    Observación: ' + f.observation : ''}`).join('\n')}
`).join('\n')}

HALLAZGOS CONFORMES:
${conformeFindings.map(cf => `
${cf.section}:
${cf.findings.map(f => `  - ${f.item}${f.observation ? ' (Observación: ' + f.observation + ')' : ''}`).join('\n')}
`).join('\n')}

Por favor genera:
1. Un resumen ejecutivo conciso (máximo 150 palabras) que destaque los aspectos más críticos
2. Un análisis detallado por categoría, identificando fortalezas y áreas de mejora
3. Recomendaciones específicas y accionables para cada hallazgo no conforme
4. Oportunidades de mejora para optimizar los procesos evaluados
5. Un plan de acción sugerido con prioridades (corto, mediano y largo plazo)

El tono debe ser profesional, objetivo y constructivo.`;

    // Call Claude API for analysis
    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "anthropic-version": "2023-06-01"
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 4000,
          messages: [
            { role: "user", content: analysisPrompt }
          ]
        })
      });

      if (!response.ok) {
        throw new Error(`API Error: ${response.status} - ${response.statusText}`);
      }

      const data = await response.json();
      
      if (data.content && data.content.length > 0) {
        const aiAnalysis = data.content.find(item => item.type === "text")?.text || generateFallbackAnalysis(results, finalPct, noConformeFindings, sede);
        
        hideLoading();
        await generatePDFReport(fecha, sede, auditor, results, finalPct, conformeFindings, noConformeFindings, aiAnalysis);
      } else {
        throw new Error("No se recibió contenido de la API");
      }
    } catch (apiError) {
      console.error('Error en API:', apiError);
      showNotification('Generando informe sin análisis IA...', 'info');
      
      // Fallback: Generate report with local analysis
      const fallbackAnalysis = generateFallbackAnalysis(results, finalPct, noConformeFindings, sede);
      hideLoading();
      await generatePDFReport(fecha, sede, auditor, results, finalPct, conformeFindings, noConformeFindings, fallbackAnalysis);
    }
    
  } catch (error) {
    hideLoading();
    console.error('Error al generar informe:', error);
    showNotification('Error al generar el informe: ' + error.message, 'error');
  }
}

async function generatePDFReport(fecha, sede, auditor, results, finalPct, conformeFindings, noConformeFindings, aiAnalysis) {
  try {
    showLoading('Creando PDF del informe...', 'Insertando gráficas y evidencias');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);
    let yPos = margin;
    let pageNumber = 1;
    
    function checkPageBreak(requiredSpace) {
      if (yPos + requiredSpace > pageHeight - 25) {
        addFooter();
        doc.addPage();
        pageNumber++;
        yPos = margin;
        return true;
      }
      return false;
    }
    
    function addFooter() {
      doc.setFontSize(8);
      doc.setTextColor(128, 128, 128);
      doc.setFont('helvetica', 'normal');
      doc.text(`Página ${pageNumber}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
      doc.text(`Generado: ${new Date().toLocaleDateString('es-CO')} ${new Date().toLocaleTimeString('es-CO')}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
    }
    
    // ===== PORTADA =====
    doc.setFillColor(30, 60, 114);
    doc.rect(0, 0, pageWidth, pageHeight, 'F');
    
    // Logo
    try {
      const logoImg = document.querySelector('.logo img');
      if (logoImg && logoImg.complete) {
        doc.addImage(logoImg.src, 'PNG', pageWidth/2 - 25, 40, 50, 50);
      }
    } catch (error) {
      console.warn('No se pudo insertar el logo');
    }
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.text('INFORME DE AUDITORÍA', pageWidth / 2, 110, { align: 'center' });
    doc.text('DE SERVICIO', pageWidth / 2, 120, { align: 'center' });
    
    doc.setFontSize(14);
    doc.setFont('helvetica', 'normal');
    doc.text('Fundación Oftalmológica del Caribe - FOCA', pageWidth / 2, 135, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text(`SEDE: ${sede}`, pageWidth / 2, 160, { align: 'center' });
    
    doc.setFont('helvetica', 'normal');
    doc.text(`Fecha de Auditoría: ${fecha}`, pageWidth / 2, 170, { align: 'center' });
    doc.text(`Auditor: ${auditor}`, pageWidth / 2, 178, { align: 'center' });
    
    // Status badge on cover
    let coverBgColor;
    const statusText = legendFor(finalPct);
    if (finalPct >= 92) coverBgColor = [76, 175, 80];
    else if (finalPct >= 85) coverBgColor = [255, 152, 0];
    else coverBgColor = [244, 67, 54];
    
    doc.setFillColor(coverBgColor[0], coverBgColor[1], coverBgColor[2]);
    doc.roundedRect(pageWidth/2 - 40, 200, 80, 35, 5, 5, 'F');
    
    doc.setFontSize(10);
    doc.text('CALIFICACIÓN FINAL', pageWidth / 2, 210, { align: 'center' });
    
    doc.setFontSize(32);
    doc.setFont('helvetica', 'bold');
    doc.text(`${finalPct}%`, pageWidth / 2, 225, { align: 'center' });
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.text(statusText.toUpperCase(), pageWidth / 2, 233, { align: 'center' });
    
    doc.setFontSize(8);
    doc.setTextColor(200, 200, 200);
    doc.text(`Código: F-FSYM-797  |  Versión: 004  |  Vigencia: 2022-08-08`, pageWidth / 2, pageHeight - 10, { align: 'center' });
    
    // ===== PÁGINA 2: RESUMEN EJECUTIVO =====
    doc.addPage();
    pageNumber++;
    yPos = margin;
    
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('RESUMEN EJECUTIVO', margin, yPos);
    yPos += 10;
    
    doc.setDrawColor(102, 126, 234);
    doc.setLineWidth(0.5);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 8;
    
    // Extract executive summary from AI analysis
    const summaryMatch = aiAnalysis.match(/(?:resumen ejecutivo|1\.|^)[\s\S]*?(?=\n\n|\n2\.|$)/im);
    const executiveSummary = summaryMatch ? summaryMatch[0].replace(/^.*?:\s*/i, '').trim() : aiAnalysis.substring(0, 800);
    
    doc.setFontSize(10);
    doc.setTextColor(44, 62, 80);
    doc.setFont('helvetica', 'normal');
    const summaryLines = doc.splitTextToSize(executiveSummary, contentWidth);
    doc.text(summaryLines, margin, yPos);
    yPos += summaryLines.length * 5 + 10;
    
    // Quick stats boxes
    checkPageBreak(40);
    
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(30, 60, 114);
    doc.text('INDICADORES CLAVE', margin, yPos);
    yPos += 8;
    
    const boxWidth = (contentWidth - 10) / 3;
    
    // Box 1: Total conformes
    const totalItems = DATA.reduce((sum, section) => sum + section.items.length, 0);
    const conformes = conformeFindings.reduce((sum, cf) => sum + cf.findings.length, 0);
    
    doc.setFillColor(232, 245, 233);
    doc.roundedRect(margin, yPos, boxWidth, 25, 3, 3, 'F');
    doc.setTextColor(46, 125, 50);
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text(conformes.toString(), margin + boxWidth/2, yPos + 12, { align: 'center' });
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Hallazgos Conformes', margin + boxWidth/2, yPos + 20, { align: 'center' });
    
    // Box 2: Total no conformes
    const noConformes = noConformeFindings.reduce((sum, nf) => sum + nf.findings.length, 0);
    
    doc.setFillColor(255, 243, 224);
    doc.roundedRect(margin + boxWidth + 5, yPos, boxWidth, 25, 3, 3, 'F');
    doc.setTextColor(245, 124, 0);
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text(noConformes.toString(), margin + boxWidth + 5 + boxWidth/2, yPos + 12, { align: 'center' });
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Hallazgos No Conformes', margin + boxWidth + 5 + boxWidth/2, yPos + 20, { align: 'center' });
    
    // Box 3: Completion rate
    const completionRate = Math.round((conformes / totalItems) * 100);
    
    doc.setFillColor(227, 242, 253);
    doc.roundedRect(margin + (boxWidth + 5) * 2, yPos, boxWidth, 25, 3, 3, 'F');
    doc.setTextColor(25, 118, 210);
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text(`${completionRate}%`, margin + (boxWidth + 5) * 2 + boxWidth/2, yPos + 12, { align: 'center' });
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Tasa de Cumplimiento', margin + (boxWidth + 5) * 2 + boxWidth/2, yPos + 20, { align: 'center' });
    
    yPos += 35;
    
    addFooter();
    
    // ===== PÁGINA 3: RESULTADOS POR CATEGORÍA =====
    doc.addPage();
    pageNumber++;
    yPos = margin;
    
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('RESULTADOS POR CATEGORÍA', margin, yPos);
    yPos += 10;
    
    doc.setDrawColor(102, 126, 234);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 10;
    
    // Results table
    const resultsTableData = results.map(result => [
      result.name,
      `${Math.round(result.weight * 100)}%`,
      `${result.percentage}%`,
      legendFor(result.percentage)
    ]);
    
    doc.autoTable({
      startY: yPos,
      head: [['Categoría', 'Ponderación', 'Resultado', 'Estado']],
      body: resultsTableData,
      theme: 'grid',
      headStyles: {
        fillColor: [30, 60, 114],
        textColor: [255, 255, 255],
        fontSize: 10,
        fontStyle: 'bold',
        halign: 'center'
      },
      bodyStyles: {
        fontSize: 9,
        textColor: [44, 62, 80]
      },
      columnStyles: {
        0: { cellWidth: 70, halign: 'left', fontStyle: 'bold' },
        1: { cellWidth: 30, halign: 'center' },
        2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' },
        3: { cellWidth: 'auto', halign: 'center' }
      },
      margin: { left: margin, right: margin },
      didParseCell: function(data) {
        if (data.section === 'body' && data.column.index === 3) {
          const value = data.cell.text[0];
          if (value === 'Riesgo Bajo') {
            data.cell.styles.textColor = [46, 125, 50];
            data.cell.styles.fillColor = [232, 245, 233];
          } else if (value === 'Riesgo Medio') {
            data.cell.styles.textColor = [245, 124, 0];
            data.cell.styles.fillColor = [255, 243, 224];
          } else if (value === 'Riesgo Alto') {
            data.cell.styles.textColor = [211, 47, 47];
            data.cell.styles.fillColor = [255, 235, 238];
          }
        }
      }
    });
    
    yPos = doc.lastAutoTable.finalY + 15;
    
    // Add charts
    checkPageBreak(80);
    
    try {
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const categoryCanvas = document.getElementById('categoryChart');
      if (categoryCanvas && categoryChart) {
        categoryChart.update('none');
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const tempCanvas = document.createElement('canvas');
        const scale = 5;
        tempCanvas.width = categoryCanvas.width * scale;
        tempCanvas.height = categoryCanvas.height * scale;
        const tempCtx = tempCanvas.getContext('2d', { alpha: false });
        
        tempCtx.imageSmoothingEnabled = true;
        tempCtx.imageSmoothingQuality = 'high';
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        tempCtx.scale(scale, scale);
        tempCtx.drawImage(categoryCanvas, 0, 0);
        
        const categoryImgData = tempCanvas.toDataURL('image/png', 1.0);
        
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(30, 60, 114);
        doc.text('Gráfica de Resultados por Categoría', margin, yPos);
        yPos += 5;
        
        const chartWidth = contentWidth * 0.9;
        const chartHeight = 70;
        const xOffset = (contentWidth - chartWidth) / 2;
        doc.addImage(categoryImgData, 'PNG', margin + xOffset, yPos, chartWidth, chartHeight);
        yPos += chartHeight + 10;
      }
      
      checkPageBreak(80);
      
      const distributionCanvas = document.getElementById('distributionChart');
      if (distributionCanvas && distributionChart) {
        distributionChart.update('none');
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const tempCanvas = document.createElement('canvas');
        const scale = 5;
        tempCanvas.width = distributionCanvas.width * scale;
        tempCanvas.height = distributionCanvas.height * scale;
        const tempCtx = tempCanvas.getContext('2d', { alpha: false });
        
        tempCtx.imageSmoothingEnabled = true;
        tempCtx.imageSmoothingQuality = 'high';
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        tempCtx.scale(scale, scale);
        tempCtx.drawImage(distributionCanvas, 0, 0);
        
        const distributionImgData = tempCanvas.toDataURL('image/png', 1.0);
        
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(30, 60, 114);
        doc.text('Distribución de Evaluaciones', margin, yPos);
        yPos += 5;
        
        const chartWidth = contentWidth * 0.9;
        const chartHeight = 70;
        const xOffset = (contentWidth - chartWidth) / 2;
        doc.addImage(distributionImgData, 'PNG', margin + xOffset, yPos, chartWidth, chartHeight);
      }
    } catch (error) {
      console.warn('Error al insertar gráficas:', error);
    }
    
    addFooter();
    
    // ===== HALLAZGOS CONFORMES =====
    if (conformeFindings.length > 0) {
      doc.addPage();
      pageNumber++;
      yPos = margin;
      
      doc.setTextColor(30, 60, 114);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('HALLAZGOS CONFORMES', margin, yPos);
      yPos += 10;
      
      doc.setDrawColor(76, 175, 80);
      doc.line(margin, yPos, pageWidth - margin, yPos);
      yPos += 10;
      
      conformeFindings.forEach(cf => {
        checkPageBreak(20);
        
        doc.setFillColor(232, 245, 233);
        doc.roundedRect(margin, yPos, contentWidth, 8, 2, 2, 'F');
        
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(46, 125, 50);
        doc.text(cf.section, margin + 3, yPos + 6);
        yPos += 12;
        
        cf.findings.forEach((finding, idx) => {
          checkPageBreak(15);
          
          doc.setFontSize(9);
          doc.setTextColor(44, 62, 80);
          doc.setFont('helvetica', 'normal');
          
          const bullet = '•';
          doc.text(bullet, margin + 2, yPos);
          
          const itemText = doc.splitTextToSize(finding.item, contentWidth - 10);
          doc.text(itemText, margin + 6, yPos);
          yPos += itemText.length * 4;
          
          if (finding.observation) {
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(100, 100, 100);
            const obsText = doc.splitTextToSize(`Observación: ${finding.observation}`, contentWidth - 12);
            doc.text(obsText, margin + 8, yPos);
            yPos += obsText.length * 4;
          }
          
          yPos += 3;
        });
        
        yPos += 5;
      });
      
      addFooter();
    }
    
    // ===== HALLAZGOS NO CONFORMES =====
    if (noConformeFindings.length > 0) {
      doc.addPage();
      pageNumber++;
      yPos = margin;
      
      doc.setTextColor(30, 60, 114);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('HALLAZGOS NO CONFORMES', margin, yPos);
      yPos += 10;
      
      doc.setDrawColor(244, 67, 54);
      doc.line(margin, yPos, pageWidth - margin, yPos);
      yPos += 10;
      
      noConformeFindings.forEach(nf => {
        checkPageBreak(20);
        
        doc.setFillColor(255, 235, 238);
        doc.roundedRect(margin, yPos, contentWidth, 8, 2, 2, 'F');
        
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(211, 47, 47);
        doc.text(nf.section, margin + 3, yPos + 6);
        yPos += 12;
        
        nf.findings.forEach((finding, idx) => {
          checkPageBreak(20);
          
          doc.setFontSize(9);
          doc.setTextColor(44, 62, 80);
          doc.setFont('helvetica', 'bold');
          
          const severityColor = finding.severity === 'No Cumple' ? [211, 47, 47] : [245, 124, 0];
          doc.setTextColor(severityColor[0], severityColor[1], severityColor[2]);
          doc.text(`[${finding.severity}]`, margin + 2, yPos);
          
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(44, 62, 80);
          const itemText = doc.splitTextToSize(finding.item, contentWidth - 35);
          doc.text(itemText, margin + 30, yPos);
          yPos += itemText.length * 4;
          
          if (finding.observation) {
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(100, 100, 100);
            const obsText = doc.splitTextToSize(`Observación: ${finding.observation}`, contentWidth - 32);
            doc.text(obsText, margin + 30, yPos);
            yPos += obsText.length * 4;
          }
          
          yPos += 5;
        });
        
        yPos += 5;
      });
      
      addFooter();
    }
    
    // ===== ANÁLISIS Y RECOMENDACIONES (AI) =====
    doc.addPage();
    pageNumber++;
    yPos = margin;
    
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('ANÁLISIS Y RECOMENDACIONES', margin, yPos);
    yPos += 10;
    
    doc.setDrawColor(102, 126, 234);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 10;
    
    doc.setFontSize(9);
    doc.setTextColor(44, 62, 80);
    doc.setFont('helvetica', 'normal');
    
    const analysisLines = doc.splitTextToSize(aiAnalysis, contentWidth);
    
    analysisLines.forEach(line => {
      checkPageBreak(6);
      doc.text(line, margin, yPos);
      yPos += 5;
    });
    
    addFooter();
    
    // ===== ANEXOS (EVIDENCIAS FOTOGRÁFICAS) =====
    const evidenceItems = Object.keys(evidenceStore).filter(key => evidenceStore[key].length > 0);
    
    if (evidenceItems.length > 0) {
      doc.addPage();
      pageNumber++;
      yPos = margin;
      
      doc.setTextColor(30, 60, 114);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('ANEXOS: EVIDENCIA FOTOGRÁFICA', margin, yPos);
      yPos += 10;
      
      doc.setDrawColor(102, 126, 234);
      doc.line(margin, yPos, pageWidth - margin, yPos);
      yPos += 10;
      
      let anexoCounter = 1;
      
      for (const itemId of evidenceItems) {
        const evidence = evidenceStore[itemId];
        
        // Find item details
        let itemText = '';
        let sectionName = '';
        
        DATA.forEach(section => {
          section.items.forEach((item, idx) => {
            if (makeId(section.name, idx) === itemId) {
              itemText = item;
              sectionName = section.name;
            }
          });
        });
        
        checkPageBreak(15);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(102, 126, 234);
        doc.text(`Anexo ${anexoCounter}. ${sectionName}`, margin, yPos);
        yPos += 6;
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(44, 62, 80);
        const itemLines = doc.splitTextToSize(itemText, contentWidth);
        doc.text(itemLines, margin, yPos);
        yPos += itemLines.length * 4 + 5;
        
        // Add photos (2 per row)
        for (let i = 0; i < evidence.length; i += 2) {
          checkPageBreak(70);
          
          const imgWidth = (contentWidth - 5) / 2;
          const imgHeight = 60;
          
          try {
            doc.addImage(evidence[i], 'JPEG', margin, yPos, imgWidth, imgHeight);
            
            if (evidence[i + 1]) {
              doc.addImage(evidence[i + 1], 'JPEG', margin + imgWidth + 5, yPos, imgWidth, imgHeight);
            }
          } catch (error) {
            console.warn('Error al insertar evidencia:', error);
          }
          
          yPos += imgHeight + 8;
        }
        
        yPos += 5;
        anexoCounter++;
      }
      
      addFooter();
    }
    
    // ===== CONCLUSIÓN =====
    doc.addPage();
    pageNumber++;
    yPos = margin;
    
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('CONCLUSIÓN', margin, yPos);
    yPos += 10;
    
    doc.setDrawColor(102, 126, 234);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 10;
    
    const conclusionStatus = legendFor(finalPct);
    let conclusionBgColor;
    if (finalPct >= 92) conclusionBgColor = [76, 175, 80];
    else if (finalPct >= 85) conclusionBgColor = [255, 152, 0];
    else conclusionBgColor = [244, 67, 54];
    
    doc.setFillColor(conclusionBgColor[0], conclusionBgColor[1], conclusionBgColor[2]);
    doc.roundedRect(margin + 10, yPos, contentWidth - 20, 50, 5, 5, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('RESULTADO FINAL DE AUDITORÍA', pageWidth / 2, yPos + 12, { align: 'center' });
    
    doc.setFontSize(36);
    doc.text(`${finalPct}%`, pageWidth / 2, yPos + 30, { align: 'center' });
    
    doc.setFontSize(13);
    doc.text(conclusionStatus.toUpperCase(), pageWidth / 2, yPos + 42, { align: 'center' });
    
    yPos += 60;
    
    doc.setFontSize(10);
    doc.setTextColor(44, 62, 80);
    doc.setFont('helvetica', 'normal');
    
    let conclusionText = '';
    if (finalPct >= 92) {
      conclusionText = `Se concluye que ${sede} alcanzó un porcentaje de cumplimiento de ${finalPct}%, lo que representa un RIESGO BAJO en la escala de resultados. La sede cumple satisfactoriamente con los criterios evaluados. Se genera seguimiento pero no se requiere plan de acción inmediato.`;
    } else if (finalPct >= 85) {
      conclusionText = `Se concluye que ${sede} alcanzó un porcentaje de cumplimiento de ${finalPct}%, lo que representa un RIESGO MEDIO en la escala de resultados. La sede cumple parcialmente con los criterios evaluados y se requiere plan de acción y seguimiento para mejorar las áreas identificadas.`;
    } else {
      conclusionText = `Se concluye que ${sede} alcanzó un porcentaje de cumplimiento de ${finalPct}%, lo que representa un RIESGO ALTO en la escala de resultados. Se requieren acciones de intervención inmediata y plan de mejoramiento a corto plazo para corregir las deficiencias identificadas.`;
    }
    
    const conclusionLines = doc.splitTextToSize(conclusionText, contentWidth - 20);
    doc.text(conclusionLines, margin + 10, yPos);
    yPos += conclusionLines.length * 6 + 15;
    
    // Signature section
    checkPageBreak(40);
    
    doc.setDrawColor(200, 200, 200);
    doc.line(margin + 20, yPos, margin + 70, yPos);
    doc.line(pageWidth - margin - 70, yPos, pageWidth - margin - 20, yPos);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(44, 62, 80);
    doc.text(auditor, margin + 45, yPos + 6, { align: 'center' });
    doc.setFont('helvetica', 'normal');
    doc.text('Auditor', margin + 45, yPos + 11, { align: 'center' });
    
    doc.setFont('helvetica', 'bold');
    doc.text('Valentina Jimeno Mejía', pageWidth - margin - 45, yPos + 6, { align: 'center' });
    doc.setFont('helvetica', 'normal');
    doc.text('Asistente de Calidad', pageWidth - margin - 45, yPos + 11, { align: 'center' });
    
    addFooter();
    
    // Save PDF
    hideLoading();
    const fileName = `Informe_Auditoria_${sede.replace(/\s+/g, '_')}_${fecha.replace(/-/g, '')}.pdf`;
    doc.save(fileName);
    
    showNotification('Informe completo generado exitosamente', 'success');
    
  } catch (error) {
    hideLoading();
    console.error('Error al generar PDF del informe:', error);
    showNotification('Error al generar el PDF: ' + error.message, 'error');
  }
}

function resetForm() {
  if (!confirm('¿Estás seguro de que deseas restablecer el formulario? Se perderán todos los datos ingresados.')) {
    return;
  }
  
  try {
    showNotification('Restableciendo formulario...', 'info');
    
    document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
    document.getElementById('sede').value = '';
    document.getElementById('auditor').value = '';
    
    const allRadios = document.querySelectorAll('input[type="radio"]');
    allRadios.forEach(radio => {
      radio.checked = false;
    });
    
    const allObsInputs = document.querySelectorAll('.obs-input');
    allObsInputs.forEach(input => {
      input.value = '';
    });
    
    evidenceStore = {};
    
    document.querySelectorAll('.evidence-btn').forEach(btn => {
      btn.classList.remove('has-evidence');
      const badge = btn.querySelector('.evidence-count');
      if (badge) badge.remove();
    });
    
    computeResults();
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    showNotification('Formulario restablecido exitosamente', 'success');
  } catch (error) {
    console.error('Error al restablecer formulario:', error);
    showNotification('Error al restablecer formulario', 'error');
  }
}

async function guardarAuditoria() {
  try {
    showNotification('Guardando auditoría en Google Sheets...', 'info');
    
    const resultado = computeResults();
    
    const fecha = document.getElementById("fecha").value;
    const sede = document.getElementById("sede").value;
    const auditor = document.getElementById("auditor").value;
    
    if (!fecha || !sede || !auditor) {
      showNotification("Por favor complete todos los campos: Fecha, Sede y Auditor", "error");
      return;
    }
    
    const items = [];
    DATA.forEach(section => {
      section.items.forEach((item, idx) => {
        const itemId = makeId(section.name, idx);
        const radios = document.getElementsByName(itemId);
        let valor = "";
        
        radios.forEach(r => {
          if (r.checked) valor = r.value;
        });
        
        let observacion = "";
        if (radios.length > 0) {
          const fila = radios[0].closest("tr");
          const obsInput = fila ? fila.querySelector(".obs-input") : null;
          if (obsInput) observacion = obsInput.value;
        }
        
        const evidenceCount = evidenceStore[itemId] ? evidenceStore[itemId].length : 0;
        
        items.push({
          categoria: section.name,
          item: item,
          resultado: valor || "Sin evaluar",
          observacion: observacion,
          evidencias: evidenceCount
        });
      });
    });
    
    const fechaFormateada = fecha.replace(/-/g, '');
    const consecutivo = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    const auditID = `AuditoriaServicio-${fechaFormateada}-${consecutivo}`;
    
    const payload = {
      id: auditID,
      fecha: fecha,
      sede: sede,
      auditor: auditor,
      porcentaje_final: resultado.finalPct,
      estado: legendFor(resultado.finalPct),
      timestamp: new Date().toISOString(),
      items: items
    };
    
    console.log("Enviando payload:", payload);
    
    const response = await fetch("https://script.google.com/macros/s/AKfycby9YVrSoK38cY8z8zOB-dnzrFdgbsQwWbAIQnMtyQS1TH-7PQ7CLEbV63GKK633Gl-_OQ/exec", {
      method: "POST",
      mode: "no-cors",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });
    
    showNotification(`✔ Auditoría guardada exitosamente - ID: ${auditID}`, "success");
    
    console.log("Auditoría enviada con ID:", payload.id);
    
  } catch (error) {
    console.error("Error detallado al guardar:", error);
    showNotification("❌ Error al guardar: " + error.message, "error");
  }
}

function initializeCharts() {
  const ctx1 = document.getElementById('categoryChart').getContext('2d');
  const ctx2 = document.getElementById('distributionChart').getContext('2d');

  const categoryColors = [
    'rgba(30, 60, 114, 0.9)',
    'rgba(42, 82, 152, 0.9)',
    'rgba(33, 150, 243, 0.9)',
    'rgba(66, 165, 245, 0.9)',
    'rgba(100, 181, 246, 0.9)',
    'rgba(144, 202, 249, 0.9)'
  ];
  
  categoryChart = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: DATA.map(s => s.name),
      datasets: [{
        label: 'Porcentaje de Cumplimiento',
        data: DATA.map(() => 0),
        backgroundColor: categoryColors,
        borderColor: categoryColors.map(c => c.replace('0.9', '1')),
        borderWidth: 2,
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.raw}%`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: function(value) {
              return value + '%';
            },
            font: {
              size: 11
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 10
            }
          }
        }
      }
    },
    plugins: [{
      afterDatasetsDraw: function(chart) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach(function(dataset, i) {
          const meta = chart.getDatasetMeta(i);
          if (!meta.hidden) {
            meta.data.forEach(function(element, index) {
              const value = dataset.data[index];
              
              if (value > 0) {
                ctx.fillStyle = '#1e3c72';
                const fontSize = 12;
                const fontStyle = 'bold';
                const fontFamily = 'Arial';
                ctx.font = Chart.helpers.fontString(fontSize, fontStyle, fontFamily);
                
                const dataString = value + '%';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                
                const padding = value >= 100 ? 8 : 5;
                const position = element.tooltipPosition();
                ctx.fillText(dataString, position.x, position.y - padding);
              }
            });
          }
        });
      }
    }]
  });
  
  distributionChart = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: ['Cumplimiento (C)', 'Cumplimiento Parcial (CP)', 'No Cumple (NC)', 'No Aplica (N/A)'],
      datasets: [{
        data: [0, 0, 0, 0],
        backgroundColor: [
          'rgba(46, 125, 50, 0.85)',
          'rgba(251, 192, 45, 0.85)',
          'rgba(211, 47, 47, 0.85)',
          'rgba(66, 133, 244, 0.85)'
        ],
        borderColor: [
          'rgba(46, 125, 50, 1)',
          'rgba(251, 192, 45, 1)',
          'rgba(211, 47, 47, 1)',
          'rgba(66, 133, 244, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: {
              size: 11
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      }
    },
    plugins: [{
      afterDatasetsDraw: function(chart) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach(function(dataset, i) {
          const meta = chart.getDatasetMeta(i);
          if (!meta.hidden) {
            meta.data.forEach(function(element, index) {
              const data = dataset.data[index];
              const total = dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((data / total) * 100) : 0;
              
              if (percentage > 0) {
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 1;
                ctx.shadowOffsetY = 1;
                
                ctx.fillStyle = '#ffffff';
                
                const fontSize = 14;
                const fontStyle = 'bold';
                const fontFamily = 'Arial';
                ctx.font = Chart.helpers.fontString(fontSize, fontStyle, fontFamily);
                
                const dataString = percentage + '%';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const position = element.tooltipPosition();
                ctx.fillText(dataString, position.x, position.y);
                
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
              }
            });
          }
        });
      }
    }]
  });
}

function updateCharts(results, finalPct) {
  if (categoryChart) {
    categoryChart.data.datasets[0].data = results.map(r => r.percentage);
    categoryChart.update();
  }
  
  let cCount = 0, cpCount = 0, ncCount = 0, naCount = 0;
  
  DATA.forEach(section => {
    section.items.forEach((_, idx) => {
      const radios = document.getElementsByName(makeId(section.name, idx));
      let selectedValue = '';
      for (const r of radios) {
        if (r.checked) selectedValue = r.value;
      }
      
      if (selectedValue === 'C') cCount++;
      else if (selectedValue === 'CP') cpCount++;
      else if (selectedValue === 'NC') ncCount++;
      else if (selectedValue === 'NA') naCount++;
    });
  });
  
  if (distributionChart) {
    distributionChart.data.datasets[0].data = [cCount, cpCount, ncCount, naCount];
    distributionChart.update();
  }
}

// ==================== EVENT LISTENERS ====================
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== INICIANDO APLICACIÓN ===');
  console.log('Versión: 2.0 - ' + new Date().toISOString());
  
  renderChecklist();
  computeResults();
  initializeCharts();
  
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('fecha').value = today;
  
  document.getElementById('generate-report').addEventListener('click', generateComprehensiveReport);
  document.getElementById('export-pdf').addEventListener('click', exportToPDF);
  document.getElementById('save-audit').addEventListener('click', guardarAuditoria);
  document.getElementById('reset-form').addEventListener('click', resetForm);
  
  document.body.addEventListener('change', function(e) { 
    if (e.target.type === 'radio' || e.target.classList.contains('obs-input')) {
      computeResults();
    }
  });
  
  const metaInputs = document.querySelectorAll('.meta-field input, .meta-field select');
  metaInputs.forEach(input => {
    input.addEventListener('change', computeResults);
  });

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('evidenceModal');
    if (event.target === modal) {
      closeEvidenceModal();
    }
  };
});

</script>

</body>
</html>
