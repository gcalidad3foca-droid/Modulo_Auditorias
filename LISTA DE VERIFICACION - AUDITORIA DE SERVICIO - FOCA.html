<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Lista de Verificación de Auditoría - FOCA</title>
<!-- Biblioteca para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
<!-- html2canvas para captura exacta de HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- Biblioteca para exportar a Excel -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Íconos para botones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    color: #2c3e50;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
  }
  
  .card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    overflow: hidden;
    margin-bottom: 20px;
  }
  
  /* Header Styles */
  .header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 24px;
    position: relative;
    overflow: hidden;
  }
  
  .header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: pulse 8s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }
  
  .header-content {
    position: relative;
    z-index: 1;
  }
  
  .logo-section {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
  }
  
  .logo {
    width: 70px;
    height: 70px;
    background: white;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    overflow: hidden;
    padding: 8px;
  }
  
  .logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .org-name {
    flex: 1;
    font-size: 18px;
    font-weight: 600;
    line-height: 1.3;
  }
  
  .title-section {
    text-align: center;
    margin-bottom: 20px;
  }
  
  .main-title {
    font-size: 22px;
    font-weight: 700;
    margin: 0 0 8px 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .subtitle {
    font-size: 13px;
    opacity: 0.9;
    margin: 0;
  }
  
  .header-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-top: 20px;
  }
  
  .header-item {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    border-radius: 10px;
    padding: 12px;
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  .header-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    opacity: 0.9;
  }
  
  .header-value {
    font-size: 15px;
    font-weight: 700;
    color: #fff;
  }
  
  /* Meta Section */
  .meta-section {
    padding: 24px;
    background: #f8f9fa;
  }
  
  .meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }
  
  .meta-field {
    position: relative;
  }
  
  .meta-field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #1e3c72;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .meta-field input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: white;
  }
  
  .meta-field input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  /* Checklist Table */
  .table-container {
    padding: 24px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 14px;
  }
  
  thead {
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  th {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 14px 10px;
    text-align: center;
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
  }
  
  th:first-child {
    border-top-left-radius: 10px;
    text-align: left;
  }
  
  th:last-child {
    border-top-right-radius: 10px;
  }
  
  td {
    padding: 12px 10px;
    border-bottom: 1px solid #e0e0e0;
    background: white;
  }
  
  tr:hover td {
    background: #f8f9fa;
  }
  
  .section-title {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    font-weight: 700;
    font-size: 14px;
    padding: 14px !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .result-row td {
    background: #e8f5e9 !important;
    font-weight: 700;
    color: #2e7d32;
    font-size: 15px;
  }
  
  .radio-cell {
    text-align: center;
  }
  
  .radio-cell input[type="radio"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #667eea;
  }
  
  .obs-input {
    width: 100%;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 8px;
    font-size: 13px;
    transition: border-color 0.3s ease;
  }
  
  .obs-input:focus {
    outline: none;
    border-color: #667eea;
  }
  
  /* Results Section */
  .results-section {
    padding: 24px;
    background: #f8f9fa;
  }
  
  .results-title {
    font-size: 18px;
    font-weight: 700;
    color: #1e3c72;
    margin: 0 0 20px 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .badge {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .weights-table {
    margin-bottom: 24px;
  }
  
  .weights-table tfoot td {
    background: #1e3c72;
    color: white;
    font-weight: 700;
    padding: 16px;
  }
  
  /* Final Score */
  .final-score {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    border-radius: 16px;
    padding: 32px;
    text-align: center;
    color: white;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    margin-bottom: 20px;
    transition: background 0.5s ease;
  }
  
  .final-score-label {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    opacity: 0.9;
  }
  
  .final-score-value {
    font-size: 64px;
    font-weight: 800;
    margin: 0;
    text-shadow: 0 4px 12px rgba(0,0,0,0.3);
    background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .final-score-status {
    font-size: 18px;
    font-weight: 600;
    margin-top: 12px;
    padding: 10px 24px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    display: inline-block;
  }
  
  .legend-box {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-top: 24px;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .legend-item:last-child {
    border-bottom: none;
  }
  
  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 12px;
    flex-shrink: 0;
  }
  
  .legend-text {
    font-size: 13px;
    color: #2c3e50;
    flex: 1;
  }
  
  .legend-text strong {
    font-weight: 700;
    color: #1e3c72;
  }
  
  /* Panel de Botones de Exportación */
  .export-buttons-container {
    background: white;
    padding: 20px;
    border-top: 2px solid #e0e0e0;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .export-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 24px;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 200px;
    justify-content: center;
  }
  
  .export-btn i {
    font-size: 18px;
  }
  
  .btn-pdf {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
  }
  
  .btn-pdf:hover {
    background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(244, 67, 54, 0.3);
  }
  
  .btn-excel {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
  }
  
  .btn-excel:hover {
    background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(76, 175, 80, 0.3);
  }
  
  .btn-reset {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
  }
  
  .btn-reset:hover {
    background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(255, 152, 0, 0.3);
  }
  
  /* Gráficos de Visualización */
  .charts-section {
    margin-top: 30px;
  }
  
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .chart-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  
  .chart-title {
    font-size: 16px;
    font-weight: 700;
    color: #1e3c72;
    margin: 0 0 15px 0;
    text-align: center;
  }
  
  .chart-wrapper {
    position: relative;
    height: 250px;
  }
  
  /* Notificaciones */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    transform: translateY(100px);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  
  .notification.show {
    transform: translateY(0);
    opacity: 1;
  }
  
  .notification-success {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
  }
  
  .notification-error {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
  }
  
  .notification-info {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .container { padding: 12px; }
    .header { padding: 20px 16px; }
    .logo { width: 60px; height: 60px; font-size: 20px; }
    .org-name { font-size: 15px; }
    .main-title { font-size: 18px; }
    .subtitle { font-size: 12px; }
    .header-grid { grid-template-columns: repeat(2, 1fr); }
    .table-container { padding: 16px; }
    
    table { font-size: 12px; }
    th, td { padding: 10px 6px; }
    th { font-size: 11px; }
    
    .section-title { font-size: 12px; }
    .final-score { padding: 24px 16px; }
    .final-score-value { font-size: 48px; }
    .final-score-status { font-size: 15px; }
    
    th:last-child, td:last-child { 
      min-width: 150px;
    }
    
    .export-buttons-container {
      flex-direction: column;
      align-items: center;
    }
    
    .export-btn {
      width: 100%;
      max-width: 300px;
    }
    
    .charts-grid {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 480px) {
    .header-grid { grid-template-columns: 1fr; }
    .meta-grid { grid-template-columns: 1fr; }
    th, td { padding: 8px 4px; font-size: 11px; }
    .radio-cell input[type="radio"] { width: 18px; height: 18px; }
    
    .export-btn {
      min-width: auto;
      width: 100%;
      padding: 12px 16px;
      font-size: 14px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="header-content">
          <div class="logo-section">
            <div class="logo">
  <img src="https://i.imgur.com/3WZzeT6.png" alt="Logo FOCA">
</div>
            <div class="org-name">FUNDACIÓN OFTALMOLÓGICA DEL CARIBE</div>
          </div>
          <div class="title-section">
            <h1 class="main-title">LISTA DE VERIFICACIÓN DE AUDITORÍA DE SERVICIO</h1>
            <p class="subtitle">Sistema de Evaluación y Control de Calidad</p>
          </div>
          <div class="header-grid">
            <div class="header-item">
              <div class="header-label">Código</div>
              <div class="header-value">F-FSYM-823</div>
            </div>
            <div class="header-item">
              <div class="header-label">Versión</div>
              <div class="header-value">005</div>
            </div>
            <div class="header-item">
              <div class="header-label">Vigencia</div>
              <div class="header-value">2025-06-01</div>
            </div>
          </div>
        </div>
      </div>

      <div class="meta-section">
        <div class="meta-grid">
          <div class="meta-field">
            <label>Fecha de Auditoría</label>
            <input type="date" id="fecha">
          </div>
          <div class="meta-field">
            <label>Sede</label>
            <input type="text" id="sede" placeholder="Ingrese la sede">
          </div>
          <div class="meta-field">
            <label>Auditor</label>
            <input type="text" id="auditor" placeholder="Nombre del auditor">
          </div>
        </div>
      </div>

      <div class="table-container">
        <table id="checklist">
          <thead>
            <tr>
              <th style="width:40%;">ASPECTOS A EVALUAR</th>
              <th style="width:8%;">C</th>
              <th style="width:8%;">CP</th>
              <th style="width:8%;">NC</th>
              <th style="width:8%;">N/A</th>
              <th style="width:28%;">OBSERVACIONES</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="results-section">
        <h2 class="results-title">
          META DE SEGURIDAD
          <span class="badge">Resultados por Criterio</span>
        </h2>
        
        <table class="weights-table" id="weights">
          <thead>
            <tr>
              <th style="width:30%;">Criterio</th>
              <th style="width:15%;">Ponderación</th>
              <th style="width:15%;">Resultado %</th>
              <th>Estado de Cumplimiento</th>
            </tr>
          </thead>
          <tbody id="weights-body"></tbody>
        </table>

        <div class="final-score">
          <div class="final-score-label">Resultado Final de Auditoría</div>
          <div class="final-score-value" id="total-pct">0%</div>
          <div class="final-score-status" id="final-status">Sin evaluar</div>
          
          <div class="legend-box">
            <div class="legend-item">
              <div class="legend-dot" style="background: #4caf50;"></div>
              <div class="legend-text"><strong>100%</strong> – Cumplimiento total, no requiere acción</div>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: #8bc34a;"></div>
              <div class="legend-text"><strong>80% - 99%</strong> – Riesgo Bajo, requiere seguimiento</div>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: #ff9800;"></div>
              <div class="legend-text"><strong>60% - 79%</strong> – Riesgo Medio, requiere plan de acción</div>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: #f44336;"></div>
              <div class="legend-text"><strong>0% - 59%</strong> – Riesgo Alto, intervención inmediata</div>
            </div>
          </div>
        </div>

        <div class="charts-section">
          <h2 class="results-title">
            <i class="fas fa-chart-bar"></i>
            Visualización de Resultados
          </h2>
          
          <div class="charts-grid">
            <div class="chart-container">
              <h3 class="chart-title">Resultados por Categoría</h3>
              <div class="chart-wrapper">
                <canvas id="categoryChart"></canvas>
              </div>
            </div>
            
            <div class="chart-container">
              <h3 class="chart-title">Distribución de Evaluaciones</h3>
              <div class="chart-wrapper">
                <canvas id="distributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="export-buttons-container">
        <button class="export-btn btn-pdf" id="export-pdf">
          <i class="fas fa-file-pdf"></i>
          Exportar a PDF
        </button>
        
        <button class="export-btn btn-excel" id="export-excel">
          <i class="fas fa-file-excel"></i>
          Exportar a Excel
        </button>
        
        <button class="export-btn btn-reset" id="reset-form">
          <i class="fas fa-redo-alt"></i>
          Restablecer Formulario
        </button>

        <button class="export-btn" onclick="guardarAuditoria()">
        <i class="fas fa-save"></i>
         Guardar Auditoría
        </button>
      </div>
    </div>
  </div>

  <div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-text">Operación completada con éxito</span>
  </div>

<script>
const DATA = [
  {
    "name": "ADMISIÓN",
    "weight": 0.25,
    "items": [
      "Verificar el saludo de bienvenida al usuario",
      "Verificar si el tiempo de atención está en el estándar establecido (3 a 5 min)",
      "Verificar identidad del usuario a través de solicitud de documento de identidad",
      "Verificar actualización de datos del paciente",
      "Verificación del servicio a prestar",
      "Verificar diligenciamiento correcto del nivel y valor de cuota moderadora / copago",
      "Verificar comprensión de la información, incluyendo dudas por parte del paciente/familiar",
      "Verificar invitación al buzón de sugerencias al paciente",
      "Verificar cumplimiento de la caja preferencial (demarcada con movilidad reducida, mujeres embarazadas y niños de brazos)"
    ]
  },
  {
    "name": "PRESTACIÓN DEL SERVICIO",
    "weight": 0.2,
    "items": [
      "Verificar saludo y presentación por parte del equipo médico",
      "Verificar educación al paciente y/o cuidador sobre riesgos y beneficios de la dilatación ocular",
      "Verificar si el tiempo de atención está en el estándar establecido. Oftalmología (Max 20min - Min 10) Optometría (Max 10Min- 5Min)",
      "Verificar entrega y comprensión del profesional en cuanto a diagnóstico, plan de tratamiento, prescripción médica, remisiones, órdenes de estudios diagnósticos y cirugía si tuviera lugar",
      "Verificar entrega efectiva de copias impresas del ordenamiento médico, incluye recomendaciones universales"
    ]
  },
  {
    "name": "SEGURIDAD DEL PACIENTE",
    "weight": 0.15,
    "items": [
      "Verificar que los medicamentos en uso se encuentren rotulados y no superen los 30 días de apertura",
      "Verificar que los insumos se encuentran debidamente rotulados incluyendo: nombre del producto, fecha de apertura, fecha de vencimiento y número de lote",
      "Verificar instalación de señalética de seguridad del paciente en consultorio y baños: QR, correcto lavado de manos y los 5 momentos de lavado de manos",
      "Verificar la correcta aplicación del protocolo de lavado de manos durante la consulta",
      "Validar si existe alguna condición o situación que pueda representar un riesgo para la seguridad de los pacientes",
      "Verificar que los formatos de registro de temperatura y humedad estén correctamente diligenciados y al día"
    ]
  },
  {
    "name": "AMBIENTE HUMANIZADO",
    "weight": 0.2,
    "items": [
      "Verificar el confort térmico en áreas como SIAU, sala de espera y consulta externa al momento de la presente auditoría",
      "Verificar la existencia de ruido y/o información visual exagerada en las áreas inspeccionadas",
      "Verificar disponibilidad de sillas de acuerdo al número de pacientes al momento de realizar la auditoría",
      "Verificar señalización de áreas y personas claves para las actividades de: Ingreso, admisión y consulta",
      "Verificación de segregación de residuos",
      "Verificación de limpieza, organización y cumplimiento del cuarto de residuos según los estándares de habilitación",
      "Verificación de limpieza del puesto de trabajo (asesores auxiliares, coordinador, sede)",
      "Verificación de limpieza en el área de sala de espera",
      "Verificación de limpieza en los consultorios elegidos por el auditor",
      "Verificación de limpieza en los baños de la institución",
      "Verificación de limpieza y orden en la zona del exterior de la sede",
      "Verificar instalación y funcionamiento del sistema de alarma en los baños para discapacitados"
    ]
  },
  {
    "name": "PQRS",
    "weight": 0.1,
    "items": [
      "Verificar buzón encendido",
      "Verificar papelería en el buzón",
      "Verificar funcionamiento del aplicativo",
      "Solicitar y verificar últimas aperturas de Buzón en el mes"
    ]
  },
  {
    "name": "PROTOCOLO DE IMAGEN",
    "weight": 0.1,
    "items": [
      "Verificar porte individual de carnet",
      "Verificar uso de accesorios discretos",
      "Verificar restricciones en usos de abrigos, bufandas y buzos de colores diferentes al negro",
      "Revisar uñas, peinado y maquillaje acorde al protocolo de imagen"
    ]
  }
];

const SCORE = { C: 1, CP: 0.5, NC: 0 };
let categoryChart, distributionChart;

function makeId(str, idx) {
  return str.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '-' + idx;
}

function renderChecklist() {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  
  DATA.forEach(section => {
    const trTitle = document.createElement('tr');
    const tdTitle = document.createElement('td');
    tdTitle.colSpan = 6;
    tdTitle.className = 'section-title';
    tdTitle.textContent = section.name;
    trTitle.appendChild(tdTitle);
    tbody.appendChild(trTitle);

    section.items.forEach((text, idx) => {
      const row = document.createElement('tr');
      const tdAspect = document.createElement('td');
      tdAspect.textContent = text;
      row.appendChild(tdAspect);

      ['C','CP','NC','NA'].forEach(mark => {
        const td = document.createElement('td');
        td.className = 'radio-cell';
        td.innerHTML = '<input type="radio" name="' + makeId(section.name, idx) + '" value="' + mark + '">';
        row.appendChild(td);
      });

      const tdObs = document.createElement('td');
      tdObs.innerHTML = '<input type="text" class="obs-input" placeholder="Observaciones...">';
      row.appendChild(tdObs);
      tbody.appendChild(row);
    });

    const trRes = document.createElement('tr');
    trRes.className = 'result-row';
    const tdResLbl = document.createElement('td');
    tdResLbl.textContent = 'Resultado %';
    const tdResVal = document.createElement('td');
    tdResVal.colSpan = 5;
    tdResVal.className = 'radio-cell';
    tdResVal.id = 'result-' + makeId(section.name, 0);
    tdResVal.textContent = '0%';
    trRes.appendChild(tdResLbl);
    trRes.appendChild(tdResVal);
    tbody.appendChild(trRes);
  });
}

function computeResults() {
  const results = [];
  
  DATA.forEach(section => {
    const nameId = makeId(section.name, 0);
    let sum = 0, n = 0;
    section.items.forEach((_, idx) => {
      const radios = document.getElementsByName(makeId(section.name, idx));
      let chosen = null;
      for (const r of radios) if (r.checked) chosen = r.value;
      if (chosen && chosen !== 'NA') { sum += SCORE[chosen]; n += 1; }
    });
    const pct = n > 0 ? Math.round((sum / n) * 100) : 0;
    const el = document.getElementById('result-' + nameId);
    if (el) el.textContent = pct + '%';
    
    results.push({
      name: section.name,
      weight: section.weight,
      percentage: pct
    });
  });

  const wtbody = document.getElementById('weights-body');
  wtbody.innerHTML = '';
  let totalsum = 0;
  
  results.forEach(result => {
    const weight = Number(result.weight || 0);
    const pct = result.percentage;
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>'+result.name+'</td><td class="radio-cell">'+Math.round(weight*100)+'%</td><td class="radio-cell">'+pct+'%</td><td>'+legendFor(pct)+'</td>';
    wtbody.appendChild(tr);
    totalsum += (pct/100) * weight;
  });
  
  const finalPct = Math.round(totalsum * 100);
  document.getElementById('total-pct').textContent = finalPct + '%';
  document.getElementById('final-status').textContent = legendFor(finalPct);
  
  const finalScore = document.querySelector('.final-score');
  if (finalPct >= 100) {
    finalScore.style.background = 'linear-gradient(135deg, #4caf50 0%, #66bb6a 100%)';
  } else if (finalPct >= 80) {
    finalScore.style.background = 'linear-gradient(135deg, #8bc34a 0%, #9ccc65 100%)';
  } else if (finalPct >= 60) {
    finalScore.style.background = 'linear-gradient(135deg, #ff9800 0%, #ffa726 100%)';
  } else {
    finalScore.style.background = 'linear-gradient(135deg, #f44336 0%, #ef5350 100%)';
  }
  
  updateCharts(results, finalPct);
  
  return { results, finalPct };
}

function legendFor(pct) {
  if (pct >= 100) return 'Cumplimiento Total';
  if (pct >= 80) return 'Riesgo Bajo';
  if (pct >= 60) return 'Riesgo Medio';
  return 'Riesgo Alto';
}

function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notification-text');
  
  notificationText.textContent = message;
  notification.className = `notification notification-${type} show`;
  
  const icon = notification.querySelector('i');
  if (type === 'error') {
    icon.className = 'fas fa-exclamation-circle';
  } else if (type === 'info') {
    icon.className = 'fas fa-info-circle';
  } else {
    icon.className = 'fas fa-check-circle';
  }
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// ==================== EXPORTACIÓN A PDF ====================
async function exportToPDF() {
  try {
    showNotification('Generando PDF', 'info');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);
    let yPos = margin;
    
    // Obtener datos
    const fecha = document.getElementById('fecha').value || 'No especificada';
    const sede = document.getElementById('sede').value || 'No especificada';
    const auditor = document.getElementById('auditor').value || 'No especificado';
    const { results, finalPct } = computeResults();
    
    // ===== FUNCIÓN PARA VERIFICAR ESPACIO Y AGREGAR PÁGINA =====
    function checkPageBreak(requiredSpace) {
      if (yPos + requiredSpace > pageHeight - margin) {
        doc.addPage();
        yPos = margin;
        return true;
      }
      return false;
    }
    
    // ===== ENCABEZADO PRINCIPAL =====
    doc.setFillColor(30, 60, 114);
    doc.rect(0, 0, pageWidth, 65, 'F');
    
    // Logo y nombre
    
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(margin, 12, 20, 20, 3, 3, 'F');
    
    // Agregar logo como imagen
    try {
      const logoImg = document.querySelector('.logo img');
      if (logoImg && logoImg.complete) {
        doc.addImage(logoImg.src, 'PNG', margin + 2, 14, 16, 16);
      } else {
        // Fallback si no carga la imagen
        doc.setTextColor(30, 60, 114);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('FOCA', margin + 10, 24, { align: 'center' });
      }
    } catch (error) {
      // Fallback en caso de error
      doc.setTextColor(30, 60, 114);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('FOCA', margin + 10, 24, { align: 'center' });
    }
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('FUNDACIÓN OFTALMOLÓGICA DEL CARIBE', pageWidth / 2, 22, { align: 'center' });
    
    // Título principal
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('LISTA DE VERIFICACIÓN DE AUDITORÍA DE SERVICIO', pageWidth / 2, 38, { align: 'center' });
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Sistema de Evaluación y Control de Calidad', pageWidth / 2, 45, { align: 'center' });
    
    // Información de cabecera
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.text('Código: ', margin, 56);
    doc.setFont('helvetica', 'normal');
    doc.text('F-FSYM-823', margin + 15, 56);
    
    doc.setFont('helvetica', 'bold');
    doc.text('Versión: ', pageWidth / 2 - 10, 56);
    doc.setFont('helvetica', 'normal');
    doc.text('005', pageWidth / 2 + 5, 56);
    
    doc.setFont('helvetica', 'bold');
    doc.text('Vigencia: ', pageWidth - 45, 56);
    doc.setFont('helvetica', 'normal');
    doc.text('2025-06-01', pageWidth - 25, 56);
    
    yPos = 75;
    
    // ===== INFORMACIÓN DE LA AUDITORÍA =====
    doc.setFillColor(248, 249, 250);
    doc.rect(margin, yPos, contentWidth, 28, 'F');
    
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    
    doc.text('FECHA DE AUDITORÍA:', margin + 3, yPos + 7);
    doc.setFont('helvetica', 'normal');
    doc.text(fecha, margin + 3, yPos + 12);
    
    doc.setFont('helvetica', 'bold');
    doc.text('SEDE:', margin + 3, yPos + 19);
    doc.setFont('helvetica', 'normal');
    doc.text(sede, margin + 3, yPos + 24);
    
    
    doc.setFont('helvetica', 'bold');
    doc.text('AUDITOR:', pageWidth / 2 + 5, yPos + 19);
    doc.setFont('helvetica', 'normal');
    doc.text(auditor, pageWidth / 2 + 5, yPos + 24);
    
    yPos += 35;
    
    // ===== LISTA DE VERIFICACIÓN CON AUTOTABLE =====
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('LISTA DE VERIFICACIÓN', margin, yPos);
    yPos += 7;
    
    // Preparar datos para la tabla
    const tableData = [];
    
    DATA.forEach(section => {
      // Fila de sección
      tableData.push([{
        content: section.name,
        colSpan: 6,
        styles: { 
          fillColor: [102, 126, 234], 
          textColor: [255, 255, 255], 
          fontStyle: 'bold',
          fontSize: 9,
          halign: 'left'
        }
      }]);
      
      // Ítems de la sección
      section.items.forEach((item, idx) => {
        const radios = document.getElementsByName(makeId(section.name, idx));
        let selectedValue = '';
        for (const r of radios) {
          if (r.checked) selectedValue = r.value;
        }
        
        // Buscar observación
        const allRows = document.querySelectorAll('#tbody tr');
        let observation = '';
        for (const row of allRows) {
          const firstCell = row.cells[0];
          if (firstCell && firstCell.textContent === item) {
            const obsInput = row.querySelector('.obs-input');
            if (obsInput) observation = obsInput.value;
            break;
          }
        }
        
        tableData.push([
          item,
          selectedValue === 'C' ? 'C' : '',
          selectedValue === 'CP' ? 'CP' : '',
          selectedValue === 'NC' ? 'NC' : '',
          selectedValue === 'NA' ? 'N/A' : '',
          observation
        ]);
      });
      
      // Resultado de la sección
      const resultEl = document.getElementById('result-' + makeId(section.name, 0));
      const resultPct = resultEl ? resultEl.textContent : '0%';
      
      tableData.push([{
        content: 'Resultado %',
        styles: { fillColor: [232, 245, 233], textColor: [46, 125, 50], fontStyle: 'bold' }
      }, '', '', '', '', {
        content: resultPct,
        styles: { fillColor: [232, 245, 233], textColor: [46, 125, 50], fontStyle: 'bold', halign: 'right' }
      }]);
    });
    
    doc.autoTable({
      startY: yPos,
      head: [[
        { content: 'ASPECTOS A EVALUAR', styles: { halign: 'left' } },
        'C',
        'CP',
        'NC',
        'N/A',
        'OBSERVACIONES'
      ]],
      body: tableData,
      theme: 'grid',
      headStyles: {
        fillColor: [30, 60, 114],
        textColor: [255, 255, 255],
        fontSize: 8,
        fontStyle: 'bold',
        halign: 'center'
      },
      bodyStyles: {
        fontSize: 7,
        textColor: [44, 62, 80]
      },
      columnStyles: {
        0: { cellWidth: 85, halign: 'left' },
        1: { cellWidth: 8, halign: 'center' },
        2: { cellWidth: 8, halign: 'center' },
        3: { cellWidth: 8, halign: 'center' },
        4: { cellWidth: 8, halign: 'center' },
        5: { cellWidth: 'auto', halign: 'left' }
      },
      margin: { left: margin, right: margin },
      didDrawPage: function(data) {
        yPos = data.cursor.y;
      }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
    
    // ===== NUEVA PÁGINA PARA RESULTADOS =====
    doc.addPage();
    yPos = margin;
    
    // ===== RESULTADOS POR CRITERIO =====
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('META DE SEGURIDAD', pageWidth / 2, yPos, { align: 'center' });
    
    yPos += 8;
    doc.setFontSize(10);
    doc.text('Resultados por Criterio', pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;
    
    // Tabla de resultados
    const resultsTableData = results.map(result => [
      result.name,
      `${Math.round(result.weight * 100)}%`,
      `${result.percentage}%`,
      legendFor(result.percentage)
    ]);
    
    doc.autoTable({
      startY: yPos,
      head: [['Criterio', 'Ponderación', 'Resultado %', 'Estado de Cumplimiento']],
      body: resultsTableData,
      theme: 'grid',
      headStyles: {
        fillColor: [30, 60, 114],
        textColor: [255, 255, 255],
        fontSize: 9,
        fontStyle: 'bold',
        halign: 'center'
      },
      bodyStyles: {
        fontSize: 8,
        textColor: [44, 62, 80]
      },
      columnStyles: {
        0: { cellWidth: 65, halign: 'left' },
        1: { cellWidth: 30, halign: 'center' },
        2: { cellWidth: 30, halign: 'center' },
        3: { cellWidth: 'auto', halign: 'center' }
      },
      margin: { left: margin, right: margin }
    });
    
    yPos = doc.lastAutoTable.finalY + 15;
    
    // ===== RESULTADO FINAL =====
    const status = legendFor(finalPct);
    let bgColor;
    if (finalPct >= 100) bgColor = [76, 175, 80];
    else if (finalPct >= 80) bgColor = [139, 195, 74];
    else if (finalPct >= 60) bgColor = [255, 152, 0];
    else bgColor = [244, 67, 54];
    
    checkPageBreak(55);
    
    doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
    doc.roundedRect(margin + 10, yPos, contentWidth - 20, 45, 3, 3, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('RESULTADO FINAL DE AUDITORÍA', pageWidth / 2, yPos + 10, { align: 'center' });
    
    doc.setFontSize(32);
    doc.text(`${finalPct}%`, pageWidth / 2, yPos + 26, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(status.toUpperCase(), pageWidth / 2, yPos + 38, { align: 'center' });
    
    yPos += 55;
    
    // ===== LEYENDA =====
    checkPageBreak(50);
    
    doc.setDrawColor(224, 224, 224);
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(margin + 10, yPos, contentWidth - 20, 48, 3, 3, 'FD');
    
    doc.setTextColor(44, 62, 80);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    
    const legendItems = [
      { color: [76, 175, 80], text: '100% – Cumplimiento total, no requiere acción' },
      { color: [139, 195, 74], text: '80% - 99% – Riesgo Bajo, requiere seguimiento' },
      { color: [255, 152, 0], text: '60% - 79% – Riesgo Medio, requiere plan de acción' },
      { color: [244, 67, 54], text: '0% - 59% – Riesgo Alto, intervención inmediata' }
    ];
    
    legendItems.forEach((item, index) => {
      const legendY = yPos + 10 + (index * 10);
      
      doc.setFillColor(item.color[0], item.color[1], item.color[2]);
      doc.circle(margin + 15, legendY - 1, 2, 'F');
      
      doc.setTextColor(44, 62, 80);
      doc.text(item.text, margin + 20, legendY);
    });
    
    yPos += 58;
    
    // ===== GRÁFICAS =====
    checkPageBreak(120);
    
    doc.setTextColor(30, 60, 114);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('VISUALIZACIÓN DE RESULTADOS', pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;
    
    try {
      // Esperar un momento para que los gráficos se rendericen completamente
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Capturar gráfico de categorías con máxima calidad profesional
      const categoryCanvas = document.getElementById('categoryChart');
      if (categoryCanvas) {
        // Crear canvas temporal con resolución profesional 5K
        const tempCanvas = document.createElement('canvas');
        const scale = 5; // Factor de escala 5x para calidad profesional
        tempCanvas.width = categoryCanvas.width * scale;
        tempCanvas.height = categoryCanvas.height * scale;
        const tempCtx = tempCanvas.getContext('2d', { alpha: false });
        
        // Configuración para máxima calidad
        tempCtx.imageSmoothingEnabled = true;
        tempCtx.imageSmoothingQuality = 'high';
        
        // Fondo blanco para evitar transparencias
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        tempCtx.scale(scale, scale);
        tempCtx.drawImage(categoryCanvas, 0, 0);
        
        const categoryImgData = tempCanvas.toDataURL('image/png', 1.0);
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(30, 60, 114);
        doc.text('Resultados por Categoría', margin, yPos);
        yPos += 5;
        
        // Gráfica optimizada profesionalmente
        const chartWidth = contentWidth * 0.85;
        const chartHeight = 60;
        const xOffset = (contentWidth - chartWidth) / 2;
        doc.addImage(categoryImgData, 'PNG', margin + xOffset, yPos, chartWidth, chartHeight, 'categoryChart', 'SLOW');
        yPos += chartHeight + 12;
      }
      
      // Verificar espacio para segundo gráfico
      checkPageBreak(75);
      
      // Capturar gráfico de distribución con máxima calidad profesional
      const distributionCanvas = document.getElementById('distributionChart');
      if (distributionCanvas) {
        // Crear canvas temporal con resolución profesional 5K
        const tempCanvas = document.createElement('canvas');
        const scale = 5; // Factor de escala 5x para calidad profesional
        tempCanvas.width = distributionCanvas.width * scale;
        tempCanvas.height = distributionCanvas.height * scale;
        const tempCtx = tempCanvas.getContext('2d', { alpha: false });
        
        // Configuración para máxima calidad
        tempCtx.imageSmoothingEnabled = true;
        tempCtx.imageSmoothingQuality = 'high';
        
        // Fondo blanco para evitar transparencias
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        tempCtx.scale(scale, scale);
        tempCtx.drawImage(distributionCanvas, 0, 0);
        
        const distributionImgData = tempCanvas.toDataURL('image/png', 1.0);
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(30, 60, 114);
        doc.text('Distribución de Evaluaciones', margin, yPos);
        yPos += 5;
        
        // Gráfica optimizada profesionalmente
        const chartWidth = contentWidth * 0.85;
        const chartHeight = 60;
        const xOffset = (contentWidth - chartWidth) / 2;
        doc.addImage(distributionImgData, 'PNG', margin + xOffset, yPos, chartWidth, chartHeight, 'distributionChart', 'SLOW');
      }
    } catch (error) {
      console.warn('No se pudieron capturar las gráficas:', error);
      doc.setFontSize(8);
      doc.setTextColor(128, 128, 128);
      doc.setFont('helvetica', 'italic');
      doc.text('(Las gráficas no pudieron ser generadas)', margin, yPos);
    }
    
    // ===== PIE DE PÁGINA EN TODAS LAS PÁGINAS =====
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.setFont('helvetica', 'normal');
    
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.text(`Página ${i} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
      doc.text(`Generado: ${new Date().toLocaleDateString('es-CO')}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
    }
    
    // ===== GUARDAR PDF =====
    const fileName = `Auditoria_Servicio_${fecha.replace(/-/g, '')}_${sede.replace(/\s+/g, '_')}.pdf`;
    doc.save(fileName);
    
    showNotification('PDF exportado exitosamente con texto seleccionable', 'success');
  } catch (error) {
    console.error('Error al exportar PDF:', error);
    showNotification('Error al exportar PDF: ' + error.message, 'error');
  }
}

// ==================== EXPORTACIÓN A EXCEL ====================
async function exportToExcel() {
  try {
    showNotification('Generando archivo Excel profesional...', 'info');
    
    const fecha = document.getElementById('fecha').value || 'No especificada';
    const sede = document.getElementById('sede').value || 'No especificada';
    const servicio = document.getElementById('servicio').value || 'No especificado';
    const auditor = document.getElementById('auditor').value || 'No especificado';
    
    const { results, finalPct } = computeResults();
    
    let cCount = 0, cpCount = 0, ncCount = 0, naCount = 0;
    
    DATA.forEach(section => {
      section.items.forEach((_, idx) => {
        const radios = document.getElementsByName(makeId(section.name, idx));
        let selectedValue = '';
        for (const r of radios) {
          if (r.checked) selectedValue = r.value;
        }
        
        if (selectedValue === 'C') cCount++;
        else if (selectedValue === 'CP') cpCount++;
        else if (selectedValue === 'NC') ncCount++;
        else if (selectedValue === 'NA') naCount++;
      });
    });
    
    const wb = XLSX.utils.book_new();
    const allData = [];
    
    allData.push([{v: 'FUNDACIÓN OFTALMOLÓGICA DEL CARIBE', s: {font: {bold: true, sz: 18, color: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}}]);
    allData.push([{v: 'LISTA DE VERIFICACIÓN DE AUDITORÍA DE SERVICIO', s: {font: {bold: true, sz: 14, color: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}}]);
    allData.push([{v: 'Sistema de Evaluación y Control de Calidad', s: {font: {sz: 11, color: {rgb: "666666"}}, alignment: {horizontal: 'center'}}}]);
    allData.push([]);
    
    allData.push(['Código: F-FSYM-823', '', 'Versión: 005', '', 'Vigencia: 2025-06-01']);
    allData.push([]);
    
    allData.push([{v: 'INFORMACIÓN DE LA AUDITORÍA', s: {font: {bold: true, sz: 12}, fill: {fgColor: {rgb: "E8F4F8"}}}}]);
    allData.push(['Fecha de Auditoría:', fecha, '', 'Sede:', sede]);
    allData.push(['Servicio:', servicio, '', 'Auditor:', auditor]);
    allData.push([]);
    
    allData.push([{v: 'LISTA DE VERIFICACIÓN', s: {font: {bold: true, sz: 12, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}}]);
    allData.push([
      {v: 'ASPECTOS A EVALUAR', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}},
      {v: 'C', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}},
      {v: 'CP', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}},
      {v: 'NC', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}},
      {v: 'N/A', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}},
      {v: 'OBSERVACIONES', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}}
    ]);
    
    DATA.forEach(section => {
      allData.push([{v: section.name, s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "667EEA"}}, alignment: {horizontal: 'left'}}}]);
      
      section.items.forEach((item, idx) => {
        const radios = document.getElementsByName(makeId(section.name, idx));
        let selectedValue = '';
        for (const r of radios) {
          if (r.checked) selectedValue = r.value;
        }
        
        const allRows = document.querySelectorAll('#tbody tr');
        let observation = '';
        for (const row of allRows) {
          const firstCell = row.cells[0];
          if (firstCell && firstCell.textContent === item) {
            const obsInput = row.querySelector('.obs-input');
            if (obsInput) observation = obsInput.value;
            break;
          }
        }
        
        const rowData = [
          item,
          selectedValue === 'C' ? '✓' : '',
          selectedValue === 'CP' ? '✓' : '',
          selectedValue === 'NC' ? '✓' : '',
          selectedValue === 'NA' ? '✓' : '',
          observation
        ];
        
        allData.push(rowData);
      });
      
      const resultEl = document.getElementById('result-' + makeId(section.name, 0));
      const resultPct = resultEl ? resultEl.textContent : '0%';
      allData.push([{v: 'Resultado %', s: {font: {bold: true}, fill: {fgColor: {rgb: "E8F5E9"}}}}, '', '', '', '', {v: resultPct, s: {font: {bold: true, color: {rgb: "2E7D32"}}, alignment: {horizontal: 'right'}}}]);
      allData.push([]);
    });
    
    allData.push([]);
    
    allData.push([{v: 'META DE SEGURIDAD - RESULTADOS POR CRITERIO', s: {font: {bold: true, sz: 12, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}}]);
    allData.push([
      {v: 'Criterio', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}}},
      {v: 'Ponderación', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}},
      {v: 'Resultado %', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}},
      {v: 'Estado de Cumplimiento', s: {font: {bold: true, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}}
    ]);
    
    results.forEach(result => {
      allData.push([
        result.name,
        `${Math.round(result.weight * 100)}%`,
        `${result.percentage}%`,
        legendFor(result.percentage)
      ]);
    });
    
    allData.push([]);
    allData.push([]);
    
    const status = legendFor(finalPct);
    allData.push([{v: 'RESULTADO FINAL DE AUDITORÍA', s: {font: {bold: true, sz: 14, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: finalPct >= 80 ? "4CAF50" : finalPct >= 60 ? "FF9800" : "F44336"}}, alignment: {horizontal: 'center'}}}]);
    allData.push([{v: `${finalPct}% - ${status.toUpperCase()}`, s: {font: {bold: true, sz: 18, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: finalPct >= 80 ? "4CAF50" : finalPct >= 60 ? "FF9800" : "F44336"}}, alignment: {horizontal: 'center'}}}]);
    
    allData.push([]);
    allData.push([]);
    
    allData.push([{v: 'LEYENDA DE RESULTADOS', s: {font: {bold: true, sz: 11}, fill: {fgColor: {rgb: "F8F9FA"}}}}]);
    allData.push(['100%', 'Cumplimiento total, no requiere acción']);
    allData.push(['80% - 99%', 'Riesgo Bajo, requiere seguimiento']);
    allData.push(['60% - 79%', 'Riesgo Medio, requiere plan de acción']);
    allData.push(['0% - 59%', 'Riesgo Alto, intervención inmediata']);
    
    allData.push([]);
    allData.push([]);
    
    allData.push([{v: 'ANÁLISIS ESTADÍSTICO', s: {font: {bold: true, sz: 12, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}}]);
    allData.push([]);
    
    const totalEvaluations = cCount + cpCount + ncCount + naCount;
    allData.push(['Tipo de Evaluación', 'Cantidad', 'Porcentaje']);
    if (totalEvaluations > 0) {
      allData.push(['Cumplimiento (C)', cCount, `${Math.round((cCount / totalEvaluations) * 100)}%`]);
      allData.push(['Cumplimiento Parcial (CP)', cpCount, `${Math.round((cpCount / totalEvaluations) * 100)}%`]);
      allData.push(['No Cumple (NC)', ncCount, `${Math.round((ncCount / totalEvaluations) * 100)}%`]);
      allData.push(['No Aplica (N/A)', naCount, `${Math.round((naCount / totalEvaluations) * 100)}%`]);
    } else {
      allData.push(['Cumplimiento (C)', 0, '0%']);
      allData.push(['Cumplimiento Parcial (CP)', 0, '0%']);
      allData.push(['No Cumple (NC)', 0, '0%']);
      allData.push(['No Aplica (N/A)', 0, '0%']);
    }
    
    allData.push([]);
    allData.push([]);
    
    allData.push([{v: 'VISUALIZACIÓN DE RESULTADOS', s: {font: {bold: true, sz: 12, color: {rgb: "FFFFFF"}}, fill: {fgColor: {rgb: "1E3C72"}}, alignment: {horizontal: 'center'}}}]);
    allData.push([]);
    allData.push(['GRÁFICO 1: Resultados por Categoría']);
    allData.push(['Nota: Los gráficos interactivos se visualizan mejor en la versión HTML o PDF']);
    allData.push([]);
    allData.push(['GRÁFICO 2: Distribución de Evaluaciones']);
    allData.push(['Nota: Para una experiencia visual completa, consulte el archivo HTML o PDF']);
    
    const ws = XLSX.utils.aoa_to_sheet(allData);
    
    ws['!cols'] = [
      { wch: 60 },
      { wch: 5 },
      { wch: 5 },
      { wch: 5 },
      { wch: 5 },
      { wch: 40 }
    ];
    
    ws['!rows'] = [];
    ws['!rows'][0] = { hpt: 25 };
    ws['!rows'][1] = { hpt: 20 };
    
    XLSX.utils.book_append_sheet(wb, ws, "Auditoría Completa");
    
    const fileName = `Auditoria_FOCA_${fecha.replace(/-/g, '')}_${sede.replace(/\s+/g, '_')}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    showNotification('Archivo Excel exportado exitosamente con formato profesional', 'success');
  } catch (error) {
    console.error('Error al exportar Excel:', error);
    showNotification('Error al exportar Excel: ' + error.message, 'error');
  }
}

// ==================== RESTABLECER FORMULARIO ====================
function resetForm() {
  if (!confirm('¿Estás seguro de que deseas restablecer el formulario? Se perderán todos los datos ingresados.')) {
    return;
  }
  
  try {
    showNotification('Restableciendo formulario...', 'info');
    
    document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
    document.getElementById('sede').value = '';
    document.getElementById('servicio').value = '';
    document.getElementById('auditor').value = '';
    
    const allRadios = document.querySelectorAll('input[type="radio"]');
    allRadios.forEach(radio => {
      radio.checked = false;
    });
    
    const allObsInputs = document.querySelectorAll('.obs-input');
    allObsInputs.forEach(input => {
      input.value = '';
    });
    
    computeResults();
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    showNotification('Formulario restablecido exitosamente', 'success');
  } catch (error) {
    console.error('Error al restablecer formulario:', error);
    showNotification('Error al restablecer formulario', 'error');
  }
}

// ==================== GRÁFICOS ====================
function initializeCharts() {
  const ctx1 = document.getElementById('categoryChart').getContext('2d');
  const ctx2 = document.getElementById('distributionChart').getContext('2d');
  
  // Gama de colores azules
  const categoryColors = [
    'rgba(30, 60, 114, 0.9)',      // Azul oscuro
    'rgba(42, 82, 152, 0.9)',      // Azul medio oscuro
    'rgba(33, 150, 243, 0.9)',     // Azul medio
    'rgba(66, 165, 245, 0.9)',     // Azul claro
    'rgba(100, 181, 246, 0.9)',    // Azul muy claro
    'rgba(144, 202, 249, 0.9)'     // Azul pálido
  ];
  
  categoryChart = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: DATA.map(s => s.name),
      datasets: [{
        label: 'Porcentaje de Cumplimiento',
        data: DATA.map(() => 0),
        backgroundColor: categoryColors,
        borderColor: categoryColors.map(c => c.replace('0.9', '1')),
        borderWidth: 2,
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.raw}%`;
            }
          }
        },
        datalabels: {
          anchor: 'end',
          align: 'top',
          formatter: function(value) {
            return value + '%';
          },
          color: '#1e3c72',
          font: {
            weight: 'bold',
            size: 12
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: function(value) {
              return value + '%';
            },
            font: {
              size: 11
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 10
            }
          }
        }
      }
    },
    plugins: [{
      afterDatasetsDraw: function(chart) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach(function(dataset, i) {
          const meta = chart.getDatasetMeta(i);
          if (!meta.hidden) {
            meta.data.forEach(function(element, index) {
              const value = dataset.data[index];
              
              // Solo mostrar si hay valor
              if (value > 0) {
                ctx.fillStyle = '#1e3c72';
                const fontSize = 12;
                const fontStyle = 'bold';
                const fontFamily = 'Arial';
                ctx.font = Chart.helpers.fontString(fontSize, fontStyle, fontFamily);
                
                const dataString = value + '%';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                
                const padding = value >= 100 ? 8 : 5; // Más espacio si es 100%
                const position = element.tooltipPosition();
                ctx.fillText(dataString, position.x, position.y - padding);
              }
            });
          }
        });
      }
    }]
  });
  
  distributionChart = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: ['Cumplimiento (C)', 'Cumplimiento Parcial (CP)', 'No Cumple (NC)', 'No Aplica (N/A)'],
      datasets: [{
        data: [0, 0, 0, 0],
        backgroundColor: [
          'rgba(33, 150, 243, 0.9)',   // Azul brillante
          'rgba(66, 165, 245, 0.9)',   // Azul medio claro
          'rgba(100, 181, 246, 0.9)',  // Azul claro
          'rgba(144, 202, 249, 0.9)'   // Azul muy claro
        ],
        borderColor: [
          'rgba(33, 150, 243, 1)',
          'rgba(66, 165, 245, 1)',
          'rgba(100, 181, 246, 1)',
          'rgba(144, 202, 249, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: {
              size: 11
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      }
    },
    plugins: [{
      afterDatasetsDraw: function(chart) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach(function(dataset, i) {
          const meta = chart.getDatasetMeta(i);
          if (!meta.hidden) {
            meta.data.forEach(function(element, index) {
              const data = dataset.data[index];
              const total = dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((data / total) * 100) : 0;
              
              if (percentage > 0) {
                // Texto blanco con sombra para mejor legibilidad
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 1;
                ctx.shadowOffsetY = 1;
                
                ctx.fillStyle = '#ffffff';
                
                const fontSize = 14;
                const fontStyle = 'bold';
                const fontFamily = 'Arial';
                ctx.font = Chart.helpers.fontString(fontSize, fontStyle, fontFamily);
                
                const dataString = percentage + '%';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const position = element.tooltipPosition();
                
                // Dibujar texto con sombra
                ctx.fillText(dataString, position.x, position.y);
                
                // Resetear sombra
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
              }
            });
          }
        });
      }
    }]
  });
}

function updateCharts(results, finalPct) {
  if (categoryChart) {
    categoryChart.data.datasets[0].data = results.map(r => r.percentage);
    categoryChart.update();
  }
  
  let cCount = 0, cpCount = 0, ncCount = 0, naCount = 0;
  
  DATA.forEach(section => {
    section.items.forEach((_, idx) => {
      const radios = document.getElementsByName(makeId(section.name, idx));
      let selectedValue = '';
      for (const r of radios) {
        if (r.checked) selectedValue = r.value;
      }
      
      if (selectedValue === 'C') cCount++;
      else if (selectedValue === 'CP') cpCount++;
      else if (selectedValue === 'NC') ncCount++;
      else if (selectedValue === 'NA') naCount++;
    });
  });
  
  if (distributionChart) {
    distributionChart.data.datasets[0].data = [cCount, cpCount, ncCount, naCount];
    distributionChart.update();
  }
}

// ==================== EVENT LISTENERS ====================
document.addEventListener('DOMContentLoaded', function() {
  renderChecklist();
  computeResults();
  initializeCharts();
  
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('fecha').value = today;
  
  document.getElementById('export-pdf').addEventListener('click', exportToPDF);
  document.getElementById('export-excel').addEventListener('click', exportToExcel);
  document.getElementById('reset-form').addEventListener('click', resetForm);
  
  document.body.addEventListener('change', function(e) { 
    if (e.target.type === 'radio' || e.target.classList.contains('obs-input')) {
      computeResults();
    }
  });
  
  const metaInputs = document.querySelectorAll('.meta-field input');
  metaInputs.forEach(input => {
    input.addEventListener('change', computeResults);
  });
});

function guardarAuditoria() {

  const resultado = computeResults();

  const payload = {
    id: crypto.randomUUID(),
    fecha: document.getElementById("fecha").value,
    sede: document.getElementById("sede").value,
    servicio: document.getElementById("servicio").value,
    auditor: document.getElementById("auditor").value,
    porcentaje_final: resultado.finalPct,
    estado: legendFor(resultado.finalPct),
    items: []
  };

  DATA.forEach(section => {
    section.items.forEach((item, idx) => {

      const radios = document.getElementsByName(makeId(section.name, idx));
      let valor = "";

      radios.forEach(r => r.checked && (valor = r.value));

      const fila = radios[0].closest("tr");
      const observacion = fila.querySelector(".obs-input").value;

      payload.items.push({
        categoria: section.name,
        item,
        resultado: valor,
        observacion
      });
    });
  });

  fetch("https://script.google.com/macros/s/AKfycby9YVrSoK38cY8z8zOB-dnzrFdgbsQwWbAIQnMtyQS1TH-7PQ7CLEbV63GKK633Gl-_OQ/exec", {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(() => showNotification("Auditoría guardada en la base de datos"))
  .catch(() => showNotification("Error al guardar auditoría", "error"));
}

</script>

</body>
</html>